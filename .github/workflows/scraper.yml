name: Taiwan PK10 Data Scraper

# å®šæ—¶è§¦å‘æ•°æ®æŠ“å–
on:
  schedule:
    # æ¯5åˆ†é’Ÿè¿è¡Œä¸€æ¬¡ï¼ˆGitHub Actionsæœ€å°é—´éš”ï¼‰
    # æ³¨æ„ï¼šå®é™…æŠ“å–é—´éš”ç”±åº”ç”¨å†…éƒ¨æ§åˆ¶ï¼ˆ75ç§’ï¼‰
    - cron: '*/5 * * * *'
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      action:
        description: 'æŠ“å–åŠ¨ä½œ'
        required: true
        default: 'scrape'
        type: choice
        options:
          - scrape
          - health
          - status
      
      force:
        description: 'å¼ºåˆ¶æ‰§è¡Œï¼ˆå¿½ç•¥æ—¶é—´é™åˆ¶ï¼‰'
        required: false
        default: false
        type: boolean

# ç¯å¢ƒå˜é‡
env:
  VERCEL_APP_URL: ${{ secrets.VERCEL_APP_URL }}  # åœ¨GitHub Secretsä¸­è®¾ç½®
  TIMEZONE: 'Asia/Taipei'

jobs:
  # æ•°æ®æŠ“å–ä»»åŠ¡
  scrape-data:
    runs-on: ubuntu-latest
    
    # åªåœ¨å°æ¹¾æ—¶é—´7:00-24:00ä¹‹é—´è¿è¡Œ
    if: |
      github.event_name == 'workflow_dispatch' || 
      (github.event_name == 'schedule' && 
       (github.event.schedule == '*/5 * * * *' && 
        contains('7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23', format('{0}', (github.event.repository.pushed_at | strftime: '%H' | plus: 8) % 24))))
    
    steps:
      - name: è®¾ç½®æ—¶åŒº
        run: |
          sudo timedatectl set-timezone Asia/Taipei
          echo "å½“å‰æ—¶é—´: $(date)"
      
      - name: æ£€æŸ¥åº”ç”¨çŠ¶æ€
        id: health-check
        run: |
          echo "æ£€æŸ¥åº”ç”¨å¥åº·çŠ¶æ€..."
          
          # æ£€æŸ¥ç¯å¢ƒå˜é‡
          if [ -z "$VERCEL_APP_URL" ]; then
            echo "âŒ VERCEL_APP_URL æœªè®¾ç½®"
            echo "è¯·åœ¨GitHubä»“åº“çš„Settings > Secretsä¸­æ·»åŠ VERCEL_APP_URL"
            exit 1
          fi
          
          # å¥åº·æ£€æŸ¥
          health_response=$(curl -s -w "%{http_code}" -o /tmp/health.json "$VERCEL_APP_URL/scheduler?action=health" || echo "000")
          
          if [ "$health_response" = "200" ]; then
            echo "âœ… åº”ç”¨å¥åº·æ£€æŸ¥é€šè¿‡"
            echo "health_status=ok" >> $GITHUB_OUTPUT
          else
            echo "âŒ åº”ç”¨å¥åº·æ£€æŸ¥å¤±è´¥ (HTTP: $health_response)"
            echo "health_status=failed" >> $GITHUB_OUTPUT
            
            # æ˜¾ç¤ºé”™è¯¯è¯¦æƒ…
            if [ -f "/tmp/health.json" ]; then
              echo "é”™è¯¯è¯¦æƒ…:"
              cat /tmp/health.json
            fi
          fi
      
      - name: è§¦å‘æ•°æ®æŠ“å–
        if: steps.health-check.outputs.health_status == 'ok'
        run: |
          echo "è§¦å‘æ•°æ®æŠ“å–..."
          
          # è·å–åŠ¨ä½œå‚æ•°
          action="${{ github.event.inputs.action || 'scrape' }}"
          force="${{ github.event.inputs.force || 'false' }}"
          
          # æ„å»ºè¯·æ±‚URL
          url="$VERCEL_APP_URL/scheduler?action=$action"
          if [ "$force" = "true" ]; then
            url="$url&force=true"
          fi
          
          echo "è¯·æ±‚URL: $url"
          
          # å‘é€æŠ“å–è¯·æ±‚
          scrape_response=$(curl -s -w "%{http_code}" -o /tmp/scrape.json "$url" || echo "000")
          
          echo "å“åº”çŠ¶æ€ç : $scrape_response"
          
          if [ "$scrape_response" = "200" ]; then
            echo "âœ… æ•°æ®æŠ“å–è¯·æ±‚æˆåŠŸ"
            
            # æ˜¾ç¤ºå“åº”å†…å®¹
            if [ -f "/tmp/scrape.json" ]; then
              echo "å“åº”å†…å®¹:"
              cat /tmp/scrape.json | jq . 2>/dev/null || cat /tmp/scrape.json
            fi
          else
            echo "âŒ æ•°æ®æŠ“å–è¯·æ±‚å¤±è´¥ (HTTP: $scrape_response)"
            
            # æ˜¾ç¤ºé”™è¯¯è¯¦æƒ…
            if [ -f "/tmp/scrape.json" ]; then
              echo "é”™è¯¯è¯¦æƒ…:"
              cat /tmp/scrape.json
            fi
            
            exit 1
          fi
      
      - name: éªŒè¯æŠ“å–ç»“æœ
        if: steps.health-check.outputs.health_status == 'ok'
        run: |
          echo "éªŒè¯æŠ“å–ç»“æœ..."
          
          # ç­‰å¾…ä¸€æ®µæ—¶é—´è®©æ•°æ®å¤„ç†å®Œæˆ
          sleep 10
          
          # æ£€æŸ¥æœ€æ–°æ•°æ®
          latest_response=$(curl -s -w "%{http_code}" -o /tmp/latest.json "$VERCEL_APP_URL/latest-data" || echo "000")
          
          if [ "$latest_response" = "200" ]; then
            echo "âœ… æœ€æ–°æ•°æ®è·å–æˆåŠŸ"
            
            # æ˜¾ç¤ºæœ€æ–°æ•°æ®ä¿¡æ¯
            if [ -f "/tmp/latest.json" ]; then
              echo "æœ€æ–°æ•°æ®:"
              cat /tmp/latest.json | jq '.data[0] | {issue, time, numbers}' 2>/dev/null || echo "æ•°æ®æ ¼å¼è§£æå¤±è´¥"
            fi
          else
            echo "âš ï¸ æœ€æ–°æ•°æ®è·å–å¤±è´¥ (HTTP: $latest_response)"
          fi
          
          # æ£€æŸ¥ç»Ÿè®¡ä¿¡æ¯
          stats_response=$(curl -s -w "%{http_code}" -o /tmp/stats.json "$VERCEL_APP_URL/stats" || echo "000")
          
          if [ "$stats_response" = "200" ]; then
            echo "âœ… ç»Ÿè®¡ä¿¡æ¯è·å–æˆåŠŸ"
            
            # æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
            if [ -f "/tmp/stats.json" ]; then
              echo "ç»Ÿè®¡ä¿¡æ¯:"
              cat /tmp/stats.json | jq '{total_records, collections_count, latest_issue}' 2>/dev/null || echo "ç»Ÿè®¡ä¿¡æ¯è§£æå¤±è´¥"
            fi
          else
            echo "âš ï¸ ç»Ÿè®¡ä¿¡æ¯è·å–å¤±è´¥ (HTTP: $stats_response)"
          fi
      
      - name: å‘é€é€šçŸ¥ï¼ˆå¤±è´¥æ—¶ï¼‰
        if: failure()
        run: |
          echo "ğŸš¨ æ•°æ®æŠ“å–ä»»åŠ¡å¤±è´¥"
          echo "æ—¶é—´: $(date)"
          echo "ä»“åº“: ${{ github.repository }}"
          echo "å·¥ä½œæµ: ${{ github.workflow }}"
          echo "è¿è¡ŒID: ${{ github.run_id }}"
          
          # è¿™é‡Œå¯ä»¥æ·»åŠ å…¶ä»–é€šçŸ¥æ–¹å¼ï¼Œå¦‚:
          # - å‘é€é‚®ä»¶
          # - å‘é€Slackæ¶ˆæ¯
          # - å‘é€å¾®ä¿¡é€šçŸ¥
          # - è°ƒç”¨Webhook

  # æ¯æ—¥ç»Ÿè®¡ä»»åŠ¡
  daily-stats:
    runs-on: ubuntu-latest
    
    # æ¯å¤©å°æ¹¾æ—¶é—´23:55è¿è¡Œ
    if: github.event.schedule == '55 15 * * *'  # UTCæ—¶é—´15:55 = å°æ¹¾æ—¶é—´23:55
    
    steps:
      - name: ç”Ÿæˆæ¯æ—¥ç»Ÿè®¡æŠ¥å‘Š
        run: |
          echo "ç”Ÿæˆæ¯æ—¥ç»Ÿè®¡æŠ¥å‘Š..."
          
          if [ -z "$VERCEL_APP_URL" ]; then
            echo "âŒ VERCEL_APP_URL æœªè®¾ç½®"
            exit 1
          fi
          
          # è·å–ç»Ÿè®¡ä¿¡æ¯
          stats_response=$(curl -s -w "%{http_code}" -o /tmp/daily_stats.json "$VERCEL_APP_URL/stats" || echo "000")
          
          if [ "$stats_response" = "200" ]; then
            echo "ğŸ“Š æ¯æ—¥ç»Ÿè®¡æŠ¥å‘Š - $(date '+%Y-%m-%d')"
            echo "================================"
            
            if [ -f "/tmp/daily_stats.json" ]; then
              cat /tmp/daily_stats.json | jq .
            fi
            
            echo "================================"
            echo "æŠ¥å‘Šç”Ÿæˆæ—¶é—´: $(date)"
          else
            echo "âŒ ç»Ÿè®¡ä¿¡æ¯è·å–å¤±è´¥"
          fi

  # å¥åº·æ£€æŸ¥ä»»åŠ¡
  health-monitor:
    runs-on: ubuntu-latest
    
    # æ¯å°æ—¶è¿è¡Œä¸€æ¬¡å¥åº·æ£€æŸ¥
    if: github.event.schedule == '0 * * * *'
    
    steps:
      - name: ç³»ç»Ÿå¥åº·æ£€æŸ¥
        run: |
          echo "æ‰§è¡Œç³»ç»Ÿå¥åº·æ£€æŸ¥..."
          
          if [ -z "$VERCEL_APP_URL" ]; then
            echo "âŒ VERCEL_APP_URL æœªè®¾ç½®"
            exit 1
          fi
          
          # æ£€æŸ¥å„ä¸ªç«¯ç‚¹
          endpoints=(
            "/health"
            "/latest-data"
            "/stats"
            "/scheduler?action=health"
          )
          
          failed_count=0
          total_count=${#endpoints[@]}
          
          echo "æ£€æŸ¥ $total_count ä¸ªç«¯ç‚¹..."
          
          for endpoint in "${endpoints[@]}"; do
            url="$VERCEL_APP_URL$endpoint"
            response=$(curl -s -w "%{http_code}" -o /dev/null "$url" || echo "000")
            
            if [ "$response" = "200" ]; then
              echo "âœ… $endpoint - OK"
            else
              echo "âŒ $endpoint - FAILED (HTTP: $response)"
              failed_count=$((failed_count + 1))
            fi
          done
          
          success_count=$((total_count - failed_count))
          echo "å¥åº·æ£€æŸ¥å®Œæˆ: $success_count/$total_count é€šè¿‡"
          
          if [ $failed_count -gt 0 ]; then
            echo "ğŸš¨ å‘ç° $failed_count ä¸ªç«¯ç‚¹å¼‚å¸¸"
            exit 1
          else
            echo "âœ… æ‰€æœ‰ç«¯ç‚¹æ­£å¸¸"
          fi