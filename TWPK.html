<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å°æ¹¾PKäº”æ˜Ÿåšå·æ¨¡å—</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    :root {
      --primary: #3b82f6;
      --primary-dark: #1d4ed8;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --gray-50: #f9fafb;
      --gray-100: #f3f4f6;
      --gray-200: #e5e7eb;
      --gray-300: #d1d5db;
      --gray-400: #9ca3af;
      --gray-500: #6b7280;
      --gray-600: #4b5563;
      --gray-700: #374151;
      --gray-800: #1f2937;
      --gray-900: #111827;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, var(--gray-50) 0%, var(--gray-100) 100%);
      min-height: 100vh;
      color: var(--gray-800);
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .header {
      text-align: center;
      margin-bottom: 30px;
      padding: 20px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .header h1 {
      color: var(--primary);
      font-size: 2.5rem;
      margin-bottom: 10px;
      font-weight: 700;
    }
    
    .header p {
      color: var(--gray-600);
      font-size: 1.1rem;
    }
    
    .controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .control-group {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .control-group h3 {
      color: var(--gray-700);
      margin-bottom: 15px;
      font-size: 1.2rem;
      font-weight: 600;
    }
    
    .button-group {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 15px;
    }
    
    .button-group button {
      padding: 8px 16px;
      border: 2px solid var(--gray-200);
      background: white;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-weight: 500;
      color: var(--gray-700);
    }
    
    .button-group button:hover {
      border-color: var(--primary);
      color: var(--primary);
      transform: translateY(-1px);
    }
    
    .button-group button.btn-active {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }
    
    .input-section {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    
    .input-section h3 {
      color: var(--gray-700);
      margin-bottom: 15px;
      font-size: 1.2rem;
      font-weight: 600;
    }
    
    textarea {
      width: 100%;
      min-height: 120px;
      padding: 15px;
      border: 2px solid var(--gray-200);
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      resize: vertical;
      transition: border-color 0.2s ease;
    }
    
    textarea:focus {
      outline: none;
      border-color: var(--primary);
    }
    
    .action-buttons {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }
    
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    .btn-primary {
      background: var(--primary);
      color: white;
    }
    
    .btn-primary:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
    }
    
    .btn-success {
      background: var(--success);
      color: white;
    }
    
    .btn-success:hover {
      background: #059669;
      transform: translateY(-1px);
    }
    
    .btn-warning {
      background: var(--warning);
      color: white;
    }
    
    .btn-warning:hover {
      background: #d97706;
      transform: translateY(-1px);
    }
    
    .output {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    
    .output h3 {
      color: var(--gray-700);
      margin-bottom: 15px;
      font-size: 1.2rem;
      font-weight: 600;
    }
    
    #output {
      font-family: 'Courier New', monospace;
      background: var(--gray-50);
      padding: 15px;
      border-radius: 8px;
      border: 1px solid var(--gray-200);
      min-height: 100px;
      white-space: pre-wrap;
      color: var(--gray-700);
    }
    
    .table-container {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    
    .table-header {
      background: var(--primary);
      color: white;
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
    }
    
    .table-header h3 {
      margin: 0;
      font-size: 1.3rem;
      font-weight: 600;
    }
    
    .table-controls {
      display: flex;
      gap: 15px;
      align-items: center;
      flex-wrap: wrap;
    }
    
    .table-controls label {
      color: white;
      font-weight: 500;
    }
    
    .table-controls select {
      padding: 8px 12px;
      border: none;
      border-radius: 6px;
      background: white;
      color: var(--gray-700);
      font-weight: 500;
    }
    
    .table-wrapper {
      overflow-x: auto;
      max-height: 600px;
      overflow-y: auto;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    
    th, td {
      padding: 12px 8px;
      text-align: center;
      border-bottom: 1px solid var(--gray-200);
    }
    
    th {
      background: var(--gray-50);
      font-weight: 600;
      color: var(--gray-700);
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    tr:hover {
      background: var(--gray-50);
    }
    
    .hit-0 { background-color: #fee2e2; color: #991b1b; }
    .hit-1 { background-color: #fef3c7; color: #92400e; }
    .hit-2 { background-color: #d1fae5; color: #065f46; }
    .hit-3 { background-color: #dbeafe; color: #1e40af; }
    .hit-4 { background-color: #e0e7ff; color: #3730a3; }
    .hit-5 { background-color: #f3e8ff; color: #581c87; }
    
    .file-input-wrapper {
      position: relative;
      display: inline-block;
      overflow: hidden;
      background: var(--success);
      color: white;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s ease;
    }
    
    .file-input-wrapper:hover {
      background: #059669;
      transform: translateY(-1px);
    }
    
    .file-input-wrapper input[type=file] {
      position: absolute;
      left: -9999px;
    }
    
    .status-info {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    .status-card {
      background: white;
      padding: 15px 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      flex: 1;
      min-width: 150px;
    }
    
    .status-card h4 {
      color: var(--gray-600);
      font-size: 0.9rem;
      margin-bottom: 5px;
      font-weight: 500;
    }
    
    .status-card .value {
      color: var(--primary);
      font-size: 1.5rem;
      font-weight: 700;
    }
    
    .theme-toggle {
      position: fixed;
      top: 20px;
      right: 20px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      cursor: pointer;
      font-size: 20px;
      transition: all 0.2s ease;
      z-index: 1000;
    }
    
    .theme-toggle:hover {
      background: var(--primary-dark);
      transform: scale(1.1);
    }
    
    .help-btn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--warning);
      color: white;
      border: none;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      cursor: pointer;
      font-size: 20px;
      transition: all 0.2s ease;
      z-index: 1000;
    }
    
    .help-btn:hover {
      background: #d97706;
      transform: scale(1.1);
    }
    
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }
    
    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 12px;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
      margin: 20px;
    }
    
    .modal-content h3 {
      color: var(--primary);
      margin-bottom: 20px;
      font-size: 1.5rem;
    }
    
    .modal-content p {
      margin-bottom: 15px;
      line-height: 1.6;
      color: var(--gray-700);
    }
    
    .modal-content ul {
      margin-left: 20px;
      margin-bottom: 15px;
    }
    
    .modal-content li {
      margin-bottom: 8px;
      color: var(--gray-700);
    }
    
    .close-btn {
      float: right;
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--gray-500);
      margin-top: -10px;
    }
    
    .close-btn:hover {
      color: var(--gray-700);
    }
    
    .hidden {
      display: none !important;
    }
    
    @media (max-width: 768px) {
      .container {
        padding: 10px;
      }
      
      .header h1 {
        font-size: 2rem;
      }
      
      .controls {
        grid-template-columns: 1fr;
      }
      
      .action-buttons {
        flex-direction: column;
      }
      
      .btn {
        width: 100%;
        justify-content: center;
      }
      
      .table-header {
        flex-direction: column;
        align-items: stretch;
      }
      
      .table-controls {
        justify-content: center;
      }
      
      .status-info {
        flex-direction: column;
      }
    }
    
    /* æ·±è‰²ä¸»é¢˜ */
    .dark-theme {
      --gray-50: #1f2937;
      --gray-100: #374151;
      --gray-200: #4b5563;
      --gray-300: #6b7280;
      --gray-400: #9ca3af;
      --gray-500: #d1d5db;
      --gray-600: #e5e7eb;
      --gray-700: #f3f4f6;
      --gray-800: #f9fafb;
      --gray-900: #ffffff;
    }
    
    .dark-theme body {
      background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
      color: var(--gray-800);
    }
  </style>
</head>
<body>
  <button class="theme-toggle" onclick="toggleTheme()" title="åˆ‡æ¢ä¸»é¢˜">ğŸŒ™</button>
  <button class="help-btn" onclick="showHelp()" title="å¸®åŠ©">â“</button>
  
  <!-- å¯†é’¥å€’è®¡æ—¶é€šçŸ¥æ  -->
  <div id="keyCountdown" class="fixed top-0 left-0 right-0 bg-primary text-white text-center py-2 z-40 hidden">
    <span>å¯†é’¥æœ‰æ•ˆæœŸå‰©ä½™: <strong id="timeRemaining">0å¤© 0å°æ—¶ 0åˆ†é’Ÿ 0ç§’</strong></span>
  </div>

  <div class="container">
    <div class="header">
      <h1>ğŸ¯ å°æ¹¾PKäº”æ˜Ÿåšå·æ¨¡å—</h1>
      <p>æ™ºèƒ½åˆ†æå†å²æ•°æ®ï¼Œç²¾å‡†é¢„æµ‹ä¸­å¥–å·ç </p>
    </div>
    
    <div class="status-info">
      <div class="status-card">
        <h4>å·²å½•å…¥æœŸæ•°</h4>
        <div class="value" id="periodCount">0</div>
      </div>
      <div class="status-card">
        <h4>å½“å‰æœŸæ•°</h4>
        <div class="value" id="currentPeriod">-</div>
      </div>
      <div class="status-card">
        <h4>è‡ªåŠ¨è·å–</h4>
        <div class="value" id="autoStatus">å…³é—­</div>
      </div>
    </div>
    
    <div class="controls">
      <div class="control-group">
        <h3>ğŸ² èƒ†ç æ•°é‡é€‰æ‹©</h3>
        <div class="button-group" id="numButtons"></div>
      </div>
      
      <div class="control-group">
        <h3>ğŸ¯ ä¸­å‡ºç­›é€‰</h3>
        <div class="button-group" id="hitButtons"></div>
      </div>
    </div>
    
    <div class="input-section">
      <h3>ğŸ“ æ•°æ®å½•å…¥</h3>
      <textarea id="numbersInput" placeholder="è¯·è¾“å…¥å†å²å¼€å¥–æ•°æ®ï¼Œæ ¼å¼ï¼šæœŸæ•° å·ç 1 å·ç 2 ... å·ç 10\nä¾‹å¦‚ï¼š\n20240101 01 02 03 04 05 06 07 08 09 10\n20240102 02 03 04 05 06 07 08 09 10 11"></textarea>
      
      <div class="action-buttons">
        <button class="btn btn-primary" onclick="manualCalc()">ğŸ“Š æ‰‹åŠ¨è®¡ç®—</button>
        <button class="btn btn-success" onclick="startAutoFetch()">ğŸ”„ å¼€å§‹è‡ªåŠ¨è·å–</button>
        <button class="btn btn-warning" onclick="stopAutoFetch()">â¹ï¸ åœæ­¢è‡ªåŠ¨è·å–</button>
        <div class="file-input-wrapper">
          ğŸ“ é€‰æ‹©æ–‡ä»¶
          <input type="file" id="fileInput" accept=".txt,.csv" onchange="handleFileSelect(event)">
        </div>
        <button class="btn btn-warning" onclick="clearData()">ğŸ—‘ï¸ æ¸…ç©ºæ•°æ®</button>
      </div>
    </div>
    
    <div class="output">
      <h3>ğŸ“‹ æ“ä½œç»“æœ</h3>
      <div id="output">ç­‰å¾…æ•°æ®è¾“å…¥...</div>
    </div>
    
    <div class="table-container" id="tableContainer">
      <div class="table-header">
        <h3>ğŸ“ˆ åˆ†æç»“æœ</h3>
        <div class="table-controls">
          <label for="periodSelect">æ˜¾ç¤ºæœŸæ•°:</label>
          <select id="periodSelect" onchange="updateDisplayPeriods()">
            <option value="10">æœ€è¿‘10æœŸ</option>
            <option value="20">æœ€è¿‘20æœŸ</option>
            <option value="30" selected>æœ€è¿‘30æœŸ</option>
            <option value="50">æœ€è¿‘50æœŸ</option>
            <option value="100">æœ€è¿‘100æœŸ</option>
            <option value="all">å…¨éƒ¨</option>
          </select>
          
          <label for="sortSelect">æ’åºæ–¹å¼:</label>
          <select id="sortSelect" onchange="updateSortMethod()">
            <option value="hit" selected>æŒ‰è¿ä¸­æ¬¡æ•°</option>
            <option value="miss">æŒ‰é—æ¼æ¬¡æ•°</option>
          </select>
        </div>
      </div>
      <div class="table-wrapper">
        <table id="resultTable">
          <thead>
            <tr>
              <th>å·ç </th>
              <th>è¿ä¸­æ¬¡æ•°</th>
              <th>é—æ¼æ¬¡æ•°</th>
              <th>å‡ºç°é¢‘ç‡</th>
              <th>æ¨èæŒ‡æ•°</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
  
  <!-- å¸®åŠ©æ¨¡æ€æ¡† -->
  <div id="helpModal" class="modal hidden">
    <div class="modal-content">
      <button class="close-btn" onclick="hideHelp()">&times;</button>
      <h3>ğŸ“– ä½¿ç”¨è¯´æ˜</h3>
      
      <p><strong>ğŸ¯ åŠŸèƒ½ä»‹ç»ï¼š</strong></p>
      <p>å°æ¹¾PKäº”æ˜Ÿåšå·æ¨¡å—æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å½©ç¥¨åˆ†æå·¥å…·ï¼Œé€šè¿‡åˆ†æå†å²å¼€å¥–æ•°æ®ï¼Œä¸ºæ‚¨æä¾›ç§‘å­¦çš„å·ç æ¨èã€‚</p>
      
      <p><strong>ğŸ“ æ•°æ®å½•å…¥æ–¹å¼ï¼š</strong></p>
      <ul>
        <li><strong>æ‰‹åŠ¨å½•å…¥ï¼š</strong>åœ¨æ–‡æœ¬æ¡†ä¸­è¾“å…¥å†å²å¼€å¥–æ•°æ®</li>
        <li><strong>æ–‡ä»¶å¯¼å…¥ï¼š</strong>æ”¯æŒå¯¼å…¥.txtæˆ–.csvæ ¼å¼çš„æ•°æ®æ–‡ä»¶</li>
        <li><strong>è‡ªåŠ¨è·å–ï¼š</strong>è‡ªåŠ¨ä»æ•°æ®æºè·å–æœ€æ–°å¼€å¥–ä¿¡æ¯</li>
      </ul>
      
      <p><strong>ğŸ“Š åˆ†æåŠŸèƒ½ï¼š</strong></p>
      <ul>
        <li><strong>èƒ†ç åˆ†æï¼š</strong>é€‰æ‹©1-10ä¸ªèƒ†ç è¿›è¡Œé‡ç‚¹åˆ†æ</li>
        <li><strong>ä¸­å‡ºç­›é€‰ï¼š</strong>æ ¹æ®å†å²ä¸­å¥–æƒ…å†µç­›é€‰å·ç </li>
        <li><strong>é¢‘ç‡ç»Ÿè®¡ï¼š</strong>ç»Ÿè®¡å„å·ç çš„å‡ºç°é¢‘ç‡å’Œé—æ¼æƒ…å†µ</li>
        <li><strong>æ™ºèƒ½æ¨èï¼š</strong>åŸºäºå¤šç»´åº¦åˆ†æç»™å‡ºæ¨èæŒ‡æ•°</li>
      </ul>
      
      <p><strong>ğŸ¨ ç•Œé¢åŠŸèƒ½ï¼š</strong></p>
      <ul>
        <li><strong>ä¸»é¢˜åˆ‡æ¢ï¼š</strong>æ”¯æŒæ˜æš—ä¸¤ç§ä¸»é¢˜æ¨¡å¼</li>
        <li><strong>æ•°æ®ç­›é€‰ï¼š</strong>å¯é€‰æ‹©æ˜¾ç¤ºä¸åŒæœŸæ•°çš„åˆ†æç»“æœ</li>
        <li><strong>æ’åºåŠŸèƒ½ï¼š</strong>æ”¯æŒæŒ‰è¿ä¸­æ¬¡æ•°æˆ–é—æ¼æ¬¡æ•°æ’åº</li>
      </ul>
      
      <p><strong>âš ï¸ é‡è¦æç¤ºï¼š</strong></p>
      <p>æœ¬å·¥å…·ä»…ä¾›å¨±ä¹å’Œå­¦ä¹ ä½¿ç”¨ï¼Œä¸æ„æˆä»»ä½•æŠ•èµ„å»ºè®®ã€‚å½©ç¥¨å…·æœ‰éšæœºæ€§ï¼Œè¯·ç†æ€§å‚ä¸ï¼Œé‡åŠ›è€Œè¡Œã€‚</p>
    </div>
  </div>
  
  <!-- å¯†é’¥éªŒè¯æ¨¡æ€æ¡† -->
  <div id="keyModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
      <div class="text-center mb-6">
        <h3 class="text-2xl font-bold text-gray-800 mb-2">è¯·è¾“å…¥è®¿é—®å¯†é’¥</h3>
        <p class="text-gray-600">è¯¥åŠŸèƒ½éœ€è¦æœ‰æ•ˆçš„è®¿é—®å¯†é’¥æ‰èƒ½ä½¿ç”¨</p>
        <p class="text-sm text-gray-500 mt-2">è¯·è”ç³»ç®¡ç†å‘˜è·å–æœ‰æ•ˆå¯†é’¥</p>
      </div>
      
      <div class="mb-4">
        <input type="text" id="keyInput" placeholder="è¯·è¾“å…¥32ä½è®¿é—®å¯†é’¥" class="w-full px-4 py-3 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all duration-200">
      </div>
      
      <div class="flex gap-3">
        <button id="verifyKeyBtn" class="w-full px-4 py-3 bg-primary text-white rounded-md font-medium hover:bg-primary/80 transition-colors">éªŒè¯å¯†é’¥</button>
        <!-- ç§»é™¤å–æ¶ˆæŒ‰é’® -->
      </div>
    </div>
  </div>

  <script>
    // å…¨å±€å˜é‡
    let history = [];
    let period = 1;
    let autoFetchTimer = null;
    let fileHandle = null;
    let seenPeriods = new Set();
    let latestCheckedPeriod = null;
    let fileReaderTimer = null;
    let sortByHit = true; // true=æŒ‰è¿ä¸­æ¬¡æ•°æ’åº, false=æŒ‰é—æ¼æ¬¡æ•°æ’åº
    let displayPeriods = 30; // é»˜è®¤æ˜¾ç¤º30æœŸæ•°æ®

// å¯†é’¥éªŒè¯ç›¸å…³å˜é‡
let isKeyValid = false;
const KEY_STORAGE_KEY = 'pk4_access_key';
const KEY_MODAL = document.getElementById('keyModal');
const KEY_INPUT = document.getElementById('keyInput');

// DOMå…ƒç´ 
    const outputEl = document.getElementById('output');
    const tableContainer = document.getElementById('tableContainer');
    const horizontalThumb = document.getElementById('horizontalThumb');
    const horizontalFill = document.getElementById('horizontalFill');
    const verticalSlider = document.getElementById('verticalSlider');
    const verticalThumb = document.getElementById('verticalThumb');
    const verticalFill = document.getElementById('verticalFill');
    
    // åˆå§‹åŒ–èƒ†ç æ•°æŒ‰é’®
    const numButtons = document.getElementById('numButtons');
    for(let i=1; i<=10; i++){
      const b = document.createElement('button');
      b.className = 'px-3 py-1 rounded-md bg-gray-200 btn-hover';
      b.dataset.num = i;
      b.textContent = i;
      numButtons.appendChild(b);
    }
    
    // åˆå§‹åŒ–ä¸­å‡ºæŒ‰é’®
    const hitButtons = document.getElementById('hitButtons');
    [0, 1, 2, 3, 4, 5].forEach(h => {
      const b = document.createElement('button');
      b.className = 'px-3 py-1 rounded-md bg-gray-200 btn-hover';
      b.dataset.hit = h;
      b.textContent = h + 'èƒ†';
      hitButtons.appendChild(b);
    });
    
    // å•é€‰æŒ‰é’®ç»„
    function singleSelect(btns) {
      btns.forEach(b => b.addEventListener('click', () => {
        btns.forEach(x => x.classList.remove('btn-active'));
        b.classList.add('btn-active');
        renderTable();
      }));
    }
    
    // å¤šé€‰æŒ‰é’®ç»„
    function multiToggle(btns) {
      btns.forEach(b => b.addEventListener('click', () => {
        b.classList.toggle('btn-active');
        renderTable();
      }));
    }
    
    // è®¾ç½®é»˜è®¤é€‰ä¸­ - èƒ†ç æ•°é»˜è®¤æ”¹ä¸º5
    document.querySelector('#numButtons button[data-num="5"]').classList.add('btn-active');
    document.querySelector('#hitButtons button[data-hit="2"]').classList.add('btn-active');
    
    // åˆå§‹åŒ–æŒ‰é’®äº‹ä»¶
singleSelect(Array.from(numButtons.children));
multiToggle(Array.from(hitButtons.children));

// å¯†é’¥å€’è®¡æ—¶æ›´æ–°å‡½æ•°
let countdownInterval = null;

function updateKeyCountdown(expirationTimestamp) {
    const countdownEl = document.getElementById('keyCountdown');
    const timeEl = document.getElementById('timeRemaining');
    
    // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
    if (countdownInterval) {
        clearInterval(countdownInterval);
    }
    
    function updateDisplay() {
        const now = new Date();
        const expirationDate = new Date(expirationTimestamp * 1000);
        const timeDiff = expirationDate - now;
        
        if (timeDiff <= 0) {
            // å¯†é’¥å·²è¿‡æœŸ
            timeEl.textContent = 'å·²è¿‡æœŸ';
            countdownEl.classList.remove('bg-primary', 'bg-amber-500');
            countdownEl.classList.add('bg-red-500');
            clearInterval(countdownInterval);
            
            // æ¸…é™¤æœ¬åœ°å­˜å‚¨çš„å¯†é’¥ä¿¡æ¯
            const fileId = generateFileIdentifier();
            localStorage.removeItem(`validKey_${fileId}`);
            localStorage.removeItem(`keyExpiry_${fileId}`);
            isKeyValid = false;
            
            // 3ç§’åè‡ªåŠ¨åˆ·æ–°é¡µé¢
            setTimeout(() => {
                window.location.reload();
            }, 3000);
            
            return;
        }
        
        // è®¡ç®—å‰©ä½™æ—¶é—´
        const days = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
        const hours = Math.floor((timeDiff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((timeDiff % (1000 * 60)) / 1000);
        
        // æ›´æ–°æ˜¾ç¤º
        timeEl.textContent = `${days}å¤© ${hours}å°æ—¶ ${minutes}åˆ†é’Ÿ ${seconds}ç§’`;
        
        // è®¾ç½®æ ·å¼ï¼ˆæ ¹æ®å‰©ä½™æ—¶é—´æ”¹å˜èƒŒæ™¯è‰²ï¼‰
        const totalHours = days * 24 + hours;
        if (totalHours <= 24) {
            countdownEl.classList.remove('bg-primary', 'bg-amber-500');
            countdownEl.classList.add('bg-red-500');
        } else if (totalHours <= 72) {
            countdownEl.classList.remove('bg-primary', 'bg-red-500');
            countdownEl.classList.add('bg-amber-500');
        } else {
            countdownEl.classList.remove('bg-amber-500', 'bg-red-500');
            countdownEl.classList.add('bg-primary');
        }
    }
    
    // ç«‹å³æ›´æ–°ä¸€æ¬¡
    updateDisplay();
    countdownEl.classList.remove('hidden');
    
    // æ¯ç§’æ›´æ–°ä¸€æ¬¡
    countdownInterval = setInterval(updateDisplay, 1000);
}

// æ·»åŠ è®¾å¤‡æŒ‡çº¹ç”Ÿæˆå‡½æ•°ï¼ˆä»å¯†é’¥ç”Ÿæˆå™¨å¤åˆ¶ï¼‰
function generateDeviceFingerprint() {
    const userAgent = navigator.userAgent;
    const screenResolution = screen.width + 'x' + screen.height;
    const timezoneOffset = new Date().getTimezoneOffset();
    const language = navigator.language;
    
    const fingerprintRaw = userAgent + screenResolution + timezoneOffset + language;
    let hash = 0;
    for (let i = 0; i < fingerprintRaw.length; i++) {
        const char = fingerprintRaw.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash; // è½¬æ¢ä¸º32ä½æ•´æ•°
    }
    return Math.abs(hash).toString(36);
}

/*
è·¨å¹³å°å¯†é’¥ä¸€æ¬¡æ€§éªŒè¯å®ç°è¯´æ˜ï¼š

å½“å‰å®ç°ï¼š
- ä½¿ç”¨localStorageä½œä¸ºæœ¬åœ°å­˜å‚¨ï¼Œç¡®ä¿åœ¨åŒä¸€æµè§ˆå™¨ä¸­å¯†é’¥åªèƒ½ä½¿ç”¨ä¸€æ¬¡
- åŒ…å«äº‘ç«¯APIè°ƒç”¨æ¡†æ¶ï¼Œä½†ç›®å‰ä½¿ç”¨httpbin.orgä½œä¸ºæ¼”ç¤º

çœŸæ­£çš„è·¨å¹³å°å®ç°éœ€è¦ï¼š
1. éƒ¨ç½²ä¸“é—¨çš„åç«¯æœåŠ¡ï¼ˆå¦‚Node.js + MongoDB/Redisï¼‰
2. åˆ›å»ºAPIç«¯ç‚¹ï¼š
   - GET /api/nonce/check/{nonce} - æ£€æŸ¥nonceæ˜¯å¦å·²ä½¿ç”¨
   - POST /api/nonce/mark - æ ‡è®°nonceä¸ºå·²ä½¿ç”¨
3. åœ¨åç«¯ç»´æŠ¤å…¨å±€çš„å·²ä½¿ç”¨nonceæ•°æ®åº“
4. å¯é€‰ï¼šæ·»åŠ nonceè¿‡æœŸæ¸…ç†æœºåˆ¶

éƒ¨ç½²å»ºè®®ï¼š
- ä½¿ç”¨å…è´¹çš„äº‘æœåŠ¡å¦‚Vercelã€Netlify Functionsã€Railwayç­‰
- æ•°æ®åº“å¯ä½¿ç”¨MongoDB Atlasã€Redis Cloudç­‰å…è´¹æ–¹æ¡ˆ
- ç¡®ä¿APIå…·æœ‰é€‚å½“çš„é€Ÿç‡é™åˆ¶å’Œå®‰å…¨æªæ–½
*/

// è·¨å¹³å°nonceéªŒè¯APIå‡½æ•°
async function checkNonceUsed(nonce) {
    try {
        // é¦–å…ˆæ£€æŸ¥æœ¬åœ°è®°å½•
        const localNonces = JSON.parse(localStorage.getItem('usedNonces') || '[]');
        if (localNonces.includes(nonce)) {
            return { used: true, source: 'local' };
        }
        
        // æ£€æŸ¥äº‘ç«¯è®°å½•ï¼ˆæ¼”ç¤ºç”¨httpbin.orgï¼Œå®é™…åº”æ›¿æ¢ä¸ºçœŸå®APIï¼‰
        const response = await fetch(`https://httpbin.org/get?nonce=${nonce}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            // è¿™é‡Œåº”è¯¥æ ¹æ®å®é™…APIè¿”å›æ ¼å¼åˆ¤æ–­nonceæ˜¯å¦å·²ä½¿ç”¨
            // ç›®å‰ä½¿ç”¨httpbin.orgä½œä¸ºæ¼”ç¤ºï¼Œæ€»æ˜¯è¿”å›æœªä½¿ç”¨
            console.log('äº‘ç«¯nonceæ£€æŸ¥ç»“æœ:', data);
            return { used: false, source: 'cloud' };
        } else {
            console.warn('äº‘ç«¯nonceæ£€æŸ¥å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°è®°å½•');
            return { used: false, source: 'local_fallback' };
        }
    } catch (error) {
        console.warn('äº‘ç«¯nonceæ£€æŸ¥å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°è®°å½•:', error);
        return { used: false, source: 'local_fallback' };
    }
}

// æ ‡è®°nonceä¸ºå·²ä½¿ç”¨
async function markNonceAsUsed(nonce) {
    try {
        // å°è¯•åœ¨äº‘ç«¯è®°å½•ï¼ˆæ¼”ç¤ºç”¨httpbin.orgï¼Œå®é™…åº”æ›¿æ¢ä¸ºçœŸå®APIï¼‰
        const response = await fetch('https://httpbin.org/post', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ nonce: nonce, action: 'mark_used' })
        });
        
        if (response.ok) {
            const data = await response.json();
            console.log('äº‘ç«¯nonceè®°å½•æˆåŠŸ:', data);
            return { success: true };
        } else {
            console.warn('äº‘ç«¯è®°å½•å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°è®°å½•');
        }
    } catch (error) {
        console.warn('äº‘ç«¯è®°å½•å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°è®°å½•:', error);
    }
    
    // äº‘ç«¯è®°å½•å¤±è´¥æ—¶ï¼Œä½¿ç”¨æœ¬åœ°è®°å½•ä½œä¸ºå¤‡ä»½
    const localNonces = JSON.parse(localStorage.getItem('usedNonces') || '[]');
    if (!localNonces.includes(nonce)) {
        localNonces.push(nonce);
        localStorage.setItem('usedNonces', JSON.stringify(localNonces));
        console.log('æœ¬åœ°è®°å½•nonce:', nonce);
    }
    return { success: true };
}

// å¯†é’¥éªŒè¯æŒ‰é’®äº‹ä»¶
const verifyKeyBtn = document.getElementById('verifyKeyBtn');
verifyKeyBtn.addEventListener('click', async function() {
    const key = KEY_INPUT.value.trim();
    if (!key) {
        alert('è¯·è¾“å…¥å¯†é’¥');
        return;
    }
    
    // æ˜¾ç¤ºéªŒè¯ä¸­çŠ¶æ€
    this.disabled = true;
    this.textContent = 'éªŒè¯ä¸­...';
    
    try {
        const result = await verifyKey(key);
        if (result.valid) {
            // è®°å½•å·²ä½¿ç”¨çš„nonceåˆ°äº‘ç«¯
            await markNonceAsUsed(result.data.nonce);
            
            // ä½¿ç”¨æ–‡ä»¶å”¯ä¸€æ ‡è¯†å­˜å‚¨å¯†é’¥
            const fileId = generateFileIdentifier();
            localStorage.setItem(`validKey_${fileId}`, key);
            localStorage.setItem(`keyExpiry_${fileId}`, result.data.expiry);
            
            // ç¡®ä¿æ¨¡æ€æ¡†éšè—
            KEY_MODAL.classList.add('hidden');
            KEY_MODAL.style.display = 'none';
            
            // æ›´æ–°å¯†é’¥çŠ¶æ€å’Œå€’è®¡æ—¶
            isKeyValid = true;
            updateKeyCountdown(result.data.expiry);
        } else {
            alert('å¯†é’¥éªŒè¯å¤±è´¥: ' + result.reason);
        }
    } catch (e) {
        console.error('å¯†é’¥éªŒè¯è¿‡ç¨‹å‡ºé”™:', e);
        alert('éªŒè¯è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: ' + e.message);
    } finally {
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        this.disabled = false;
        this.textContent = 'éªŒè¯å¯†é’¥';
    }
});


// é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ä¿å­˜çš„å¯†é’¥
window.addEventListener('load', function() {
    try {
        const fileId = generateFileIdentifier();
        const validKey = localStorage.getItem(`validKey_${fileId}`);
        const keyExpiry = localStorage.getItem(`keyExpiry_${fileId}`);
        
        if (validKey && keyExpiry) {
            const currentTime = Math.floor(new Date().getTime() / 1000);
            const expiryTime = parseInt(keyExpiry);
            
            if (currentTime < expiryTime) {
                // å¯†é’¥æœ‰æ•ˆï¼Œç›´æ¥æ›´æ–°å€’è®¡æ—¶
                isKeyValid = true;
                updateKeyCountdown(expiryTime);
                KEY_MODAL.classList.add('hidden');
                KEY_MODAL.style.display = 'none';
            } else {
                // å¯†é’¥å·²è¿‡æœŸï¼Œæ¸…é™¤æœ¬åœ°å­˜å‚¨å¹¶æ˜¾ç¤ºè¿‡æœŸæç¤º
                localStorage.removeItem(`validKey_${fileId}`);
                localStorage.removeItem(`keyExpiry_${fileId}`);
                alert('æ‚¨çš„å¯†é’¥å·²è¿‡æœŸï¼Œè¯·é‡æ–°éªŒè¯æ–°çš„å¯†é’¥');
                KEY_MODAL.classList.remove('hidden');
                KEY_MODAL.style.display = 'flex';
            }
        } else {
            // å¯†é’¥ä¸å­˜åœ¨ï¼Œæ˜¾ç¤ºéªŒè¯æ¨¡æ€æ¡†
            KEY_MODAL.classList.remove('hidden');
            KEY_MODAL.style.display = 'flex';
        }
    } catch (e) {
        console.error('é¡µé¢åŠ è½½æ—¶å¯†é’¥æ£€æŸ¥å‡ºé”™:', e);
        KEY_MODAL.classList.remove('hidden');
        KEY_MODAL.style.display = 'flex';
    }
});

// è§£æè¾“å…¥æ•°æ®
function parseInput(line) {
      // å¤„ç†æ–‡ä»¶è¡Œæ•°æ®ï¼Œæ”¯æŒå¤šç§åˆ†éš”ç¬¦
      let parts;
      if (line.includes('\t')) {
        parts = line.trim().split(/\t+/);
      } else if (line.includes(' ')) {
        parts = line.trim().split(/\s+/);
      } else {
        return null;
      }
      
      if (parts.length < 2) return null;
      
      const period = parts[0].trim();
      
      // å°è¯•å¤šç§å¯èƒ½çš„æ•°å­—åˆ†éš”ç¬¦
      let nums;
      if (parts[1].includes(',')) {
        nums = parts[1].split(',').map(n => parseInt(n.trim(), 10));
      } else if (parts[1].includes(' ')) {
        nums = parts[1].split(' ').map(n => parseInt(n.trim(), 10));
      } else {
        return null;
      }
      
      if (nums.length !== 10 || nums.some(isNaN)) return null;
      
      return { period, data: nums };
    }

// å¯†é’¥éªŒè¯å‡½æ•°
async function verifyKey(key) {
    try {
        // åˆ†æ­¥è§£ç å¹¶æ·»åŠ é”™è¯¯æ•è·
        const decodedB64 = atob(key);
        const jsonStr = decodeURIComponent(escape(decodedB64));
        const keyData = JSON.parse(jsonStr);
        
        // éªŒè¯å¿…è¦å­—æ®µå­˜åœ¨
        if (!keyData.expiry || !keyData.nonce || !keyData.deviceFingerprint) {
            return { valid: false, reason: 'å¯†é’¥ç¼ºå°‘å¿…è¦å­—æ®µ' };
        }

        const currentTime = new Date().getTime();
        
        // ä¿®æ”¹æ—¶é—´æ¯”è¾ƒé€»è¾‘ï¼Œå°†å½“å‰æ—¶é—´è½¬æ¢ä¸ºç§’çº§æ—¶é—´æˆ³
        if (Math.floor(currentTime / 1000) > keyData.expiry) {
            return { valid: false, reason: 'å¯†é’¥å·²è¿‡æœŸ' };
        }

        // 2. è®¾å¤‡æŒ‡çº¹éªŒè¯ï¼ˆæ–°å¢ï¼‰
        const currentFingerprint = generateDeviceFingerprint();
        if (keyData.deviceFingerprint !== currentFingerprint) {
            return { valid: false, reason: 'æ­¤å¯†é’¥ä¸å¯åœ¨å½“å‰è®¾å¤‡ä½¿ç”¨' };
        }

        // æ£€æŸ¥å¯†é’¥æ˜¯å¦å·²è¢«ä½¿ç”¨ï¼ˆè·¨å¹³å°éªŒè¯ï¼‰
        const nonceCheckResult = await checkNonceUsed(keyData.nonce);
        if (nonceCheckResult.used) {
            return { valid: false, reason: 'å¯†é’¥å·²è¢«ä½¿ç”¨ï¼Œæ¯ä¸ªå¯†é’¥åªèƒ½ä½¿ç”¨ä¸€æ¬¡' };
        }
        
        return { valid: true, data: keyData };
    } catch (e) {
        // è¯¦ç»†é”™è¯¯ç±»å‹åˆ¤æ–­
        if (e instanceof DOMException && e.name === 'InvalidCharacterError') {
            return { valid: false, reason: 'å¯†é’¥Base64è§£ç å¤±è´¥' };
        } else if (e instanceof SyntaxError) {
            return { valid: false, reason: 'å¯†é’¥JSONæ ¼å¼æ— æ•ˆ' };
        } else {
            return { valid: false, reason: 'éªŒè¯è¿‡ç¨‹å¼‚å¸¸: ' + e.message };
        }
    }
}

// æ‰‹åŠ¨å½•å…¥
function manualCalc() {
    if (!isKeyValid) {
        KEY_MODAL.classList.remove('hidden');
        alert('è¯·å…ˆéªŒè¯æœ‰æ•ˆçš„å¯†é’¥');
        return;
    }
  const lines = document.getElementById('numbersInput').value.trim().split(/\n+/).filter(Boolean);
  if (!lines.length) {
    outputEl.textContent = 'è¯·è¾“å…¥æ•°æ®';
    return;
  }
      
      let addedCount = 0;
      for (const l of lines) {
        const parsed = parseInput(l);
        if (!parsed) {
          outputEl.textContent = 'æ ¼å¼é”™è¯¯ï¼šè¯·è¾“å…¥æ­£ç¡®çš„æ•°æ®æ ¼å¼';
          return;
        }
        
        const { period, data } = parsed;
        const fmt = data.join(',');
        
        // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒæœŸæ•°æˆ–ç›¸åŒæ•°æ®
        if (seenPeriods.has(period) || (history.length && history[history.length-1].input === fmt)) continue;
        
        history.push({ period, data, input: fmt });
        seenPeriods.add(period);
        addedCount++;
      }
      
      document.getElementById('numbersInput').value = '';
      outputEl.textContent = addedCount > 0 ? `æˆåŠŸæ·»åŠ  ${addedCount} æœŸæ•°æ®` : 'æ²¡æœ‰æ–°æ•°æ®æ·»åŠ ';
      document.getElementById('periodCount').textContent = history.length;
      
      if (history.length > 0) {
        document.getElementById('currentPeriod').textContent = history[history.length-1].period;
        renderTable();
      }
    }
    
    // æ–‡ä»¶é€‰æ‹©å¤„ç†
    function handleFileSelect(event) {
        if (!isKeyValid) {
        KEY_MODAL.classList.remove('hidden');
        alert('è¯·å…ˆéªŒè¯æœ‰æ•ˆçš„å¯†é’¥');
        return;
    }
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        const content = e.target.result;
        document.getElementById('numbersInput').value = content;
        outputEl.textContent = `æ–‡ä»¶ "${file.name}" åŠ è½½å®Œæˆï¼Œè¯·ç‚¹å‡»æ‰‹åŠ¨è®¡ç®—å¤„ç†æ•°æ®`;
      };
      reader.readAsText(file);
    }
    
    // è‡ªåŠ¨è·å–å¼€å§‹
    function startAutoFetch() {
        if (!isKeyValid) {
        KEY_MODAL.classList.remove('hidden');
        alert('è¯·å…ˆéªŒè¯æœ‰æ•ˆçš„å¯†é’¥');
        return;
    }
      if (autoFetchTimer) {
        outputEl.textContent = 'è‡ªåŠ¨è·å–å·²åœ¨è¿è¡Œä¸­';
        return;
      }
      
      // æ¨¡æ‹Ÿè‡ªåŠ¨è·å–é€»è¾‘
      autoFetchTimer = setInterval(() => {
        // è¿™é‡Œåº”è¯¥æ˜¯å®é™…çš„æ•°æ®è·å–é€»è¾‘
        // ç›®å‰åªæ˜¯æ¨¡æ‹Ÿ
        const mockPeriod = `2024${String(Math.floor(Math.random() * 365) + 1).padStart(3, '0')}`;
        const mockData = Array.from({length: 10}, () => Math.floor(Math.random() * 80) + 1).sort((a,b) => a-b);
        
        if (!seenPeriods.has(mockPeriod)) {
          history.push({ period: mockPeriod, data: mockData, input: mockData.join(',') });
          seenPeriods.add(mockPeriod);
          
          document.getElementById('periodCount').textContent = history.length;
          document.getElementById('currentPeriod').textContent = mockPeriod;
          outputEl.textContent = `è‡ªåŠ¨è·å–: ${mockPeriod} - ${mockData.join(' ')}`;
          renderTable();
        }
      }, 5000); // æ¯5ç§’è·å–ä¸€æ¬¡
      
      document.getElementById('autoStatus').textContent = 'è¿è¡Œä¸­';
      outputEl.textContent = 'è‡ªåŠ¨è·å–å·²å¯åŠ¨ï¼Œæ¯5ç§’æ£€æŸ¥ä¸€æ¬¡æ–°æ•°æ®';
    }
    
    // åœæ­¢è‡ªåŠ¨è·å–
    function stopAutoFetch() {
      if (autoFetchTimer) {
        clearInterval(autoFetchTimer);
        autoFetchTimer = null;
        document.getElementById('autoStatus').textContent = 'å…³é—­';
        outputEl.textContent = 'è‡ªåŠ¨è·å–å·²åœæ­¢';
      } else {
        outputEl.textContent = 'è‡ªåŠ¨è·å–æœªåœ¨è¿è¡Œ';
      }
    }
    
    // æ¸…ç©ºæ•°æ®
    function clearData() {
      history = [];
      seenPeriods.clear();
      document.getElementById('periodCount').textContent = '0';
      document.getElementById('currentPeriod').textContent = '-';
      document.getElementById('numbersInput').value = '';
      outputEl.textContent = 'æ•°æ®å·²æ¸…ç©º';
      renderTable();
    }
    
    // æ›´æ–°æ˜¾ç¤ºæœŸæ•°
    function updateDisplayPeriods() {
      const select = document.getElementById('periodSelect');
      displayPeriods = select.value === 'all' ? history.length : parseInt(select.value);
      renderTable();
    }
    
    // æ›´æ–°æ’åºæ–¹å¼
    function updateSortMethod() {
      const select = document.getElementById('sortSelect');
      sortByHit = select.value === 'hit';
      renderTable();
    }
    
    // ç”Ÿæˆæ–‡ä»¶å”¯ä¸€æ ‡è¯†
    function generateFileIdentifier() {
      // ä½¿ç”¨å½“å‰é¡µé¢URLå’Œç”¨æˆ·ä»£ç†ç”Ÿæˆå”¯ä¸€æ ‡è¯†
      const identifier = window.location.href + navigator.userAgent;
      let hash = 0;
      for (let i = 0; i < identifier.length; i++) {
        const char = identifier.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash;
      }
      return Math.abs(hash).toString(36);
    }
    
    // æ¸²æŸ“åˆ†æè¡¨æ ¼
    function renderTable() {
      if (history.length === 0) {
        document.querySelector('#resultTable tbody').innerHTML = '<tr><td colspan="5">æš‚æ— æ•°æ®</td></tr>';
        return;
      }
      
      const selectedNum = parseInt(document.querySelector('#numButtons .btn-active')?.dataset.num || '5');
      const selectedHits = Array.from(document.querySelectorAll('#hitButtons .btn-active')).map(b => parseInt(b.dataset.hit));
      
      // è·å–è¦åˆ†æçš„æœŸæ•°
      const periodsToAnalyze = Math.min(displayPeriods, history.length);
      const recentHistory = history.slice(-periodsToAnalyze);
      
      // ç»Ÿè®¡æ¯ä¸ªå·ç çš„å‡ºç°æƒ…å†µ
      const stats = {};
      for (let num = 1; num <= 80; num++) {
        stats[num] = {
          hits: 0,
          misses: 0,
          frequency: 0,
          lastAppear: -1,
          consecutiveHits: 0,
          consecutiveMisses: 0
        };
      }
      
      // åˆ†æå†å²æ•°æ®
      recentHistory.forEach((entry, index) => {
        entry.data.forEach(num => {
          stats[num].hits++;
          stats[num].lastAppear = index;
        });
        
        // è®¡ç®—é—æ¼
        for (let num = 1; num <= 80; num++) {
          if (!entry.data.includes(num)) {
            stats[num].misses++;
          }
        }
      });
      
      // è®¡ç®—é¢‘ç‡å’Œè¿ç»­æƒ…å†µ
      Object.keys(stats).forEach(num => {
        const stat = stats[num];
        stat.frequency = (stat.hits / periodsToAnalyze * 100).toFixed(1);
        stat.consecutiveMisses = periodsToAnalyze - 1 - stat.lastAppear;
        
        // è®¡ç®—è¿ç»­ä¸­å‡ºæ¬¡æ•°
        let consecutive = 0;
        for (let i = recentHistory.length - 1; i >= 0; i--) {
          if (recentHistory[i].data.includes(parseInt(num))) {
            consecutive++;
          } else {
            break;
          }
        }
        stat.consecutiveHits = consecutive;
      });
      
      // è½¬æ¢ä¸ºæ•°ç»„å¹¶æ’åº
      let sortedStats = Object.entries(stats).map(([num, stat]) => ({
        num: parseInt(num),
        ...stat,
        score: calculateScore(stat, periodsToAnalyze)
      }));
      
      // æ ¹æ®é€‰æ‹©çš„æ’åºæ–¹å¼æ’åº
      if (sortByHit) {
        sortedStats.sort((a, b) => b.consecutiveHits - a.consecutiveHits || b.hits - a.hits);
      } else {
        sortedStats.sort((a, b) => b.consecutiveMisses - a.consecutiveMisses || a.hits - b.hits);
      }
      
      // ç­›é€‰ç¬¦åˆæ¡ä»¶çš„å·ç 
      let filteredStats = sortedStats;
      if (selectedHits.length > 0) {
        filteredStats = sortedStats.filter(stat => selectedHits.includes(stat.consecutiveHits));
      }
      
      // å–å‰Nä¸ªå·ç 
      const topStats = filteredStats.slice(0, selectedNum);
      
      // æ¸²æŸ“è¡¨æ ¼
      const tbody = document.querySelector('#resultTable tbody');
      tbody.innerHTML = topStats.map(stat => {
        const hitClass = `hit-${Math.min(stat.consecutiveHits, 5)}`;
        return `
          <tr class="${hitClass}">
            <td><strong>${stat.num.toString().padStart(2, '0')}</strong></td>
            <td>${stat.consecutiveHits}</td>
            <td>${stat.consecutiveMisses}</td>
            <td>${stat.frequency}%</td>
            <td>${stat.score.toFixed(1)}</td>
          </tr>
        `;
      }).join('');
      
      // æ›´æ–°è¾“å‡ºä¿¡æ¯
      const selectedNumbers = topStats.map(s => s.num.toString().padStart(2, '0')).join(' ');
      outputEl.textContent = `æ¨èå·ç  (${selectedNum}èƒ†): ${selectedNumbers}\nåˆ†ææœŸæ•°: ${periodsToAnalyze}æœŸ\næ’åºæ–¹å¼: ${sortByHit ? 'è¿ä¸­æ¬¡æ•°' : 'é—æ¼æ¬¡æ•°'}`;
    }
    
    // è®¡ç®—æ¨èåˆ†æ•°
    function calculateScore(stat, totalPeriods) {
      const hitRate = stat.hits / totalPeriods;
      const missRate = stat.consecutiveMisses / totalPeriods;
      const hitBonus = stat.consecutiveHits * 2;
      
      // ç»¼åˆè¯„åˆ†ï¼šå‘½ä¸­ç‡ + é—æ¼åŠ åˆ† + è¿ä¸­åŠ åˆ†
      return (hitRate * 50) + (missRate * 30) + hitBonus;
    }
    
    // ä¸»é¢˜åˆ‡æ¢
    function toggleTheme() {
      document.body.classList.toggle('dark-theme');
      const isDark = document.body.classList.contains('dark-theme');
      document.querySelector('.theme-toggle').textContent = isDark ? 'â˜€ï¸' : 'ğŸŒ™';
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
    }
    
    // æ˜¾ç¤ºå¸®åŠ©
    function showHelp() {
      document.getElementById('helpModal').classList.remove('hidden');
    }
    
    // éšè—å¸®åŠ©
    function hideHelp() {
      document.getElementById('helpModal').classList.add('hidden');
    }
    
    // é¡µé¢åŠ è½½æ—¶æ¢å¤ä¸»é¢˜
    document.addEventListener('DOMContentLoaded', function() {
      const savedTheme = localStorage.getItem('theme');
      if (savedTheme === 'dark') {
        document.body.classList.add('dark-theme');
        document.querySelector('.theme-toggle').textContent = 'â˜€ï¸';
      }
    });
    
    // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
    document.getElementById('helpModal').addEventListener('click', function(e) {
      if (e.target === this) {
        hideHelp();
      }
    });
    
    // ESCé”®å…³é—­æ¨¡æ€æ¡†
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        hideHelp();
      }
    });
  </script>
</body>
</html>