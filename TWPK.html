<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>台湾PK数据分析工具</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  
  <!-- Tailwind配置 -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#3b82f6',
            secondary: '#10b981'
          }
        }
      }
    }
  </script>
  
  
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .sticky-header {
    position: sticky;
    top: 0;
    z-index: 100;
  }
  .sticky-col {
    position: sticky;
    z-index: 50;
  }
  .header-title {
    transition: transform 0.3s ease, opacity 0.3s ease, height 0.3s ease, padding 0.3s ease;
    overflow: hidden;
  }
  .header-title.hidden-on-scroll {
    transform: translateY(-100%);
    opacity: 0;
    height: 0;
    padding: 0;
    pointer-events: none;
  }
  .toolbar-sticky {
    position: sticky;
    top: 0;
    z-index: 100;
    transition: all 0.3s ease;
  }
      .scrollbar-hide::-webkit-scrollbar {
        display: none;
      }
      .scrollbar-hide {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
      .hit-cell {
        @apply bg-primary/20 text-primary font-bold;
      }
      .miss-cell {
        @apply text-gray-400;
      }
      .btn-active {
        @apply bg-primary text-white;
      }
      .btn-hover {
        @apply hover:bg-primary/80 hover:text-white transition-colors duration-200;
      }
      
      /* 按钮悬停变色为FF7373 - 仅在支持hover的设备上生效 */
      @media (hover: hover) {
        button:hover {
          background-color: #FF7373 !important;
          transition: background-color 0.2s ease;
        }
      }
      
      /* 移动端触摸反馈 - 避免保持hover状态 */
      @media (hover: none) {
        button:active {
          background-color: #FF7373 !important;
          transition: background-color 0.1s ease;
        }
      }
      
      /* 防止移动端双击放大和意外缩放 */
      * {
        touch-action: manipulation;
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
      }
      
      /* 允许输入框和文本区域选择文本 */
      input, textarea, [contenteditable] {
        -webkit-user-select: text;
        -moz-user-select: text;
        -ms-user-select: text;
        user-select: text;
      }
      
      /* 胆码按钮特殊处理 - 确保触摸反馈正常 */
      .dama-btn {
        touch-action: manipulation;
        -webkit-tap-highlight-color: transparent;
      }
      
      /* 胆码按钮未选中状态 - 覆盖全局hover样式 */
      @media (hover: hover) {
        .dama-btn:not(.bg-primary):hover {
          background-color: #e5e7eb !important; /* gray-200 */
          color: #374151 !important; /* gray-700 */
        }
      }
      
      /* 胆码按钮选中状态保持红色 */
      .dama-btn.bg-primary {
        background-color: #d62828 !important;
        color: white !important;
      }
      
      @media (hover: hover) {
        .dama-btn.bg-primary:hover {
          background-color: #b91c1c !important; /* 稍深的红色 */
          color: white !important;
        }
      }
      
      /* 防止页面缩放 */
      html {
        -ms-touch-action: manipulation;
        touch-action: manipulation;
      }
      .number-row {
        @apply flex justify-center space-x-1 mb-1;
      }
      
      /* 手机端五星做号页面优化 */
      @media (max-width: 768px) {
        /* 移除主容器的左右边距 */
        #fiveStarPage .container {
          padding-left: 0 !important;
          padding-right: 0 !important;
          margin-left: 0 !important;
          margin-right: 0 !important;
          max-width: 100% !important;
        }
        
        /* 移除模块容器的边距和圆角 */
        #fiveStarPage .bg-white {
          border-radius: 0 !important;
          padding: 8px !important;
          margin: 0 !important;
        }
        
        /* 移除模块间距 */
        #modules-container {
          gap: 8px !important;
          padding: 0 !important;
        }
        
        /* 移除模块边框和圆角 */
        .five-star-module {
          border: none !important;
          border-radius: 0 !important;
          padding: 8px !important;
          margin: 0 !important;
        }
        
        /* 优化数字按钮尺寸 - 确保一行放10个 */
        .number-btn {
          width: calc(10% - 2px) !important;
          height: 32px !important;
          min-width: 28px !important;
          font-size: 13px !important;
          padding: 0 !important;
          margin: 1px !important;
          flex-shrink: 0 !important; /* 防止按钮收缩 */
        }
        
        /* 优化数字按钮容器 - 确保不换行 */
        .number-buttons {
          gap: 0 !important;
          margin-bottom: 8px !important;
          flex-wrap: nowrap !important; /* 强制不换行 */
          overflow-x: auto !important; /* 如果内容过宽则允许横向滚动 */
        }
        
        /* 优化胆码按钮 */
        .dama-btn {
          font-size: 13px !important;
          padding: 4px 8px !important;
          margin: 1px !important;
        }
        
        /* 优化胆码按钮容器 */
        .dama-buttons {
          gap: 2px !important;
          margin-bottom: 8px !important;
        }
        
        /* 优化筛选组间距 */
        .filter-group {
          margin-bottom: 8px !important;
          padding-bottom: 8px !important;
        }
        
        /* 优化模块总容错区域 */
        .module-tolerance {
          margin-bottom: 8px !important;
          padding: 8px !important;
        }
      }
      
      /* 手机端黄金切割页面优化 */
      @media (max-width: 768px) {
        /* 移除黄金切割页面主容器的左右边距 */
        #goldenRatioPage .container {
          padding-left: 0 !important;
          padding-right: 0 !important;
          margin-left: 0 !important;
          margin-right: 0 !important;
          max-width: 100% !important;
        }
        
        /* 移除主模块的边距和圆角 */
        #goldenRatioPage .bg-white {
          border-radius: 0 !important;
          padding: 12px !important;
          margin: 0 !important;
          box-shadow: none !important;
        }
        
        /* 优化模式选择按钮 */
        #goldenRatioPage .flex.justify-center.gap-3 {
          gap: 8px !important;
        }
        
        #goldenRatioPage button[data-mode] {
          padding: 8px 16px !important;
          font-size: 14px !important;
        }
        
        /* 优化输入区域 */
        #goldenInputData {
          padding: 8px !important;
          font-size: 14px !important;
        }
        
        /* 优化操作按钮 */
        #goldenRatioPage .flex.justify-center.gap-3.mb-6 {
          gap: 6px !important;
          flex-wrap: wrap !important;
        }
        
        #goldenRatioPage .flex.justify-center.gap-3.mb-6 button {
          padding: 8px 12px !important;
          font-size: 13px !important;
          flex: 1 !important;
          min-width: 80px !important;
        }
        
        /* 优化结果显示区域 */
        #goldenRatioPage .grid.grid-cols-1.sm\:grid-cols-2.md\:grid-cols-3.lg\:grid-cols-5 {
          grid-template-columns: 1fr 1fr !important;
          gap: 4px !important;
        }
        
        /* 优化验证结果区域 */
        #validationResults {
          padding: 8px !important;
          margin-top: 12px !important;
        }
        
        /* 优化标题和摘要 */
        #goldenRatioPage h3 {
          font-size: 16px !important;
        }
        
        #goldenRatioPage .text-sm {
          font-size: 12px !important;
        }
      }
      
      /* 手机端黄金切割页面优化 */
      @media (max-width: 768px) {
        /* 移除黄金切割页面主容器的左右边距 */
        #goldenRatioPage .container {
          padding-left: 0 !important;
          padding-right: 0 !important;
          margin-left: 0 !important;
          margin-right: 0 !important;
          max-width: 100% !important;
        }
        
        /* 移除主模块的边框、圆角和阴影 */
        #goldenRatioPage .bg-white {
          border-radius: 0 !important;
          box-shadow: none !important;
          padding: 8px !important;
          margin: 0 !important;
        }
        
        /* 优化模式选择按钮 */
        #goldenRatioPage .flex.justify-center.gap-3 button {
          padding: 8px 16px !important;
          font-size: 14px !important;
          margin: 2px !important;
        }
        
        /* 优化输入区域 */
        #goldenRatioPage textarea {
          padding: 8px !important;
          font-size: 14px !important;
          border-radius: 4px !important;
        }
        
        /* 优化操作按钮 */
        #goldenRatioPage .flex.justify-center.gap-3.mb-6 button {
          padding: 8px 12px !important;
          font-size: 13px !important;
          margin: 2px !important;
        }
        
        /* 优化结果显示区域 */
        #goldenRatioPage .grid.gap-2 {
          gap: 4px !important;
        }
        
        /* 优化验证结果区域 */
        #goldenRatioPage #validationResults {
          padding: 8px !important;
          margin-top: 8px !important;
          border-radius: 4px !important;
        }
        
        /* 减少各区域的边距 */
        #goldenRatioPage .mb-6 {
          margin-bottom: 12px !important;
        }
        
        #goldenRatioPage .mb-4 {
          margin-bottom: 8px !important;
        }
        
        #goldenRatioPage .mb-2 {
          margin-bottom: 4px !important;
        }
      }
      .fixed-width-period {
        width: 120px;
        transition: opacity 0.3s ease;
      }
      .fixed-width-data {
        width: 150px;
        transition: left 0.3s ease;
      }
      .table-header-sticky {
        position: sticky;
        top: 0;
        z-index: 1002;
        background-color: #f9fafb;
      }
      .sticky-bg-white {
        background-color: white !important;
      }
      .sticky-bg-gray-100 {
        background-color: #f3f4f6 !important;
      }
      
      /* 自定义滚动条样式 */
      .scrollbar-thin {
        scrollbar-width: thin;
      }
      
      .scrollbar-thin::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }
      
      .scrollbar-thumb-gray-300::-webkit-scrollbar-thumb {
        background-color: #d1d5db;
        border-radius: 3px;
      }
      
      .scrollbar-thumb-gray-300::-webkit-scrollbar-thumb:hover {
        background-color: #9ca3af;
      }
      
      .scrollbar-track-gray-100::-webkit-scrollbar-track {
        background-color: #f3f4f6;
        border-radius: 3px;
      }
      
      /* 黄金切割结果容器样式 */
      #goldenResults {
        scroll-behavior: smooth;
      }
      
      #goldenResults::-webkit-scrollbar {
        height: 8px;
      }
      
      #goldenResults::-webkit-scrollbar-track {
        background: #f1f5f9;
        border-radius: 4px;
      }
      
      #goldenResults::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 4px;
      }
      
      #goldenResults::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
      }
      
      /* 模式切换按钮样式 */
      .active-mode {
        background-color: #3b82f6 !important;
        color: white !important;
      }
      
      .inactive-mode {
        background-color: #d1d5db !important;
        color: #374151 !important;
      }
      .sticky-bg-gray-50 {
        background-color: #f9fafb !important;
      }
      .slider-container {
        @apply relative h-6 mt-2 mb-4;
      }
      .slider-track {
        @apply absolute h-2 w-full bg-gray-200 rounded-full;
      }
      .slider-thumb {
        @apply absolute w-5 h-5 bg-primary rounded-full cursor-pointer -mt-1.5 -ml-2.5;
      }
      .slider-fill {
        @apply absolute h-2 bg-primary rounded-full;
      }
      .vertical-slider-container {
        @apply absolute right-0 top-0 h-full w-4 flex items-center justify-center z-10;
      }
      .vertical-slider-track {
        @apply absolute h-full w-1 bg-gray-200 rounded-full;
      }
      .vertical-slider-thumb {
        @apply absolute w-4 h-6 bg-primary rounded-md cursor-pointer -ml-1.5;
      }
      .vertical-slider-fill {
        @apply absolute w-1 bg-primary rounded-full;
      }
      /* 限制表格容器高度，最多显示50行 */
      .table-container {
        max-height: calc(100vh - 400px); /* 页面一屏高度减去其他元素高度 */
        overflow-y: auto;
        position: relative;
      }
      
      /* 手机端全屏模式样式 */
      @media (max-width: 768px) {
        /* 全屏模式下的工具栏样式 */
        .fullscreen-toolbar {
          position: fixed !important;
          top: 0 !important;
          left: 0 !important;
          right: 0 !important;
          z-index: 1000 !important;
          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15) !important;
        }
        
        /* 全屏模式下隐藏的元素 */
        .fullscreen-hidden {
          transform: translateY(-100%) !important;
          transition: transform 0.3s ease-in-out !important;
        }
        
        /* 全屏模式下主内容区域的调整 */
        .fullscreen-main {
          padding-top: 50px !important;
          transition: padding-top 0.3s ease-in-out !important;
        }
        
        /* 优化手机端滚动性能 */
        body {
          -webkit-overflow-scrolling: touch;
        }
        
        /* 全屏模式下的工具栏按钮优化 */
        .fullscreen-toolbar .container {
          padding-left: 1rem !important;
          padding-right: 1rem !important;
        }
        
        .fullscreen-toolbar button {
          font-size: 14px !important;
          padding: 0.5rem 1rem !important;
        }
        
        /* 防止全屏切换时的闪烁 */
        header * {
          backface-visibility: hidden;
          -webkit-backface-visibility: hidden;
        }
        
        /* 全屏模式下的阴影效果 */
        .fullscreen-toolbar::after {
          content: '';
          position: absolute;
          bottom: -8px;
          left: 0;
          right: 0;
          height: 8px;
          background: linear-gradient(to bottom, rgba(0,0,0,0.1), transparent);
          pointer-events: none;
        }
      }
    }
  </style>
  
  <script>
    // 滚动时隐藏标题，保留工具栏
    let lastScrollTop = 0;
    let isScrolling = false;
    let isPageSwitching = false; // 页面切换标志
    let scrollTimeout = null; // 滚动防抖定时器
    
    function handleScroll() {
      if (isScrolling || isPageSwitching) return;
      
      // 清除之前的定时器
      if (scrollTimeout) {
        clearTimeout(scrollTimeout);
      }
      
      isScrolling = true;
      
      // 添加防抖延迟，避免频繁触发
      scrollTimeout = setTimeout(() => {
        requestAnimationFrame(() => {
          const currentScroll = window.pageYOffset || document.documentElement.scrollTop;
          const headerTitle = document.querySelector('.header-title');
          const keyCountdown = document.getElementById('keyCountdown');
          const scrollDirection = currentScroll > lastScrollTop ? 'down' : 'up';
          
          // 增加滚动阈值和方向检测，减少闪动
          if (currentScroll > 80 && scrollDirection === 'down') {
            // 向下滚动超过80px时隐藏标题
            headerTitle.classList.add('hidden-on-scroll');
            // 同时隐藏密钥倒计时栏（完全隐藏并释放空间）
            if (keyCountdown && !keyCountdown.classList.contains('hidden')) {
              keyCountdown.style.height = '0';
              keyCountdown.style.opacity = '0';
              keyCountdown.style.paddingTop = '0';
              keyCountdown.style.paddingBottom = '0';
              keyCountdown.style.overflow = 'hidden';
              keyCountdown.style.transition = 'all 0.3s ease-in-out';
            }
          } else if (currentScroll < 40 && scrollDirection === 'up') {
            // 向上滚动到40px以下时显示标题
            headerTitle.classList.remove('hidden-on-scroll');
            // 同时显示密钥倒计时栏（恢复原始高度和样式）
            if (keyCountdown && !keyCountdown.classList.contains('hidden')) {
              keyCountdown.style.height = 'auto';
              keyCountdown.style.opacity = '1';
              keyCountdown.style.paddingTop = '0.5rem';
              keyCountdown.style.paddingBottom = '0.5rem';
              keyCountdown.style.overflow = 'visible';
              keyCountdown.style.transition = 'all 0.3s ease-in-out';
            }
          }
          
          lastScrollTop = currentScroll <= 0 ? 0 : currentScroll;
          isScrolling = false;
        });
      }, 50); // 50ms防抖延迟
    }
    
    // 页面切换时禁用滚动监听
    function disableScrollListener() {
      isPageSwitching = true;
      setTimeout(() => {
        isPageSwitching = false;
      }, 300); // 300ms后重新启用
    }
    
    // 页面加载完成后添加滚动监听
    document.addEventListener('DOMContentLoaded', function() {
      window.addEventListener('scroll', handleScroll, { passive: true });
    });
  </script>
</head>
<body class="bg-gray-50 font-sans text-dark min-h-screen flex flex-col">
  <!-- 密钥倒计时通知栏 -->
  <div id="keyCountdown" class="bg-primary text-white py-2 px-4 text-center hidden">
    <span>密钥有效期剩余: <strong id="timeRemaining">0天 0小时 0分钟 0秒</strong></span>
  </div>
  
  <!-- 顶部导航 -->
  <!-- 标题区域 - 独立模块 -->
  <div class="header-title bg-white shadow-sm">
    <div class="container mx-auto px-4 py-3 flex flex-wrap items-center justify-between">
        <h1 class="text-xl md:text-2xl font-bold text-primary flex items-center">
          <i class="fa fa-line-chart mr-2"></i>台湾PK数据分析工具
        </h1>

      </div>
  </div>
    
  <!-- 工具栏区域 - 独立粘性模块 -->
  <nav class="bg-gray-800 text-white py-2 sticky-header toolbar-sticky" style="top: 0; z-index: 100;">
    <div class="container mx-auto px-4">
      <div class="flex space-x-4">
        <button id="dataAnalysisBtn" class="px-4 py-1 rounded bg-primary text-white font-medium">数据分析</button>
        <button id="fiveStarBtn" class="px-4 py-1 rounded bg-gray-600 text-white font-medium hover:bg-primary transition-colors">五星做号</button>
        <button id="goldenRatioBtn" class="px-4 py-1 rounded bg-gray-600 text-white font-medium hover:bg-primary transition-colors">黄金切割</button>
      </div>
    </div>
  </nav>

  <!-- 主要内容 -->
  <main class="flex-1 container mx-auto px-4 py-6">
    <!-- 数据分析页面 -->
    <div id="dataAnalysisPage">
      <!-- 数据输入区域 -->
      <section class="bg-white rounded-lg shadow-md p-5 mb-6">
        <div class="flex flex-col md:flex-row md:items-center gap-4">
          <div class="flex-1">
            <label for="numbersInput" class="block text-sm font-medium text-gray-700 mb-1">手动输入数据（支持格式：期数 数据，如：202504181232 02,05,01,04,07,10,09,03,06,08 ）</label>
            <textarea id="numbersInput" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all duration-200" placeholder="202504181232 02,05,01,04,07,10,09,03,06,08"></textarea>
          </div>
          <div class="flex flex-col gap-3 w-full md:w-auto">
            <button id="calcBtn" class="px-4 py-2 bg-primary text-white rounded-md flex items-center justify-center btn-hover">
              <i class="fa fa-calculator mr-2"></i>计算分析
            </button>
            <button id="autoFetchBtn" class="px-4 py-2 bg-secondary text-white rounded-md flex items-center justify-center btn-hover">
              <i class="fa fa-refresh mr-2"></i>自动获取数据
            </button>
            <button id="uploadDataBtn" class="px-4 py-2 bg-gray-600 text-white rounded-md flex items-center justify-center btn-hover">
              <i class="fa fa-upload mr-2"></i>上传数据文件
            </button>
          </div>
        </div>
        <div id="output" class="mt-3 text-sm text-primary"></div>
      </section>

      <!-- 筛选和统计控制区域 -->
      <section class="bg-white rounded-lg shadow-md p-5 mb-6">
        <div class="grid grid-cols-1 gap-4">
          <!-- 自定义组合 -->
          <div>
            <label for="customCombos" class="block text-sm font-medium text-gray-700 mb-1">自定义组合（用空格分隔不同组合，每个组合内的数字用逗号分隔）：</label>
            <div class="flex gap-3 items-start">
              <textarea id="customCombos" rows="2" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all duration-200" placeholder="1,2,3 1,2,4"></textarea>
              <div class="flex flex-col gap-2">
                <button id="statBtn" class="px-4 py-2 bg-gray-700 text-white rounded-md flex items-center btn-hover whitespace-nowrap">
                  <i class="fa fa-bar-chart mr-2"></i>加入统计
                </button>
                <button id="clearBtn" class="px-4 py-2 bg-gray-700 text-white rounded-md flex items-center btn-hover whitespace-nowrap">
                  <i class="fa fa-trash mr-2"></i>清空数据
                </button>
              </div>
            </div>
          </div>
          
          <!-- 筛选模块 -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <!-- 胆码数筛选 -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">前五码数：</label>
              <div id="numButtons" class="flex flex-wrap gap-2"></div>
            </div>
            
            <!-- 位置选择 -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">位置选择：</label>
              <div id="positionButtons" class="flex flex-wrap gap-2">
                <button class="position-btn px-3 py-1 rounded-md bg-gray-200 btn-hover" data-position="1">1名</button>
                <button class="position-btn px-3 py-1 rounded-md bg-gray-200 btn-hover" data-position="2">2名</button>
                <button class="position-btn px-3 py-1 rounded-md bg-gray-200 btn-hover" data-position="3">3名</button>
                <button class="position-btn px-3 py-1 rounded-md bg-gray-200 btn-hover" data-position="4">4名</button>
                <button class="position-btn px-3 py-1 rounded-md bg-gray-200 btn-hover" data-position="5">5名</button>
              </div>
            </div>
            
            <!-- 中出筛选 -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">命中码数：</label>
              <div id="hitButtons" class="flex flex-wrap gap-2"></div>
            </div>
          </div>
        </div>
        
        <!-- 操作按钮 -->
        <div class="flex flex-wrap gap-3 mt-5">
          <button id="sortToggle" class="px-4 py-2 bg-gray-700 text-white rounded-md flex items-center btn-hover hidden">
            <i class="fa fa-sort mr-2"></i><span id="sortText">按连中次数排序</span>
          </button>
        </div>
      </section>

      <!-- 结果表格 -->
      <section class="bg-white rounded-lg shadow-md p-5 overflow-x-auto relative">
        <div class="flex flex-wrap justify-between items-center mb-4 gap-3">
          <div class="flex items-center gap-3">
            <h2 class="text-lg font-semibold">数据分析结果</h2>
            <!-- 统一的按钮组 -->
            <div class="flex gap-1">
              <!-- 当前/历史切换 -->
              <div class="flex rounded-md overflow-hidden border border-gray-300">
                <button id="currentBtn" class="px-3 py-1 bg-gray-200 text-gray-700 btn-hover text-sm">历史</button>
                <button id="historyBtn" class="px-3 py-1 bg-blue-600 text-white btn-hover text-sm btn-active">当前</button>
              </div>
              <!-- 遗漏/连中切换 -->
              <div class="flex rounded-md overflow-hidden border border-gray-300">
                <button id="missBtn" class="px-3 py-1 bg-blue-600 text-white btn-hover text-sm btn-active">遗漏</button>
                <button id="hitBtn" class="px-3 py-1 bg-gray-200 text-gray-700 btn-hover text-sm">连中</button>
              </div>
            </div>
          </div>
          <div class="flex flex-wrap gap-2">
            <button class="period-btn px-3 py-1 rounded-md bg-gray-200 btn-hover btn-active" data-period="15">15期</button>
            <button class="period-btn px-3 py-1 rounded-md bg-gray-200 btn-hover" data-period="30">30期</button>
            <button class="period-btn px-3 py-1 rounded-md bg-gray-200 btn-hover" data-period="50">50期</button>
            <button class="period-btn px-3 py-1 rounded-md bg-gray-200 btn-hover" data-period="100">100期</button>
            <div class="flex items-center gap-1">
              <input type="number" id="customPeriod" min="1" max="10000" value="15" class="w-16 px-2 py-1 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary">
              <button id="customPeriodBtn" class="px-3 py-1 rounded-md bg-gray-200 btn-hover">自定义</button>
            </div>
          </div>
          <div class="text-sm text-gray-500">
            <span id="periodCount">0</span> 期数据
          </div>
        </div>
        
        <!-- 水平滑块 -->
        <div class="slider-container">
          <div class="slider-track"></div>
          <div class="slider-fill" id="horizontalFill"></div>
          <div class="slider-thumb" id="horizontalThumb"></div>
        </div>
        
        <div class="relative">
          <div class="overflow-x-auto table-container scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100" id="tableContainer">
            <table id="resultTable" class="min-w-full divide-y divide-gray-200">
              <thead></thead>
              <tbody></tbody>
            </table>
          </div>
          
          <!-- 垂直滑块 -->
          <div class="vertical-slider-container" id="verticalSlider">
            <div class="vertical-slider-track"></div>
            <div class="vertical-slider-fill" id="verticalFill"></div>
            <div class="vertical-slider-thumb" id="verticalThumb"></div>
          </div>
        </div>
        
        <!-- 统计摘要 -->
        <div id="summary" class="mt-4 p-3 bg-gray-50 rounded-md text-sm font-medium"></div>
      </section>
    </div>
    
    <!-- 五星做号页面（按图片布局） -->
    <div id="fiveStarPage" class="hidden">
      <div class="container mx-auto py-8">
        <div class="bg-white rounded-lg shadow-md p-6">
           <!-- 下方添加区域 - 所有模块统一容器 -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6" id="modules-container">
            <!-- 左侧卡片 - 模块1 (5组筛选条件) -->
        <div id="module1" class="border border-gray-200 rounded-lg p-4 five-star-module">
          <!-- 模块总容错设置 -->
          <div class="module-tolerance mb-4 p-3 bg-gray-50 rounded border">
            <div class="flex items-center text-sm">
              <span class="text-gray-700 font-medium mr-3">模块总容错：</span>
              <span class="text-gray-600 mr-2">允许</span>
              <select class="module-tolerance-min border border-gray-300 rounded px-2 py-1 text-xs" data-module="1">
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
              </select>
              <span class="mx-1">至</span>
              <select class="module-tolerance-max border border-gray-300 rounded px-2 py-1 text-xs" data-module="1">
                <option value="0" selected>0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
              </select>
              <span class="ml-2 text-gray-600">个条件不成立</span>
            </div>
          </div>
          
          <!-- 第1组筛选条件 -->
          <div class="filter-group mb-2 pb-2 border-b">
            <!-- 条件1容错选择器 -->
            <div class="flex items-center mb-2 text-sm">
              <span class="text-gray-600 mr-2">条件1容错</span>
              <select class="condition-tolerance-min border border-gray-300 rounded px-2 py-1 text-xs" data-module="1" data-group="1">
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
              </select>
              <span class="mx-1">至</span>
              <select class="condition-tolerance-max border border-gray-300 rounded px-2 py-1 text-xs" data-module="1" data-group="1">
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
              </select>
            </div>
            <div class="flex flex-wrap gap-2 mb-2 number-buttons">
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="1" data-module="1" data-group="1">01</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="2" data-module="1" data-group="1">02</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="3" data-module="1" data-group="1">03</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="4" data-module="1" data-group="1">04</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="5" data-module="1" data-group="1">05</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="6" data-module="1" data-group="1">06</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="7" data-module="1" data-group="1">07</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="8" data-module="1" data-group="1">08</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="9" data-module="1" data-group="1">09</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="10" data-module="1" data-group="1">10</button>
            </div>
            
            <div class="flex flex-wrap gap-2 mb-0 dama-buttons">
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="0" data-module="1" data-group="1">0胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="1" data-module="1" data-group="1">1胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="2" data-module="1" data-group="1">2胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="3" data-module="1" data-group="1">3胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="4" data-module="1" data-group="1">4胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="5" data-module="1" data-group="1">5胆</button>
            </div>
          </div>
          
          <!-- 第2组筛选条件 -->
          <div class="filter-group mb-2 pb-2 border-b">
            <!-- 条件2容错选择器 -->
            <div class="flex items-center mb-2 text-sm">
              <span class="text-gray-600 mr-2">条件2容错</span>
              <select class="condition-tolerance-min border border-gray-300 rounded px-2 py-1 text-xs" data-module="1" data-group="2">
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
              </select>
              <span class="mx-1">至</span>
              <select class="condition-tolerance-max border border-gray-300 rounded px-2 py-1 text-xs" data-module="1" data-group="2">
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
              </select>
            </div>
            <div class="flex flex-wrap gap-2 mb-2 number-buttons">
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="1" data-module="1" data-group="2">01</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="2" data-module="1" data-group="2">02</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="3" data-module="1" data-group="2">03</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="4" data-module="1" data-group="2">04</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="5" data-module="1" data-group="2">05</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="6" data-module="1" data-group="2">06</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="7" data-module="1" data-group="2">07</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="8" data-module="1" data-group="2">08</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="9" data-module="1" data-group="2">09</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="10" data-module="1" data-group="2">10</button>
            </div>
            
            <div class="flex flex-wrap gap-2 mb-0 dama-buttons">
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="0" data-module="1" data-group="2">0胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="1" data-module="1" data-group="2">1胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="2" data-module="1" data-group="2">2胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="3" data-module="1" data-group="2">3胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="4" data-module="1" data-group="2">4胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="5" data-module="1" data-group="2">5胆</button>
            </div>
          </div>
          
          <!-- 第3组筛选条件 -->
          <div class="filter-group mb-2 pb-2 border-b">
            <!-- 条件3容错选择器 -->
            <div class="flex items-center mb-2 text-sm">
              <span class="text-gray-600 mr-2">条件3容错</span>
              <select class="condition-tolerance-min border border-gray-300 rounded px-2 py-1 text-xs" data-module="1" data-group="3">
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
              </select>
              <span class="mx-1">至</span>
              <select class="condition-tolerance-max border border-gray-300 rounded px-2 py-1 text-xs" data-module="1" data-group="3">
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
              </select>
            </div>
            <div class="flex flex-wrap gap-2 mb-2 number-buttons">
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="1" data-module="1" data-group="3">01</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="2" data-module="1" data-group="3">02</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="3" data-module="1" data-group="3">03</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="4" data-module="1" data-group="3">04</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="5" data-module="1" data-group="3">05</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="6" data-module="1" data-group="3">06</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="7" data-module="1" data-group="3">07</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="8" data-module="1" data-group="3">08</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="9" data-module="1" data-group="3">09</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="10" data-module="1" data-group="3">10</button>
            </div>
            
            <div class="flex flex-wrap gap-2 mb-0 dama-buttons">
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="0" data-module="1" data-group="3">0胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="1" data-module="1" data-group="3">1胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="2" data-module="1" data-group="3">2胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="3" data-module="1" data-group="3">3胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="4" data-module="1" data-group="3">4胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="5" data-module="1" data-group="3">5胆</button>
            </div>
          </div>
          
          <!-- 第4组筛选条件 -->
          <div class="filter-group mb-2 pb-2 border-b">
            <!-- 条件4容错选择器 -->
            <div class="flex items-center mb-2 text-sm">
              <span class="text-gray-600 mr-2">条件4容错</span>
              <select class="condition-tolerance-min border border-gray-300 rounded px-2 py-1 text-xs" data-module="1" data-group="4">
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
              </select>
              <span class="mx-1">至</span>
              <select class="condition-tolerance-max border border-gray-300 rounded px-2 py-1 text-xs" data-module="1" data-group="4">
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
              </select>
            </div>
            <div class="flex flex-wrap gap-2 mb-2 number-buttons">
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="1" data-module="1" data-group="4">01</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="2" data-module="1" data-group="4">02</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="3" data-module="1" data-group="4">03</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="4" data-module="1" data-group="4">04</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="5" data-module="1" data-group="4">05</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="6" data-module="1" data-group="4">06</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="7" data-module="1" data-group="4">07</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="8" data-module="1" data-group="4">08</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="9" data-module="1" data-group="4">09</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="10" data-module="1" data-group="4">10</button>
            </div>
            
            <div class="flex flex-wrap gap-2 mb-0 dama-buttons">
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="0" data-module="1" data-group="4">0胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="1" data-module="1" data-group="4">1胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="2" data-module="1" data-group="4">2胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="3" data-module="1" data-group="4">3胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="4" data-module="1" data-group="4">4胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="5" data-module="1" data-group="4">5胆</button>
            </div>
          </div>
          
          <!-- 第5组筛选条件 -->
          <div class="filter-group mb-2 pb-2">
            <!-- 条件5容错选择器 -->
            <div class="flex items-center mb-2 text-sm">
              <span class="text-gray-600 mr-2">条件5容错</span>
              <select class="condition-tolerance-min border border-gray-300 rounded px-2 py-1 text-xs" data-module="1" data-group="5">
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
              </select>
              <span class="mx-1">至</span>
              <select class="condition-tolerance-max border border-gray-300 rounded px-2 py-1 text-xs" data-module="1" data-group="5">
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
              </select>
            </div>
            <div class="flex flex-wrap gap-2 mb-2 number-buttons">
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="1" data-module="1" data-group="5">01</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="2" data-module="1" data-group="5">02</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="3" data-module="1" data-group="5">03</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="4" data-module="1" data-group="5">04</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="5" data-module="1" data-group="5">05</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="6" data-module="1" data-group="5">06</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="7" data-module="1" data-group="5">07</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="8" data-module="1" data-group="5">08</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="9" data-module="1" data-group="5">09</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="10" data-module="1" data-group="5">10</button>
            </div>
            
            <div class="flex flex-wrap gap-2 mb-0 dama-buttons">
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="0" data-module="1" data-group="5">0胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="1" data-module="1" data-group="5">1胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="2" data-module="1" data-group="5">2胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="3" data-module="1" data-group="5">3胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="4" data-module="1" data-group="5">4胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="5" data-module="1" data-group="5">5胆</button>
            </div>
          </div>
          
          <!-- 输入区域 -->
          <div class="flex mb-2">
            <input type="text" placeholder="输入结果" class="result-input flex-1 border border-gray-300 rounded-l px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-primary" data-module="1">
            <button class="clear-btn px-3 border border-gray-300 border-l-0 bg-gray-100 hover:bg-gray-200 text-sm" data-module="1">清</button>
            <button class="reverse-btn px-3 border border-gray-300 border-l-0 bg-gray-100 hover:bg-gray-200 text-sm rounded-r" data-module="1">反</button>
          </div>
          <div class="text-red-500 text-sm mb-4 result-count" data-module="1">共0注</div>
          
          <!-- 操作按钮区域 -->
          <div class="flex gap-2">
            <button class="generate-btn flex-1 bg-blue-600 text-white py-2 rounded hover:bg-blue-700" data-module="1">做号</button>
            <button class="copy-btn flex-1 bg-blue-600 text-white py-2 rounded hover:bg-blue-700" data-module="1">复制</button>
            <button onclick="addModule(1)" class="add-btn w-10 bg-green-600 text-white py-2 rounded hover:bg-green-700" data-module="1">+</button>
            <button onclick="removeModule(1)" class="remove-btn w-10 bg-red-600 text-white py-2 rounded hover:bg-red-700" data-module="1">-</button>
          </div>
        </div>
            
            <!-- 右侧卡片 - 模块2 (结构与模块1相同，data-module="2") -->
        <div id="module2" class="border border-gray-200 rounded-lg p-4 five-star-module">
          <!-- 模块总容错设置 -->
          <div class="module-tolerance mb-4 p-3 bg-gray-50 rounded border">
            <div class="flex items-center text-sm">
              <span class="text-gray-700 font-medium mr-3">模块总容错：</span>
              <span class="text-gray-600 mr-2">允许</span>
              <select class="module-tolerance-min border border-gray-300 rounded px-2 py-1 text-xs" data-module="2">
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
              </select>
              <span class="mx-1">至</span>
              <select class="module-tolerance-max border border-gray-300 rounded px-2 py-1 text-xs" data-module="2">
                <option value="0" selected>0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
              </select>
              <span class="ml-2 text-gray-600">个条件不成立</span>
            </div>
          </div>
          
          <!-- 第1组筛选条件 -->
          <div class="filter-group mb-2 pb-2 border-b">
            <!-- 条件1容错选择器 -->
            <div class="flex items-center mb-2 text-sm">
              <span class="text-gray-600 mr-2">条件1容错</span>
              <select class="condition-tolerance-min border border-gray-300 rounded px-2 py-1 text-xs" data-module="2" data-group="1">
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
              </select>
              <span class="mx-1">至</span>
              <select class="condition-tolerance-max border border-gray-300 rounded px-2 py-1 text-xs" data-module="2" data-group="1">
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
              </select>
            </div>
            <div class="flex flex-wrap gap-2 mb-2 number-buttons">
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="1" data-module="2" data-group="1">01</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="2" data-module="2" data-group="1">02</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="3" data-module="2" data-group="1">03</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="4" data-module="2" data-group="1">04</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="5" data-module="2" data-group="1">05</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="6" data-module="2" data-group="1">06</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="7" data-module="2" data-group="1">07</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="8" data-module="2" data-group="1">08</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="9" data-module="2" data-group="1">09</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="10" data-module="2" data-group="1">10</button>
            </div>
            
            <div class="flex flex-wrap gap-2 mb-0 dama-buttons">
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="0" data-module="2" data-group="1">0胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="1" data-module="2" data-group="1">1胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="2" data-module="2" data-group="1">2胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="3" data-module="2" data-group="1">3胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="4" data-module="2" data-group="1">4胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="5" data-module="2" data-group="1">5胆</button>
            </div>
          </div>
          
          <!-- 第2组筛选条件 -->
          <div class="filter-group mb-2 pb-2 border-b">
            <!-- 条件2容错选择器 -->
            <div class="flex items-center mb-2 text-sm">
              <span class="text-gray-600 mr-2">条件2容错</span>
              <select class="condition-tolerance-min border border-gray-300 rounded px-2 py-1 text-xs" data-module="2" data-group="2">
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
              </select>
              <span class="mx-1">至</span>
              <select class="condition-tolerance-max border border-gray-300 rounded px-2 py-1 text-xs" data-module="2" data-group="2">
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
              </select>
            </div>
            <div class="flex flex-wrap gap-2 mb-2 number-buttons">
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="1" data-module="2" data-group="2">01</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="2" data-module="2" data-group="2">02</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="3" data-module="2" data-group="2">03</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="4" data-module="2" data-group="2">04</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="5" data-module="2" data-group="2">05</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="6" data-module="2" data-group="2">06</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="7" data-module="2" data-group="2">07</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="8" data-module="2" data-group="2">08</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="9" data-module="2" data-group="2">09</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="10" data-module="2" data-group="2">10</button>
            </div>
            
            <div class="flex flex-wrap gap-2 mb-0 dama-buttons">
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="0" data-module="2" data-group="2">0胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="1" data-module="2" data-group="2">1胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="2" data-module="2" data-group="2">2胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="3" data-module="2" data-group="2">3胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="4" data-module="2" data-group="2">4胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="5" data-module="2" data-group="2">5胆</button>
            </div>
          </div>
          
          <!-- 第3组筛选条件 -->
          <div class="filter-group mb-2 pb-2 border-b">
            <!-- 条件3容错选择器 -->
            <div class="flex items-center mb-2 text-sm">
              <span class="text-gray-600 mr-2">条件3容错</span>
              <select class="condition-tolerance-min border border-gray-300 rounded px-2 py-1 text-xs" data-module="2" data-group="3">
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
              </select>
              <span class="mx-1">至</span>
              <select class="condition-tolerance-max border border-gray-300 rounded px-2 py-1 text-xs" data-module="2" data-group="3">
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
              </select>
            </div>
            <div class="flex flex-wrap gap-2 mb-2 number-buttons">
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="1" data-module="2" data-group="3">01</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="2" data-module="2" data-group="3">02</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="3" data-module="2" data-group="3">03</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="4" data-module="2" data-group="3">04</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="5" data-module="2" data-group="3">05</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="6" data-module="2" data-group="3">06</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="7" data-module="2" data-group="3">07</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="8" data-module="2" data-group="3">08</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="9" data-module="2" data-group="3">09</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="10" data-module="2" data-group="3">10</button>
            </div>
            
            <div class="flex flex-wrap gap-2 mb-0 dama-buttons">
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="0" data-module="2" data-group="3">0胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="1" data-module="2" data-group="3">1胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="2" data-module="2" data-group="3">2胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="3" data-module="2" data-group="3">3胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="4" data-module="2" data-group="3">4胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="5" data-module="2" data-group="3">5胆</button>
            </div>
          </div>
          
          <!-- 第4组筛选条件 -->
          <div class="filter-group mb-2 pb-2 border-b">
            <!-- 条件4容错选择器 -->
            <div class="flex items-center mb-2 text-sm">
              <span class="text-gray-600 mr-2">条件4容错</span>
              <select class="condition-tolerance-min border border-gray-300 rounded px-2 py-1 text-xs" data-module="2" data-group="4">
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
              </select>
              <span class="mx-1">至</span>
              <select class="condition-tolerance-max border border-gray-300 rounded px-2 py-1 text-xs" data-module="2" data-group="4">
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
              </select>
            </div>
            <div class="flex flex-wrap gap-2 mb-2 number-buttons">
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="1" data-module="2" data-group="4">01</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="2" data-module="2" data-group="4">02</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="3" data-module="2" data-group="4">03</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="4" data-module="2" data-group="4">04</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="5" data-module="2" data-group="4">05</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="6" data-module="2" data-group="4">06</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="7" data-module="2" data-group="4">07</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="8" data-module="2" data-group="4">08</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="9" data-module="2" data-group="4">09</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="10" data-module="2" data-group="4">10</button>
            </div>
            
            <div class="flex flex-wrap gap-2 mb-0 dama-buttons">
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="0" data-module="2" data-group="4">0胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="1" data-module="2" data-group="4">1胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="2" data-module="2" data-group="4">2胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="3" data-module="2" data-group="4">3胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="4" data-module="2" data-group="4">4胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="5" data-module="2" data-group="4">5胆</button>
            </div>
          </div>
          
          <!-- 第5组筛选条件 -->
          <div class="filter-group mb-2 pb-0">
            <!-- 条件5容错选择器 -->
            <div class="flex items-center mb-2 text-sm">
              <span class="text-gray-600 mr-2">条件5容错</span>
              <select class="condition-tolerance-min border border-gray-300 rounded px-2 py-1 text-xs" data-module="2" data-group="5">
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
              </select>
              <span class="mx-1">至</span>
              <select class="condition-tolerance-max border border-gray-300 rounded px-2 py-1 text-xs" data-module="2" data-group="5">
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
              </select>
            </div>
            <div class="flex flex-wrap gap-2 mb-2 number-buttons">
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="1" data-module="2" data-group="5">01</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="2" data-module="2" data-group="5">02</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="3" data-module="2" data-group="5">03</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="4" data-module="2" data-group="5">04</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="5" data-module="2" data-group="5">05</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="6" data-module="2" data-group="5">06</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="7" data-module="2" data-group="5">07</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="8" data-module="2" data-group="5">08</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="9" data-module="2" data-group="5">09</button>
              <button class="number-btn w-10 h-10 border border-gray-300 rounded flex items-center justify-center text-sm" data-number="10" data-module="2" data-group="5">10</button>
            </div>
            
            <div class="flex flex-wrap gap-2 mb-0 dama-buttons">
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="0" data-module="2" data-group="5">0胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="1" data-module="2" data-group="5">1胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="2" data-module="2" data-group="5">2胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="3" data-module="2" data-group="5">3胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="4" data-module="2" data-group="5">4胆</button>
              <button class="dama-btn px-3 py-1 border border-gray-300 rounded text-sm" data-dama="5" data-module="2" data-group="5">5胆</button>
            </div>
          </div>
          
          <!-- module2 输入区域和操作按钮区域与module1相同 -->
          <div class="flex mb-2">
            <input type="text" placeholder="输入结果" class="result-input flex-1 border border-gray-300 rounded-l px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-primary" data-module="2">
            <button class="clear-btn px-3 border border-gray-300 border-l-0 bg-gray-100 hover:bg-gray-200 text-sm" data-module="2">清</button>
            <button class="reverse-btn px-3 border border-gray-300 border-l-0 bg-gray-100 hover:bg-gray-200 text-sm rounded-r" data-module="2">反</button>
          </div>
          <div class="text-red-500 text-sm mb-4 result-count" data-module="2">共0注</div>
          
          <div class="flex gap-2">
            <button class="generate-btn flex-1 bg-blue-600 text-white py-2 rounded hover:bg-blue-700" data-module="2">做号</button>
            <button class="copy-btn flex-1 bg-blue-600 text-white py-2 rounded hover:bg-blue-700" data-module="2">复制</button>
            <button onclick="addModule(2)" class="add-btn w-10 bg-green-600 text-white py-2 rounded hover:bg-green-700" data-module="2">+</button>
            <button onclick="removeModule(2)" class="remove-btn w-10 bg-red-600 text-white py-2 rounded hover:bg-red-700" data-module="2">-</button>
          </div>
        </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 黄金分割页面 -->
    <div id="goldenRatioPage" class="hidden">
      <div class="container mx-auto px-4 py-6">
        <div class="bg-white rounded-lg shadow-lg p-6">
          <!-- 切割模式选择 -->
          <div class="mb-6">
            <div class="flex justify-center gap-3 mb-4">
              <button 
                id="modeUniformBtn" 
                class="px-6 py-2 bg-blue-500 text-white font-medium rounded-md hover:bg-blue-600 transition-colors active-mode"
                data-mode="uniform"
              >均匀</button>
              <button 
                id="modeStableBtn" 
                class="px-6 py-2 bg-gray-300 text-gray-700 font-medium rounded-md hover:bg-gray-400 transition-colors"
                data-mode="stable"
              >稳定</button>
            </div>
            <div class="text-center text-sm text-gray-600 mb-4">
              <span id="modeDescription">均匀模式：一次性分完就用，不保持历史分组</span>
            </div>
          </div>
          
          <!-- 输入区域 -->
          <div class="mb-6">
            <label for="goldenInputData" class="block text-sm font-medium text-gray-700 mb-2">请输入数据 <span id="goldenInputCount" class="text-red-500 text-sm font-medium hidden">共 0 项</span></label>
            <textarea 
              id="goldenInputData" 
              rows="6" 
              placeholder="示例：01,02,03,04,05,06,07,08,09,10" 
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent resize-none overflow-auto whitespace-pre-wrap"
            ></textarea>
          </div>
          
          <!-- 操作按钮 -->
          <div class="flex justify-center gap-3 mb-6">
            <button 
              id="goldenSplitBtn" 
              class="px-6 py-2 bg-primary text-white font-medium rounded-md hover:bg-primary/80 transition-colors"
            >开始分割</button>
            <button 
              id="goldenPasteBtn" 
              class="px-6 py-2 bg-green-500 text-white font-medium rounded-md hover:bg-green-600 transition-colors"
            >粘贴数据</button>
            <button 
              id="goldenClearBtn" 
              class="px-6 py-2 bg-gray-500 text-white font-medium rounded-md hover:bg-gray-600 transition-colors"
            >清空</button>
          </div>
          
          <!-- 结果显示区域 -->
          <div class="mb-6">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-lg font-semibold text-gray-800">分割结果</h3>
              <div class="text-sm text-gray-500" id="resultSummary"></div>
            </div>
            
            <!-- 5个紧凑排列的框 -->
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-2">
              <div id="goldenResults" class="col-span-full grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-2">
                <!-- 5个分组结果将在这里动态生成 -->
              </div>
            </div>
          </div>
          
          <!-- 验证结果显示 -->
          <div id="validationResults" class="mt-6 p-4 bg-gray-50 rounded-md hidden">
            <h3 class="text-lg font-semibold mb-2">5in4验证结果</h3>
            <div id="validationContent"></div>
          </div>
        </div>
      </div>
    </div>


  </main>
  
  

  <!-- 页脚 -->
  <footer class="bg-white border-t border-gray-200 py-4">
    <div class="container mx-auto px-4 text-center text-gray-500 text-sm">
      <p>台湾PK数据分析工具 © 2025，联系✈️@suibian925</p>
    </div>
  </footer>



  <!-- 密钥验证模态框 -->
  <div id="keyModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center" style="z-index: 9999;">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6">
      <div class="text-center mb-6">
        <h3 class="text-2xl font-bold text-gray-800 mb-2">请输入访问密钥</h3>
        <p class="text-gray-600">该功能需要有效的访问密钥才能使用</p>
      </div>
      
      <div class="mb-4">
        <input type="text" id="keyInput" placeholder="请输入32位访问密钥" class="w-full px-4 py-3 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all duration-200">
      </div>
      
      <div class="flex gap-3">
        <button id="verifyKeyBtn" class="w-full px-4 py-3 bg-primary text-white rounded-md font-medium hover:bg-primary/80 transition-colors">验证密钥</button>
        <!-- 移除取消按钮 -->
      </div>
    </div>
  </div>

  

<script>
// 全局模块状态存储
window.moduleStates = {};

// 添加模块功能
function addModule(currentModuleId) {
  const modulesContainer = document.getElementById('modules-container');
  const moduleElements = modulesContainer.querySelectorAll('.five-star-module');

  // 检查模块数量上限（最多14个）
  if (moduleElements.length >= 14) {
    alert('最多只能添加14个模块');
    return;
  }

  // 获取最后一个模块ID并递增
  const lastModuleId = parseInt(moduleElements[moduleElements.length - 1].id.replace('module', ''));
  const newModuleId = lastModuleId + 1;

  // 克隆当前模块
  const currentModule = document.getElementById(`module${currentModuleId}`);
  const newModule = currentModule.cloneNode(true);
  newModule.id = `module${newModuleId}`;
  newModule.querySelectorAll('[data-module]').forEach(el => {
    el.dataset.module = newModuleId;
  });
  resetModuleState(newModule);

  // 克隆当前模块后添加以下代码
  const newAddBtn = newModule.querySelector('.add-btn');
  newAddBtn.setAttribute('onclick', `addModule(${newModuleId})`);

  const newRemoveBtn = newModule.querySelector('.remove-btn');
  newRemoveBtn.setAttribute('onclick', `removeModule(${newModuleId})`);

  // 直接添加到模块容器末尾
  modulesContainer.appendChild(newModule);

  // 初始化新模块
  initFiveStarModule(newModuleId);
}

// 移除单个模块 - 确保最少保留2个
function removeModule(moduleId) {
  const modulesContainer = document.getElementById('modules-container');
  const moduleElements = modulesContainer.querySelectorAll('.five-star-module');
  const moduleToRemove = document.getElementById(`module${moduleId}`);

  // 确保至少保留2个模块
  if (moduleElements.length <= 2) {
    alert('至少保留2个模块');
    return;
  }

  // 移除模块
  moduleToRemove.remove();
}

// 重置模块状态的辅助函数
function resetModuleState(module) {
  // 清除克隆模块的选中状态和结果
  module.querySelectorAll('.number-btn, .dama-btn').forEach(btn => {
    btn.classList.remove('bg-primary', 'text-white');
  });
  module.querySelector('.result-input').value = '';
  module.querySelector('.result-count').textContent = '共0注';
}

// 生成排列组合的函数 - 迭代版本避免栈溢出
function permute(arr, k) {
  if (k === 0) return [[]];
  if (k === 1) return arr.map(x => [x]);
  
  const result = [];
  const stack = [{ current: [], remaining: arr, depth: 0 }];
  
  while (stack.length > 0) {
    const { current, remaining, depth } = stack.pop();
    
    if (depth === k) {
      result.push([...current]);
      continue;
    }
    
    for (let i = 0; i < remaining.length; i++) {
      const newCurrent = [...current, remaining[i]];
      const newRemaining = remaining.slice(0, i).concat(remaining.slice(i + 1));
      stack.push({ current: newCurrent, remaining: newRemaining, depth: depth + 1 });
    }
  }
  
  return result;
}

// 初始化五星模块
function initFiveStarModule(moduleId) {
  // 防止重复初始化
  if (window.moduleStates && window.moduleStates[moduleId]) {
    console.log(`模块${moduleId}已经初始化过，跳过重复初始化`);
    return;
  }
  
  // 确保全局状态对象存在
  if (!window.moduleStates) {
    window.moduleStates = {};
  }
  
  // 模块状态存储 - 修改为按组存储条件，每个条件组有独立的容错设置
  const moduleState = window.moduleStates[moduleId] = {
    groups: [
        { selectedNumbers: [], selectedDamas: [], toleranceMin: 0, toleranceMax: 0 }, // 组1
        { selectedNumbers: [], selectedDamas: [], toleranceMin: 0, toleranceMax: 0 }, // 组2
        { selectedNumbers: [], selectedDamas: [], toleranceMin: 0, toleranceMax: 0 }, // 组3
        { selectedNumbers: [], selectedDamas: [], toleranceMin: 0, toleranceMax: 0 }, // 组4
        { selectedNumbers: [], selectedDamas: [], toleranceMin: 0, toleranceMax: 0 }  // 组5
    ],
    // 模块总容错设置
    moduleToleranceMin: 0,  // 允许最少多少个条件不成立
    moduleToleranceMax: 0,  // 允许最多多少个条件不成立
    results: [],         // 当前显示结果
    allPermutations: [], // 所有排列组合
    originalResults: [], // 原始筛选结果
    isReversed: false    // 是否显示反向结果
  };

  // 获取模块元素
  const module = document.getElementById(`module${moduleId}`);
  const numberButtons = module.querySelectorAll('.number-btn');
  const damaButtons = module.querySelectorAll('.dama-btn');
  const generateBtn = module.querySelector('.generate-btn');
  const copyBtn = module.querySelector('.copy-btn');
  const clearBtn = module.querySelector('.clear-btn');
  const reverseBtn = module.querySelector('.reverse-btn');
  const resultInput = module.querySelector('.result-input');
  const resultCount = module.querySelector('.result-count');
  const conditionToleranceMinSelects = module.querySelectorAll('.condition-tolerance-min');
  const conditionToleranceMaxSelects = module.querySelectorAll('.condition-tolerance-max');
  const moduleToleranceMinSelect = module.querySelector('.module-tolerance-min');
  const moduleToleranceMaxSelect = module.querySelector('.module-tolerance-max');

  // 数字按钮点击事件
  numberButtons.forEach(button => {
      button.addEventListener('click', function() {
          const number = parseInt(this.dataset.number);
          const groupIndex = parseInt(this.dataset.group) - 1;
          const groupState = moduleState.groups[groupIndex];
          const index = groupState.selectedNumbers.indexOf(number);
          
          if (index === -1) {
              groupState.selectedNumbers.push(number);
              this.classList.add('bg-primary', 'text-white');
          } else {
              groupState.selectedNumbers.splice(index, 1);
              this.classList.remove('bg-primary', 'text-white');
          }
      });
  });

  // 胆码按钮点击事件
  damaButtons.forEach(button => {
      // 处理胆码按钮状态切换的函数
      function toggleDamaButton() {
          const dama = parseInt(button.dataset.dama);
          const groupIndex = parseInt(button.dataset.group) - 1;
          const groupState = moduleState.groups[groupIndex];
          const index = groupState.selectedDamas.indexOf(dama);
          
          if (index === -1) {
              groupState.selectedDamas.push(dama);
              button.classList.add('bg-primary', 'text-white');
          } else {
              groupState.selectedDamas.splice(index, 1);
              button.classList.remove('bg-primary', 'text-white');
          }
      }
      
      // 移动端触摸事件处理变量
      let touchStartTime = 0;
      let touchMoved = false;
      let touchHandled = false;
      
      // 添加点击事件（仅在非触摸设备上生效）
      button.addEventListener('click', function(e) {
          // 如果触摸事件已处理，则跳过click事件
          if (touchHandled) {
              touchHandled = false;
              return;
          }
          toggleDamaButton();
      });
      
      // 添加移动端触摸事件处理
      button.addEventListener('touchstart', function(e) {
          touchStartTime = Date.now();
          touchMoved = false;
          touchHandled = false;
          // 添加触摸开始的视觉反馈
          this.style.opacity = '0.7';
      }, { passive: true });
      
      button.addEventListener('touchmove', function(e) {
          touchMoved = true;
          // 移除视觉反馈
          this.style.opacity = '';
      }, { passive: true });
      
      button.addEventListener('touchend', function(e) {
          const touchDuration = Date.now() - touchStartTime;
          // 恢复视觉反馈
          this.style.opacity = '';
          
          // 如果是快速点击且没有移动，则触发状态切换
          if (!touchMoved && touchDuration < 500) {
              touchHandled = true;
              toggleDamaButton();
              // 延迟重置标志，确保click事件被跳过
              setTimeout(() => {
                  touchHandled = false;
              }, 100);
          }
      }, { passive: true });
      
      button.addEventListener('touchcancel', function(e) {
           // 恢复视觉反馈
           this.style.opacity = '';
       }, { passive: true });
   });

  // 条件容错选择事件
  conditionToleranceMinSelects.forEach(select => {
    select.addEventListener('change', function() {
      const groupIndex = parseInt(this.dataset.group) - 1;
      moduleState.groups[groupIndex].toleranceMin = parseInt(this.value);
    });
  });

  conditionToleranceMaxSelects.forEach(select => {
    select.addEventListener('change', function() {
      const groupIndex = parseInt(this.dataset.group) - 1;
      moduleState.groups[groupIndex].toleranceMax = parseInt(this.value);
    });
  });

  // 模块总容错选择事件
  if (moduleToleranceMinSelect) {
    moduleToleranceMinSelect.addEventListener('change', function() {
      moduleState.moduleToleranceMin = parseInt(this.value);
    });
  }

  if (moduleToleranceMaxSelect) {
    moduleToleranceMaxSelect.addEventListener('change', function() {
      moduleState.moduleToleranceMax = parseInt(this.value);
    });
  }

  /***** 核心：按"命中个数"判定（不看位置） *****/
  
  /** 求与开奖号码（前五）相交的命中个数 */
  function countHits(picks, openTop5) {
    const set = new Set(openTop5.map(String));
    let c = 0;
    for (const x of picks) if (set.has(String(x))) c++;
    return c;
  }
  
  /** 条件判定：命中个数在 [minHits, maxHits] 内即通过 */
  function evalHitCondition(picks, openTop5, minHits, maxHits) {
    const k = picks.length;
    // 规范化边界
    const lo = Math.max(0, Math.min(minHits, maxHits));
    const hi = Math.min(k, Math.max(minHits, maxHits));
    const hits = countHits(picks, openTop5);
    const ok = hits >= lo && hits <= hi;
    return { ok, hits, minHits: lo, maxHits: hi, size: k };
  }
  
  /** 组合判定：5 个条件互不干扰，最终必须全部通过 */
  function evalAllConditions(conditions, openTop5) {
    const details = conditions.map(c =>
      evalHitCondition(c.picks, openTop5, c.minHits, c.maxHits)
    );
    return { ok: details.every(d => d.ok), details };
  }
  
  /***** 便捷映射：不同写法统一成命中区间 *****/
  
  /** n胆：mode='atLeast' 表示"至少 n 中"；mode='exact' 表示"恰好 n 中" */
  function mapDanToRange(nDan, picksLen, mode = 'atLeast') {
    if (mode === 'exact') return { minHits: nDan, maxHits: nDan };
    // 默认"至少 n 中"
    return { minHits: nDan, maxHits: picksLen };
  }
  
  /** "错区间"写法（比如 '1-1', '0-2'），转成命中区间
   *  约定：'a-b' 表示"允许错 a 到 b 个"
   *  则命中范围 = [picksLen - b, picksLen - a]
   */
  function mapMissRangeToHits(missRangeStr, picksLen) {
    const [a, b] = missRangeStr.split('-').map(x => parseInt(x, 10));
    const minHits = Math.max(0, picksLen - Math.max(a, b));
    const maxHits = Math.min(picksLen, picksLen - Math.min(a, b));
    return { minHits, maxHits };
  }
  
  // 基于条件数据生成组合的函数
  function generateFromConditions(activeConditions) {
    const results = [];
    const conditionCount = activeConditions.length;
    const minFailures = moduleState.moduleToleranceMin;
    const maxFailures = moduleState.moduleToleranceMax;
    
    // 计算需要满足的条件数量范围
    const minSatisfied = Math.max(0, conditionCount - maxFailures);
    const maxSatisfied = Math.max(0, conditionCount - minFailures);
    
    console.log(`条件总数: ${conditionCount}, 容错范围: ${minFailures}-${maxFailures}`);
    console.log(`需要满足的条件数: ${minSatisfied}-${maxSatisfied}`);
    
    // 生成所有可能的条件组合
    for (let satisfiedCount = minSatisfied; satisfiedCount <= maxSatisfied; satisfiedCount++) {
      if (satisfiedCount === 0 && conditionCount > 0) continue; // 当有条件时，至少要满足一个条件
      
      // 获取所有可能的条件组合
      const conditionCombinations = getCombinations(activeConditions, satisfiedCount);
      
      for (const conditionCombo of conditionCombinations) {
        // 从选中的条件中生成数字组合
        const numberCombinations = generateNumberCombinations(conditionCombo);
        results.push(...numberCombinations);
      }
    }
    
    // 去重并限制结果数量
    const uniqueResults = [...new Set(results.map(r => r.join(',')))];
    console.log(`生成组合数: ${uniqueResults.length}`);
    
    return uniqueResults.slice(0, 10000).map(r => r.split(',').map(Number)); // 限制最多10000个结果
  }
  
  // 获取数组的所有组合
  function getCombinations(arr, count) {
    if (count === 0) return [[]];
    if (count > arr.length) return [];
    if (count === arr.length) return [arr];
    
    const result = [];
    for (let i = 0; i <= arr.length - count; i++) {
      const head = arr[i];
      const tailCombos = getCombinations(arr.slice(i + 1), count - 1);
      for (const tail of tailCombos) {
        result.push([head, ...tail]);
      }
    }
    return result;
  }
  
  // 从条件组合中生成数字组合
  function generateNumberCombinations(conditions) {
    const results = [];
    
    // 收集所有条件的数字
    const allConditionNumbers = conditions.map(condition => {
      return condition.selectedNumbers.length > 0 ? condition.selectedNumbers : [1,2,3,4,5,6,7,8,9,10];
    });
    
    // 生成笛卡尔积
    function cartesianProduct(arrays) {
      if (arrays.length === 0) return [[]];
      if (arrays.length === 1) return arrays[0].map(x => [x]);
      
      const result = [];
      const firstArray = arrays[0];
      const restProduct = cartesianProduct(arrays.slice(1));
      
      for (const first of firstArray) {
        for (const rest of restProduct) {
          const combination = [first, ...rest];
          if (combination.length === 5 && new Set(combination).size === 5) {
            // 确保是5个不重复的数字
            result.push(combination.sort((a, b) => a - b));
          }
        }
      }
      return result;
    }
    
    // 如果条件数少于5个，需要补充其他数字
    if (conditions.length < 5) {
      const usedNumbers = new Set();
      conditions.forEach(condition => {
        condition.selectedNumbers.forEach(num => usedNumbers.add(num));
      });
      
      const remainingNumbers = [1,2,3,4,5,6,7,8,9,10].filter(num => !usedNumbers.has(num));
      const needMore = 5 - conditions.length;
      
      // 从剩余数字中选择需要的数量
      const additionalCombos = getCombinations(remainingNumbers, needMore);
      
      for (const condition of conditions) {
        for (const num of condition.selectedNumbers) {
          for (const additional of additionalCombos) {
            const combination = [num, ...additional].sort((a, b) => a - b);
            if (combination.length === 5 && new Set(combination).size === 5) {
              results.push(combination);
            }
          }
        }
      }
    } else {
      // 如果条件数>=5，直接从每个条件中选一个数字
      const cartesianResults = cartesianProduct(allConditionNumbers);
      results.push(...cartesianResults);
    }
    
    return results;
  }
  
  // 条件评估函数（适配现有接口）
  function evaluateCondition(condition, resultNums) {
    // 如果条件为空，应该不参与评估
    if (condition.selectedNumbers.length === 0 && condition.selectedDamas.length === 0) {
      return { ok: true, errors: 0 };
    }
    
    const picks = condition.selectedNumbers;
    const picksLen = picks.length;
    
    // 计算实际命中个数
    const actualHitCount = countHits(picks, resultNums);
    
    if (condition.selectedDamas.length === 0) {
      // 未选择命中胆码数：如果选择了胆码数字但没有选择命中胆码数，则不通过筛选
      // 这种情况下用户需要明确指定命中几个胆码才能进行筛选
      return {
        ok: false,
        errors: picksLen - actualHitCount,
        hitCount: actualHitCount
      };
    }
    
    // 已选择命中胆码数：检查实际命中数是否在选中的胆码数范围内
    // 胆码逻辑：选择1234作为胆码，命中胆码数选3-4时，筛选包含1234中任意3个或4个的号码
    
    // 检查实际命中数是否在选中的胆码数列表中
    const isValidHitCount = condition.selectedDamas.includes(actualHitCount);
    
    if (!isValidHitCount) {
      // 如果命中数不在选中的胆码数中，检查容错
      // 容错X-Y表示：允许X到Y个胆码数条件不成立
      const toleranceMin = condition.toleranceMin;
      const toleranceMax = condition.toleranceMax;
      
      // 计算不成立的条件数（这里是1，因为实际命中数不在选中范围内）
      const unsatisfiedCount = 1;
      
      // 判断是否在容错范围内
      const isValid = unsatisfiedCount >= toleranceMin && unsatisfiedCount <= toleranceMax;
      
      return {
        ok: isValid,
        errors: picksLen - actualHitCount,
        hitCount: actualHitCount
      };
    }
    
    // 命中数在选中的胆码数中，条件成立
    const isValid = true;
    
    return {
      ok: isValid,
      errors: picksLen - actualHitCount,
      hitCount: actualHitCount
    };
  }  
  // 评估所有条件（适配现有接口）
  function evaluateAll(conditions, resultNums) {
    // 只评估有设置的条件（选择了数字或胆码的条件）
    const activeConditions = conditions.filter(c => 
      c.selectedNumbers.length > 0 || c.selectedDamas.length > 0
    );
    
    // 如果没有任何活跃条件，返回true（通过筛选，生成所有组合）
    if (activeConditions.length === 0) {
      return { ok: true, details: [], failedCount: 0, moduleToleranceRange: [moduleState.moduleToleranceMin, moduleState.moduleToleranceMax] };
    }
    
    const details = activeConditions.map(c => evaluateCondition(c, resultNums));
    
    // 应用模块总容错逻辑
    // 统计不成立的条件数量
    const failedConditionsCount = details.filter(d => !d.ok).length;
    
    // 检查失败的条件数是否在允许的容错范围内
    const moduleToleranceOk = failedConditionsCount >= moduleState.moduleToleranceMin && 
                             failedConditionsCount <= moduleState.moduleToleranceMax;
    
    return { 
      ok: moduleToleranceOk, 
      details,
      failedCount: failedConditionsCount,
      moduleToleranceRange: [moduleState.moduleToleranceMin, moduleState.moduleToleranceMax]
    };
  }

  // 做号按钮点击事件
  generateBtn.addEventListener('click', function() {
    // 获取有数据的条件
    const activeConditions = moduleState.groups.filter(g => 
      g.selectedNumbers.length > 0 || g.selectedDamas.length > 0
    );
    
    let filteredResults = [];
    
    // 如果没有活跃条件，生成所有可能的排列
    if (activeConditions.length === 0) {
      console.log('没有活跃条件，生成所有排列');
      const allNumbers = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10];
      const permutations = permute(allNumbers, 5);
      console.log(`生成排列数: ${permutations.length}`);
      filteredResults = permutations;
    }
    // 有活跃条件时，使用筛选逻辑
    else {
      console.log('有活跃条件，使用筛选逻辑');
      console.log('活跃条件:', activeConditions);
      
      const allNumbers = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10];
      const permutations = permute(allNumbers, 5);
      
      // 存储所有排列组合
      moduleState.allPermutations = permutations;
      
      // 根据选中的数字、胆码和容错筛选结果
      filteredResults = permutations.filter(comb => {
          // 使用容错评估逻辑
          const evaluation = evaluateAll(moduleState.groups, comb);
          
          // 调试信息：输出前几个组合的评估结果
          if (permutations.indexOf(comb) < 5) {
            console.log(`组合 ${comb.join(',')} 评估结果:`, {
              ok: evaluation.ok,
              failedCount: evaluation.failedCount,
              moduleToleranceRange: evaluation.moduleToleranceRange,
              details: evaluation.details.map(d => ({ ok: d.ok, hitCount: d.hitCount }))
            });
          }
          
          return evaluation.ok;
      });
    }
    
    // 调试信息：输出筛选统计
    console.log(`模块总容错设置: ${moduleState.moduleToleranceMin}-${moduleState.moduleToleranceMax}`);
    console.log(`活跃条件数: ${moduleState.groups.filter(g => g.selectedNumbers.length > 0 || g.selectedDamas.length > 0).length}`);
    console.log(`筛选结果: ${filteredResults.length}`);
    
    // 调试信息：输出最终结果
    console.log(`最终筛选结果数量: ${filteredResults.length}`);
    
    // 首次生成时就按照格式化逻辑处理并存储为字符串
    const formattedResults = filteredResults.map(comb => 
        comb.map(num => num.toString().padStart(2, '0')).join(' ')
    );
    
    console.log(`格式化后结果数量: ${formattedResults.length}`);
    

    
    moduleState.results = formattedResults;
    moduleState.originalResults = [...formattedResults]; // 保存原始结果
    moduleState.isReversed = false;
    
    updateResultDisplay();
  });

  // 复制按钮点击事件
  copyBtn.addEventListener('click', function() {
    if (moduleState.results.length === 0) {
      // 修改无结果提示为文本显示
      resultCount.innerHTML = '<span style="color: red;">没有可复制的结果</span>';
      setTimeout(() => {
        resultCount.textContent = `共${moduleState.results.length}注`;
      }, 2000);
      return;
    }
    
    // 复制存储的筛选结果 - 组内空格，组间逗号
    // moduleState.results中每个元素已经是格式化的字符串（如"01 02 03 04 05"）
    // 直接用逗号连接即可得到正确格式
    let textToCopy = '';
    for (let i = 0; i < moduleState.results.length; i++) {
      if (i > 0) textToCopy += ',';
      textToCopy += moduleState.results[i];
    }

    // 复制到剪贴板
    navigator.clipboard.writeText(textToCopy).then(() => {
      // 复制成功后显示红色的已复制提示
      resultCount.innerHTML = `共${moduleState.results.length}注 <span style="color: red;">已复制${moduleState.results.length}注</span>`;
    }).catch(err => {
      console.error('复制失败:', err);
      // 错误提示：显示红色错误文本
      resultCount.innerHTML = '<span style="color: red;">复制失败，请手动复制</span>';
      setTimeout(() => {
        resultCount.textContent = `共${moduleState.results.length}注`;
      }, 2000);
    });
    });

  // 清除按钮点击事件
  clearBtn.addEventListener('click', function() {
    // 修复：按组清除选中状态
    moduleState.groups.forEach(group => {
        group.selectedNumbers = [];
        group.selectedDamas = [];
    });
    moduleState.results = [];
    moduleState.originalResults = [];
    moduleState.isReversed = false;
    
    // 清除所有按钮选中状态
    numberButtons.forEach(btn => btn.classList.remove('bg-primary', 'text-white'));
    damaButtons.forEach(btn => btn.classList.remove('bg-primary', 'text-white'));
    
    // 清除结果显示
    resultInput.value = '';
    resultCount.textContent = '共0注';
  });

  // 反向按钮点击事件 - 修改为显示筛选结果的补集
  reverseBtn.addEventListener('click', function() {
    // 检查是否已生成结果
    if (moduleState.allPermutations.length === 0 || moduleState.originalResults.length === 0) {
      alert('请先点击"做号"生成结果');
      return;
    }

    // 切换反向状态
    if (!moduleState.isReversed) {
      // 生成原始结果的补集（所有组合中排除原始结果）
      // 创建原始结果的字符串表示集合用于快速查找
      const originalSet = new Set(moduleState.originalResults);
      // 筛选出不在原始结果中的所有组合，并格式化
      const complementResults = moduleState.allPermutations
        .filter(comb => {
          const formattedComb = comb.map(num => num.toString().padStart(2, '0')).join(' ');
          return !originalSet.has(formattedComb);
        })
        .map(comb => comb.map(num => num.toString().padStart(2, '0')).join(' '));
      moduleState.results = complementResults;
      moduleState.isReversed = true;
    } else {
      // 恢复显示原始结果
      moduleState.results = moduleState.originalResults;
      moduleState.isReversed = false;
    }

    updateResultDisplay();
  });



  // 更新结果显示 - 版本2024.12.19
  function updateResultDisplay() {
    const totalCount = moduleState.results.length;
    const displayResults = totalCount > 200 ? moduleState.results.slice(0, 200) : moduleState.results;
    // 结果已经是格式化的字符串，直接用逗号连接（逗号后不加空格）
    let displayText = '';
    for (let i = 0; i < displayResults.length; i++) {
      if (i > 0) displayText += ',';
      displayText += displayResults[i];
    }
    
    // 立即设置结果
    resultInput.value = totalCount > 200 ? displayText + '...' : displayText;
    resultCount.textContent = `共${totalCount}注`;
    
    // 延迟再次确保格式正确（防止被其他代码覆盖）
    setTimeout(() => {
      resultInput.value = totalCount > 200 ? displayText + '...' : displayText;
    }, 10);
    

  }
}

// 页面加载时初始化现有模块
document.addEventListener('DOMContentLoaded', function() {
  // 初始化模块1和模块2
  if (!window.moduleStates || !window.moduleStates[1]) {
    initFiveStarModule(1);
  }
  if (!window.moduleStates || !window.moduleStates[2]) {
    initFiveStarModule(2);
  }
});


// 旧的模块初始化函数已被新的 initFiveStarModule 函数替代

// 添加模块功能
function addModule(currentModuleId) {
  const modulesContainer = document.getElementById('modules-container');
  const moduleElements = modulesContainer.querySelectorAll('.five-star-module');

  // 检查模块数量上限（最多14个）
  if (moduleElements.length >= 14) {
    alert('最多只能添加14个模块');
    return;
  }

  // 获取最后一个模块ID并递增
  const lastModuleId = parseInt(moduleElements[moduleElements.length - 1].id.replace('module', ''));
  const newModuleId = lastModuleId + 1;

  // 克隆当前模块
  const currentModule = document.getElementById(`module${currentModuleId}`);
  const newModule = currentModule.cloneNode(true);
  newModule.id = `module${newModuleId}`;
  newModule.querySelectorAll('[data-module]').forEach(el => {
    el.dataset.module = newModuleId;
  });
  resetModuleState(newModule);

  // 克隆当前模块后添加以下代码
  const newAddBtn = newModule.querySelector('.add-btn');
  newAddBtn.setAttribute('onclick', `addModule(${newModuleId})`);

  const newRemoveBtn = newModule.querySelector('.remove-btn');
  newRemoveBtn.setAttribute('onclick', `removeModule(${newModuleId})`);

  // 添加到容器
  modulesContainer.appendChild(newModule);
  
  // 初始化新模块
  initFiveStarModule(newModuleId);
}

// 移除模块功能
function removeModule(moduleId) {
  const modulesContainer = document.getElementById('modules-container');
  const moduleElements = modulesContainer.querySelectorAll('.five-star-module');
  const moduleToRemove = document.getElementById(`module${moduleId}`);
  
  if (moduleElements.length <= 2) {
    alert('至少保留2个模块');
    return;
  }
  
  moduleToRemove.remove();
}

// 重置模块状态
function resetModuleState(module) {
  // 重置按钮状态
  module.querySelectorAll('.number-btn, .dama-btn').forEach(btn => {
    btn.classList.remove('bg-primary', 'text-white');
  });
  
  // 重置输入和显示
  module.querySelector('.result-input').value = '';
  module.querySelector('.result-count').textContent = '共0注';
  
  // 重置模块总容错为默认值0-0
  const toleranceMinSelect = module.querySelector('.module-tolerance-min');
  const toleranceMaxSelect = module.querySelector('.module-tolerance-max');
  if (toleranceMinSelect) toleranceMinSelect.value = '0';
  if (toleranceMaxSelect) toleranceMaxSelect.value = '0';
}

// 重复的permute函数已删除，使用上面的迭代版本

// Tailwind配置
tailwind.config = {
  theme: {
    extend: {
      colors: {
        primary: '#d62828',
        secondary: '#f77f00',
        neutral: '#f5f5f5',
        dark: '#333333'
      },
      fontFamily: {
        sans: ['Inter', 'system-ui', 'sans-serif']
      }
    }
  }
};

// 页面切换功能
document.addEventListener('DOMContentLoaded', function() {
  const dataAnalysisBtn = document.getElementById('dataAnalysisBtn');
  const fiveStarBtn = document.getElementById('fiveStarBtn');
  const goldenRatioBtn = document.getElementById('goldenRatioBtn');
  const dataAnalysisPage = document.getElementById('dataAnalysisPage');
  const fiveStarPage = document.getElementById('fiveStarPage');
  const goldenRatioPage = document.getElementById('goldenRatioPage');
  
  // 滚动位置保存和恢复功能
  const scrollPositions = {
    dataAnalysis: 0,
    fiveStar: 0,
    goldenRatio: 0
  };
  
  // 保存当前页面的滚动位置
  function saveScrollPosition(pageType) {
    scrollPositions[pageType] = window.pageYOffset || document.documentElement.scrollTop;
  }
  
  // 恢复指定页面的滚动位置
  function restoreScrollPosition(pageType) {
    // 使用requestAnimationFrame确保在下一帧渲染时恢复滚动位置，避免卡顿
    requestAnimationFrame(() => {
      window.scrollTo({
        top: scrollPositions[pageType],
        behavior: 'instant' // 使用instant避免滚动动画
      });
    });
  }
  
  // 获取当前显示的页面类型
  function getCurrentPageType() {
    if (!dataAnalysisPage.classList.contains('hidden')) return 'dataAnalysis';
    if (!fiveStarPage.classList.contains('hidden')) return 'fiveStar';
    if (!goldenRatioPage.classList.contains('hidden')) return 'goldenRatio';
    return 'dataAnalysis'; // 默认
  }

  if (dataAnalysisBtn && fiveStarBtn && goldenRatioBtn && dataAnalysisPage && fiveStarPage && goldenRatioPage) {
    dataAnalysisBtn.addEventListener('click', function() {
      // 禁用滚动监听，防止页面切换时跳动
      disableScrollListener();
      
      // 保存当前页面的滚动位置
      const currentPage = getCurrentPageType();
      saveScrollPosition(currentPage);
      
      // 切换页面
      dataAnalysisPage.classList.remove('hidden');
      fiveStarPage.classList.add('hidden');
      goldenRatioPage.classList.add('hidden');
      dataAnalysisBtn.classList.add('bg-primary');
      dataAnalysisBtn.classList.remove('bg-gray-600');
      fiveStarBtn.classList.add('bg-gray-600');
      fiveStarBtn.classList.remove('bg-primary');
      goldenRatioBtn.classList.add('bg-gray-600');
      goldenRatioBtn.classList.remove('bg-primary');
      
      // 恢复数据分析页面的滚动位置
      restoreScrollPosition('dataAnalysis');
    });
    
    fiveStarBtn.addEventListener('click', function() {
      // 禁用滚动监听，防止页面切换时跳动
      disableScrollListener();
      
      // 保存当前页面的滚动位置
      const currentPage = getCurrentPageType();
      saveScrollPosition(currentPage);
      
      // 切换页面
      dataAnalysisPage.classList.add('hidden');
      fiveStarPage.classList.remove('hidden');
      goldenRatioPage.classList.add('hidden');
      fiveStarBtn.classList.add('bg-primary');
      fiveStarBtn.classList.remove('bg-gray-600');
      dataAnalysisBtn.classList.add('bg-gray-600');
      dataAnalysisBtn.classList.remove('bg-primary');
      goldenRatioBtn.classList.add('bg-gray-600');
      goldenRatioBtn.classList.remove('bg-primary');
      
      // 恢复五星做号页面的滚动位置
      restoreScrollPosition('fiveStar');
    });
    
    goldenRatioBtn.addEventListener('click', function() {
      // 禁用滚动监听，防止页面切换时跳动
      disableScrollListener();
      
      // 保存当前页面的滚动位置
      const currentPage = getCurrentPageType();
      saveScrollPosition(currentPage);
      
      // 切换页面
      dataAnalysisPage.classList.add('hidden');
      fiveStarPage.classList.add('hidden');
      goldenRatioPage.classList.remove('hidden');
      goldenRatioBtn.classList.add('bg-primary');
      goldenRatioBtn.classList.remove('bg-gray-600');
      dataAnalysisBtn.classList.add('bg-gray-600');
      dataAnalysisBtn.classList.remove('bg-primary');
      fiveStarBtn.classList.add('bg-gray-600');
      fiveStarBtn.classList.remove('bg-primary');
      
      // 恢复黄金切割页面的滚动位置
      restoreScrollPosition('goldenRatio');
    });
  } else {
    console.error('页面切换所需元素未找到');
  }
  
  // 手机端上滑全屏功能
  let lastScrollY = 0;
  let isFullscreen = false;
  let scrollTimeout = null;
  
  // 检测是否为手机端
  function isMobile() {
    return window.innerWidth <= 768;
  }
  
  // 切换全屏模式
  function toggleFullscreen(enable) {
    if (!isMobile()) return;
    
    const header = document.querySelector('header');
    const titleArea = header.querySelector('.container');
    const toolbarArea = header.querySelector('.bg-gray-800');
    const keyCountdown = document.getElementById('keyCountdown');
    
    if (enable && !isFullscreen) {
      // 进入全屏模式
      isFullscreen = true;
      
      // 隐藏标题区域
      if (titleArea) {
        titleArea.style.transform = 'translateY(-100%)';
        titleArea.style.transition = 'transform 0.3s ease-in-out';
      }
      
      // 隐藏密钥倒计时栏（完全隐藏并释放空间）
      if (keyCountdown && !keyCountdown.classList.contains('hidden')) {
        keyCountdown.style.height = '0';
        keyCountdown.style.opacity = '0';
        keyCountdown.style.paddingTop = '0';
        keyCountdown.style.paddingBottom = '0';
        keyCountdown.style.overflow = 'hidden';
        keyCountdown.style.transition = 'all 0.3s ease-in-out';
      }
      
      // 调整工具栏位置到顶部
      if (toolbarArea) {
        toolbarArea.style.position = 'fixed';
        toolbarArea.style.top = '0';
        toolbarArea.style.left = '0';
        toolbarArea.style.right = '0';
        toolbarArea.style.zIndex = '1000';
        toolbarArea.style.transition = 'all 0.3s ease-in-out';
      }
      
      // 调整主内容区域的上边距
      const main = document.querySelector('main');
      if (main) {
        main.style.paddingTop = '50px'; // 工具栏高度
        main.style.transition = 'padding-top 0.3s ease-in-out';
      }
      
    } else if (!enable && isFullscreen) {
      // 退出全屏模式
      isFullscreen = false;
      
      // 显示标题区域
      if (titleArea) {
        titleArea.style.transform = 'translateY(0)';
      }
      
      // 显示密钥倒计时栏（恢复原始高度和样式）
      if (keyCountdown && !keyCountdown.classList.contains('hidden')) {
        keyCountdown.style.height = 'auto';
        keyCountdown.style.opacity = '1';
        keyCountdown.style.paddingTop = '0.5rem';
        keyCountdown.style.paddingBottom = '0.5rem';
        keyCountdown.style.overflow = 'visible';
        keyCountdown.style.transition = 'all 0.3s ease-in-out';
      }
      
      // 恢复工具栏位置
      if (toolbarArea) {
        toolbarArea.style.position = '';
        toolbarArea.style.top = '';
        toolbarArea.style.left = '';
        toolbarArea.style.right = '';
        toolbarArea.style.zIndex = '';
      }
      
      // 恢复主内容区域的上边距
      const main = document.querySelector('main');
      if (main) {
        main.style.paddingTop = '';
      }
    }
  }
  
  // 滚动事件监听
  function handleScroll() {
    if (!isMobile()) return;
    
    const currentScrollY = window.pageYOffset || document.documentElement.scrollTop;
    const scrollDelta = currentScrollY - lastScrollY;
    
    // 清除之前的定时器
    if (scrollTimeout) {
      clearTimeout(scrollTimeout);
    }
    
    // 设置新的定时器，延迟执行以避免频繁切换
    scrollTimeout = setTimeout(() => {
      // 向上滑动且滑动距离超过50px时进入全屏
      if (scrollDelta < -50 && currentScrollY > 100) {
        toggleFullscreen(true);
      }
      // 向下滑动且滑动距离超过30px时退出全屏
      // 或者滚动到页面顶部附近时也退出全屏
      else if (scrollDelta > 30 || currentScrollY < 50) {
        toggleFullscreen(false);
      }
    }, 150); // 增加延迟时间，减少误触发
    
    lastScrollY = currentScrollY;
  }
  
  // 添加滚动事件监听器
  window.addEventListener('scroll', handleScroll, { passive: true });
  
  // 为工具栏按钮添加点击事件监听，防止误触发全屏
  const toolbarButtons = document.querySelectorAll('.bg-gray-800 button');
  toolbarButtons.forEach(button => {
    button.addEventListener('click', () => {
      // 点击按钮时暂时禁用滚动检测
      if (scrollTimeout) {
        clearTimeout(scrollTimeout);
      }
      // 短暂延迟后重新启用滚动检测
      setTimeout(() => {
        lastScrollY = window.pageYOffset || document.documentElement.scrollTop;
      }, 300);
    });
  });
  
  // 窗口大小改变时重置全屏状态
  window.addEventListener('resize', () => {
    if (!isMobile() && isFullscreen) {
      toggleFullscreen(false);
    }
  });
});

// 重复的初始化代码已移除
let r=[],i=1,a=null,s=null,d=new Set,u=null,l=null,m=!1,f=15,y=!1,currentPage=1,pageSize=50,totalPages=1;

// 多重加密验证状态系统
let _0x1a2b3c = false;
let _0x4d5e6f = null;
let _0x7g8h9i = [];
let _0x0j1k2l = new Date().getTime();
let _0x3m4n5o = 'aGVsbG93b3JsZA==';
let _0x9p8q7r = Math.random().toString(36).substring(2);
let _0x5s6t7u = btoa(window.location.href).slice(-10);

// 验证令牌生成和检查系统
function _0xVerifyToken() {
    // 检查认证版本号
    const storedVersion = localStorage.getItem('authVersion');
    if (storedVersion !== AUTH_VERSION) {
        console.log('认证版本不匹配，需要重新验证');
        return false;
    }
    
    const _0xTime = new Date().getTime();
    const _0xDiff = _0xTime - _0x0j1k2l;
    if (_0xDiff > 3600000) return false; // 1小时过期
    
    const _0xHash = btoa(String.fromCharCode(..._0x7g8h9i));
    const _0xCheck = _0x4d5e6f && _0x1a2b3c && _0xHash.length > 0;
    
    // 额外的完整性检查
    const _0xIntegrity = _0x9p8q7r.length > 5 && _0x5s6t7u.length > 5;
    
    return _0xCheck && _0xIntegrity;
}

// 认证版本号 - 更新此值可使所有旧认证失效
const AUTH_VERSION = '2025_01_22_v3';

// 设置验证状态
function _0xSetAuth(_0xToken) {
    _0x1a2b3c = true;
    _0x4d5e6f = _0xToken;
    _0x7g8h9i = Array.from(_0xToken).map(c => c.charCodeAt(0));
    _0x0j1k2l = new Date().getTime();
    _0x9p8q7r = btoa(_0xToken).slice(0, 10);
    // 保存认证版本号
    localStorage.setItem('authVersion', AUTH_VERSION);
    _0xStartTimer(); // 启动定时验证
}

// 验证检查包装器
function _0xAuthCheck() {
    if (!_0xIntegrityCheck()) return false;
    if (!_0xAntiDebug()) {
        _0x1a2b3c = 0;
        return false;
    }
    if (!_0xVerifyToken()) {
        return false;
    }
    return true;
}

// 假的验证逻辑 - 陷阱代码
let fakeAuth = false;
function enableFakeAuth() { fakeAuth = true; }
function checkFakeAuth() { return fakeAuth; }
function validateLicense() { return Math.random() > 0.5; }
function isValidUser() { return localStorage.getItem('user') === 'valid'; }

// 反调试检查
function _0xAntiDebug() {
    const start = performance.now();
    debugger;
    const end = performance.now();
    return (end - start) < 100;
}

// 动态验证码生成
function _0xDynamicCode() {
    const timestamp = Date.now();
    const random = Math.floor(Math.random() * 1000000);
    return btoa(timestamp + ':' + random + ':' + _0x1a2b3c);
}

// 定时验证检查
// 定时验证机制 - 只有在用户已验证后才启动
let _0xTimerStarted = false;
function _0xStartTimer() {
    if (_0xTimerStarted) return;
    _0xTimerStarted = true;
    setInterval(() => {
        if (_0x1a2b3c && !_0xAuthCheck()) {
            document.body.innerHTML = '<div style="text-align:center;padding:50px;color:red;">验证失效，请重新加载页面</div>';
            setTimeout(() => location.reload(), 2000);
        }
    }, 30000); // 每30秒检查一次
}

// 代码完整性检查
function _0xIntegrityCheck() {
    const _0xFuncs = [_0xVerifyToken, _0xSetAuth, _0xAuthCheck];
    for (let _0xFunc of _0xFuncs) {
        if (typeof _0xFunc !== 'function') {
            document.body.innerHTML = '<div style="text-align:center;padding:50px;color:red;">系统检测到异常，请刷新页面</div>';
            return false;
        }
    }
    return true;
}

// 兼容性变量（保持原有功能）
let b = false;const h="pk4_access_key",g=document.getElementById("keyModal"),p=document.getElementById("keyInput"),v=document.getElementById("output"),x=document.getElementById("tableContainer"),w=document.getElementById("horizontalThumb"),k=document.getElementById("horizontalFill"),$=document.getElementById("verticalSlider"),B=document.getElementById("verticalThumb"),I=document.getElementById("verticalFill"),M=document.getElementById("numButtons");for(let t=1;t<=10;t++){const e=document.createElement("button");e.className="px-3 py-1 rounded-md bg-gray-200 btn-hover",e.dataset.num=t,e.textContent=t,M.appendChild(e)}const S=document.getElementById("hitButtons");function N(t){t.forEach(e=>e.addEventListener("click",()=>{t.forEach(t=>t.classList.remove("btn-active")),e.classList.add("btn-active"),L()}))}function C(t){t.forEach(t=>t.addEventListener("click",()=>{t.classList.toggle("btn-active"),L()}))}[0,1,2,3,4,5].forEach(t=>{const e=document.createElement("button");e.className="px-3 py-1 rounded-md bg-gray-200 btn-hover",e.dataset.hit=t,e.textContent=t+"胆",S.appendChild(e)}),document.querySelector('#numButtons button[data-num="5"]').classList.add("btn-active"),document.querySelector('#hitButtons button[data-hit="2"]').classList.add("btn-active"),N(Array.from(M.children)),C(Array.from(S.children));

// 位置选择按钮事件处理
const positionButtons = document.querySelectorAll('.position-btn');
C(Array.from(positionButtons));

let T=null;function D(t){const e=document.getElementById("keyCountdown"),n=document.getElementById("timeRemaining");function o(){const o=new Date,c=new Date(1e3*t)-o;if(c<=0){n.textContent="已过期",e.classList.remove("bg-primary","bg-amber-500"),e.classList.add("bg-red-500"),clearInterval(T);const t=Y();return localStorage.removeItem(`validKey_${t}`),localStorage.removeItem(`keyExpiry_${t}`),b=!1,void setTimeout(()=>{window.location.reload()},3e3)}const r=Math.floor(c/864e5),i=Math.floor(c%864e5/36e5),a=Math.floor(c%36e5/6e4),s=Math.floor(c%6e4/1e3);n.textContent=`${r}天 ${i}小时 ${a}分钟 ${s}秒`;const d=24*r+i;d<=24?(e.classList.remove("bg-primary","bg-amber-500"),e.classList.add("bg-red-500")):d<=72?(e.classList.remove("bg-primary","bg-red-500"),e.classList.add("bg-amber-500")):(e.classList.remove("bg-amber-500","bg-red-500"),e.classList.add("bg-primary"))}T&&clearInterval(T),o(),e.classList.remove("hidden"),T=setInterval(o,1e3)}function generateDeviceFingerprint(){
  // 使用固定的通用指纹，允许密钥在任何设备上使用
  // 这样可以确保密钥的跨设备兼容性
    return 'universal_device_2024';
 }

// 记录密钥使用到服务器
async function recordKeyUsage(keyData) {
    try {
        const deviceId = generateDeviceFingerprint();
        const keyRecord = {
            keyId: keyData.nonce,
            deviceId: deviceId,
            usedAt: new Date().toISOString(),
            expiresAt: new Date(keyData.expiry * 1000).toISOString(),
            userAgent: navigator.userAgent
        };
        
        // 记录到Vercel生产环境
        const response = await fetch(`https://myyz.vercel.app/api/key-records`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'User-Agent': 'TWPK-KeyValidator/1.0'
            },
            body: JSON.stringify(keyRecord)
        });
        
        if (response.ok) {
            const result = await response.json();
            console.log('密钥使用记录已保存到服务器:', result);
            return { success: true, data: result };
        } else {
            throw new Error(`服务器响应错误: ${response.status} ${response.statusText}`);
        }
    } catch (error) {
        console.error('记录密钥使用信息失败:', error);
        return { success: false, error: error.message };
    }
}

async function O(t){try{const e=await fetch(`https://myyz.vercel.app/api/nonce/check/${encodeURIComponent(t)}`,{method:"GET",headers:{"User-Agent":"TWPK-KeyValidator/1.0"}});if(e.ok){const t=await e.json();return console.log("云端验证响应:",t),{used:t.used}}}catch(e){console.warn("API连接失败:",e);}console.warn("API连接失败，使用本地验证");return{used:JSON.parse(localStorage.getItem("usedNonces")||"[]").includes(t)}}async function K(t){try{const e=await fetch(`https://myyz.vercel.app/api/nonce/mark`,{method:"POST",headers:{"Content-Type":"application/json","User-Agent":"TWPK-KeyValidator/1.0"},body:JSON.stringify({nonce:t})});if(e.ok){const t=await e.json();return console.log("nonce已成功记录到云端:",t),{success:!0}}}catch(e){console.warn("API连接失败:",e);}console.warn("API连接失败，使用本地记录");const e=JSON.parse(localStorage.getItem("usedNonces")||"[]");return e.includes(t)||(e.push(t),localStorage.setItem("usedNonces",JSON.stringify(e)),console.log("本地记录nonce:",t)),{success:!0}}const P=document.getElementById("verifyKeyBtn");function E(t){let e;if(t.includes("\t"))e=t.trim().split(/\t+/);else{if(!t.includes(" "))return null;e=t.trim().split(/\s+/)}if(e.length<2)return null;const n=e[0].trim();let o;if(e[1].includes(","))o=e[1].split(",").map(t=>parseInt(t.trim(),10));else{if(!e[1].includes(" "))return null;o=e[1].split(" ").map(t=>parseInt(t.trim(),10))}return 10!==o.length||o.some(isNaN)?null:{period:n,data:o}}// Base62 解码函数
function base62Decode(str) {
    const chars = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz';
    const base = BigInt(chars.length);
    let result = BigInt(0);
    
    for (let i = 0; i < str.length; i++) {
        const char = str[i];
        const index = chars.indexOf(char);
        if (index === -1) {
            throw new Error('Invalid Base62 character: ' + char);
        }
        result = result * base + BigInt(index);
    }
    
    // 转换为16字节的Uint8Array
    const bytes = new Uint8Array(16);
    for (let i = 15; i >= 0; i--) {
        bytes[i] = Number(result & BigInt(0xFF));
        result = result >> BigInt(8);
    }
    
    return bytes;
}

// 简化的PBKDF2-HMAC-SHA256实现
// 检查crypto.subtle API支持
function isCryptoSubtleSupported() {
    return typeof crypto !== 'undefined' && 
           typeof crypto.subtle !== 'undefined' && 
           typeof crypto.subtle.importKey === 'function';
}

// PBKDF2-HMAC-SHA256实现（Web Crypto API版本）
async function pbkdf2WebCrypto(password, salt, iterations, keyLength) {
    const encoder = new TextEncoder();
    const passwordKey = await crypto.subtle.importKey(
        'raw',
        encoder.encode(password),
        { name: 'PBKDF2' },
        false,
        ['deriveBits']
    );
    
    const derivedBits = await crypto.subtle.deriveBits(
        {
            name: 'PBKDF2',
            salt: salt,
            iterations: iterations,
            hash: 'SHA-256'
        },
        passwordKey,
        keyLength * 8
    );
    
    return new Uint8Array(derivedBits);
}

// PBKDF2-HMAC-SHA256降级实现（纯JavaScript）
async function pbkdf2Fallback(password, salt, iterations, keyLength) {
    // 简化的HMAC-SHA256实现
    async function hmacSha256(key, data) {
        const keyBytes = typeof key === 'string' ? new TextEncoder().encode(key) : key;
        const dataBytes = typeof data === 'string' ? new TextEncoder().encode(data) : data;
        
        // 使用crypto.subtle.digest作为SHA256（如果可用）
        if (typeof crypto !== 'undefined' && typeof crypto.subtle !== 'undefined' && typeof crypto.subtle.digest === 'function') {
            const blockSize = 64; // SHA256 block size
            let keyPadded = new Uint8Array(blockSize);
            
            if (keyBytes.length > blockSize) {
                const hashedKey = await crypto.subtle.digest('SHA-256', keyBytes);
                keyPadded.set(new Uint8Array(hashedKey));
            } else {
                keyPadded.set(keyBytes);
            }
            
            const oKeyPad = new Uint8Array(blockSize);
            const iKeyPad = new Uint8Array(blockSize);
            
            for (let i = 0; i < blockSize; i++) {
                oKeyPad[i] = keyPadded[i] ^ 0x5c;
                iKeyPad[i] = keyPadded[i] ^ 0x36;
            }
            
            const innerData = new Uint8Array(iKeyPad.length + dataBytes.length);
            innerData.set(iKeyPad);
            innerData.set(dataBytes, iKeyPad.length);
            
            const innerHash = await crypto.subtle.digest('SHA-256', innerData);
            
            const outerData = new Uint8Array(oKeyPad.length + innerHash.byteLength);
            outerData.set(oKeyPad);
            outerData.set(new Uint8Array(innerHash), oKeyPad.length);
            
            const finalHash = await crypto.subtle.digest('SHA-256', outerData);
            return new Uint8Array(finalHash);
        } else {
            // 如果连digest都不支持，使用更简单的哈希
            throw new Error('浏览器不支持加密API，请使用现代浏览器');
        }
    }
    
    const passwordBytes = new TextEncoder().encode(password);
    const saltBytes = new Uint8Array(salt);
    
    let result = new Uint8Array(keyLength);
    let blockIndex = 1;
    let resultOffset = 0;
    
    while (resultOffset < keyLength) {
        // 创建块索引的字节表示
        const blockIndexBytes = new Uint8Array(4);
        blockIndexBytes[0] = (blockIndex >>> 24) & 0xFF;
        blockIndexBytes[1] = (blockIndex >>> 16) & 0xFF;
        blockIndexBytes[2] = (blockIndex >>> 8) & 0xFF;
        blockIndexBytes[3] = blockIndex & 0xFF;
        
        // 第一次HMAC：salt + blockIndex
        const saltWithIndex = new Uint8Array(saltBytes.length + 4);
        saltWithIndex.set(saltBytes);
        saltWithIndex.set(blockIndexBytes, saltBytes.length);
        
        let u = await hmacSha256(passwordBytes, saltWithIndex);
        let result_block = new Uint8Array(u);
        
        // 迭代HMAC
        for (let i = 1; i < iterations; i++) {
            u = await hmacSha256(passwordBytes, u);
            for (let j = 0; j < u.length; j++) {
                result_block[j] ^= u[j];
            }
        }
        
        // 复制到结果中
        const copyLength = Math.min(result_block.length, keyLength - resultOffset);
        result.set(result_block.slice(0, copyLength), resultOffset);
        resultOffset += copyLength;
        blockIndex++;
    }
    
    return result;
}

// 统一的PBKDF2接口（保持原函数名兼容性）
async function simplePBKDF2(password, salt, iterations, keyLength) {
    if (isCryptoSubtleSupported()) {
        try {
            return await pbkdf2WebCrypto(password, salt, iterations, keyLength);
        } catch (error) {
            console.warn('Web Crypto API失败，使用降级方案:', error);
            return await pbkdf2Fallback(password, salt, iterations, keyLength);
        }
    } else {
        console.warn('浏览器不支持Web Crypto API，使用降级方案');
        return await pbkdf2Fallback(password, salt, iterations, keyLength);
    }
}

// 验证新格式短密钥
async function validateShortKey(keyStr) {
    try {
        // Base62解码得到16字节数据
        const keyData = base62Decode(keyStr);
        
        // 提取时间戳（前4字节）
        const timestampBytes = keyData.slice(0, 4);
        const expiry = (timestampBytes[0] << 24) | (timestampBytes[1] << 16) | (timestampBytes[2] << 8) | timestampBytes[3];
        
        // 提取哈希值（后12字节）
        const storedHash = keyData.slice(4, 16);
        
        // 检查是否过期
        const currentTime = Math.floor(Date.now() / 1000);
        if (currentTime > expiry) {
            return { valid: false, reason: '密钥已过期' };
        }
        
        // 使用确定性方法验证密钥
        // 使用时间戳作为确定性盐来重新计算哈希
        const deterministicSalt = new Uint8Array(8);
        deterministicSalt[0] = (expiry >>> 24) & 0xFF;
        deterministicSalt[1] = (expiry >>> 16) & 0xFF;
        deterministicSalt[2] = (expiry >>> 8) & 0xFF;
        deterministicSalt[3] = expiry & 0xFF;
        deterministicSalt[4] = (expiry >>> 24) & 0xFF; // 重复填充
        deterministicSalt[5] = (expiry >>> 16) & 0xFF;
        deterministicSalt[6] = (expiry >>> 8) & 0xFF;
        deterministicSalt[7] = expiry & 0xFF;
        
        // 使用相同的主密钥重新计算PBKDF2
        const masterKey = 'TWPK_SECURE_KEY_2024';
        const computedHash = await simplePBKDF2(masterKey + expiry, deterministicSalt, 10000, 12);
        
        // 比较哈希值
        const hashMatch = storedHash.every((byte, index) => byte === computedHash[index]);
        
        if (!hashMatch) {
            return { valid: false, reason: '密钥验证失败' };
        }
        
        // 生成nonce用于使用记录（基于密钥内容）
        const nonce = keyStr.slice(0, 16);
        
        return {
            valid: true,
            data: {
                expiry: expiry,
                nonce: nonce,
                deviceFingerprint: 'universal_device_2024',
                keyType: 'short'
            }
        };
    } catch (error) {
        return { valid: false, reason: '短密钥格式错误: ' + error.message };
    }
}

async function A(t){
    // 判断密钥格式：短密钥（16-25字符）还是长密钥（Base64格式）
    if (t.length >= 16 && t.length <= 25 && /^[0-9A-Za-z]+$/.test(t)) {
        // 新的短密钥格式
        return await validateShortKey(t);
    } else {
        // 原有的长密钥格式
        try{
            const e=atob(t),n=decodeURIComponent(escape(e)),o=JSON.parse(n);
            if(!o.expiry||!o.nonce||!o.deviceFingerprint)return{valid:!1,reason:"密钥缺少必要字段"};
            const c=(new Date).getTime();
            if(Math.floor(c/1e3)>o.expiry)return{valid:!1,reason:"密钥已过期"};
            const r=generateDeviceFingerprint();
            return o.deviceFingerprint!==r?{valid:!1,reason:"此密钥不可在当前设备使用"}:(await checkKeyOnlineUsage(o.nonce)).used?{valid:!1,reason:"密钥已被使用，每个密钥只能使用一次"}:{valid:!0,data:o}
        }catch(t){
            return t instanceof DOMException&&"InvalidCharacterError"===t.name?{valid:!1,reason:"密钥Base64解码失败"}:t instanceof SyntaxError?{valid:!1,reason:"密钥JSON格式无效"}:{valid:!1,reason:"验证过程异常: "+t.message}
        }
    }
}

// 在线检查密钥是否已被使用
async function checkKeyOnlineUsage(nonce) {
    const response = await fetch(`https://twpk.up.railway.app/api/key-records/check/${encodeURIComponent(nonce)}`, {
        method: 'GET',
        headers: {
            'User-Agent': 'TWPK-KeyValidator/1.0'
        }
    });
    
    if (response.ok) {
        const result = await response.json();
        console.log('在线密钥验证响应:', result);
        return { used: result.used };
    } else {
        throw new Error(`服务器响应错误: ${response.status} ${response.statusText}`);
    }
}

// 标记密钥为已使用（在线）
async function markKeyAsUsedOnline(nonce) {
    const response = await fetch(`https://twpk.up.railway.app/api/key-records/mark-used`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'User-Agent': 'TWPK-KeyValidator/1.0'
        },
        body: JSON.stringify({ nonce: nonce })
    });
    
    if (response.ok) {
        const result = await response.json();
        console.log('密钥已标记为已使用:', result);
        return { success: true };
    } else {
        throw new Error(`服务器响应错误: ${response.status} ${response.statusText}`);
    }
}

    // 记录密钥使用信息到后台
    async function recordKeyUsage(keyData) {
        // 根据当前环境动态选择API URL
        const apiUrl = window.location.hostname === 'localhost' 
          ? 'http://localhost:3000/api/key-records'
          : '/api/key-records';
        const response = await fetch(apiUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            keyId: keyData.nonce,
            deviceInfo: navigator.userAgent,
            usedAt: new Date().toISOString(),
            expiryTime: new Date(keyData.expiry * 1000).toISOString(), // 添加密钥的实际有效期
            createdTime: new Date().toISOString()
          })
        });
        
        if (response.ok) {
          const result = await response.json();
          console.log('密钥使用记录已保存:', result);
          return { success: true, data: result };
        } else if (response.status === 409) {
          // 409冲突表示密钥已被使用，这是正常情况
          const result = await response.json();
          console.log('密钥已被使用:', result);
          return { success: true, data: result, message: '密钥已被使用' };
        } else {
          throw new Error(`服务器响应错误: ${response.status} ${response.statusText}`);
        }
    }

function F(){if(!_0xAuthCheck())return g.classList.remove("hidden"),void alert("请先验证有效的密钥");const t=document.getElementById("numbersInput").value.trim().split(/\n+/).filter(Boolean);if(!t.length)return void(v.textContent="请输入数据");let e=0;for(const n of t){const t=E(n);if(!t)return void(v.textContent="格式错误：请输入正确的数据格式");const{period:o,data:c}=t,i=c.join(",");d.has(o)||r.length&&r[r.length-1].input===i||(r.push({period:o,data:c,input:i}),d.add(o),e++)}document.getElementById("numbersInput").value="",v.textContent=e>0?`成功添加 ${e} 期数据`:"没有新数据添加",document.getElementById("periodCount").textContent=r.length,r.sort((t,e)=>{const n=t.period.toString();return e.period.toString().localeCompare(n)}),L()}async function J(){if(!_0xAuthCheck())return g.classList.remove("hidden"),void alert("请先验证有效的密钥");try{v.textContent="正在获取数据...";const apiUrl=window.location.hostname==="localhost"?"http://localhost:3000/api/taiwan-pk10-live":"https://twpk.up.railway.app/api/taiwan-pk10-live";const t=await fetch(apiUrl),e=await t.json();if(e.period&&e.numbers&&e.numbers.length===10){const t=e.numbers,n=e.period,o=t.join(",");if(d.has(n)||r.length&&r[r.length-1].input===o)return void(v.textContent="已是最新数据");r.push({period:n,data:t,input:o}),d.add(n),document.getElementById("periodCount").textContent=r.length,v.textContent=`成功获取第 ${n} 期数据`,r.sort((t,e)=>{const n=t.period.toString();return e.period.toString().localeCompare(n)}),L()}else v.textContent="获取数据失败："+(e.error||"数据格式错误")}catch(t){v.textContent=`获取数据错误：${t.message}`}}function R(t,e){if(!_0xAuthCheck())return g.classList.remove("hidden"),alert("请先验证有效的密钥"),[];const n=[];return function o(c,r){if(r.length!==e)for(let e=c;e<t.length;e++)r.push(t[e]),o(e+1,r),r.pop();else n.push(r.slice())}(0,[]),n}

/**
 * 黄金切割（必须 5 中 4）：任意注数 → 5 组
 * 思路：为每条注单指定唯一"缺席组"omitted = 0..4
 * 第 g 组收集所有 omitted !== g 的注单
 * 结论：任意 4 组合并 = 全集（严格保证）
 * 
 * assign: 'roundrobin' 更均匀；'hash' 更稳定（同一注单长期落同一缺席组）
 */
function goldenSplit5in4(data, assign = 'roundrobin') {
  const G = 5;
  const groups = Array.from({ length: G }, () => []);

  // 缺席组索引（每注唯一）
  const omittedIdx = new Array(data.length);

  if (assign === 'hash') {
    for (let i = 0; i < data.length; i++) {
      omittedIdx[i] = hash5(data[i]); // 0..4
    }
  } else {
    for (let i = 0; i < data.length; i++) {
      omittedIdx[i] = i % G; // 轮转
    }
  }

  // 构建 5 组：每注出现在 4 个组
  for (let i = 0; i < data.length; i++) {
    const omit = omittedIdx[i];
    for (let g = 0; g < G; g++) {
      if (g !== omit) groups[g].push(data[i]);
    }
  }
  return groups;

  function hash5(str) {
    let h = 2166136261 >>> 0;
    for (let j = 0; j < str.length; j++) {
      h ^= str.charCodeAt(j);
      h = Math.imul(h, 16777619);
    }
    return h % 5;
  }
}

/** 校验：任意四组合并是否等于全集（严格 5 中 4） */
function validate5in4(groups, original) {
  const uniq = (arr) => Array.from(new Set(arr));
  const origSet = new Set(uniq(original));
  const G = groups.length;

  for (let miss = 0; miss < G; miss++) {
    const merged = new Set();
    for (let g = 0; g < G; g++) {
      if (g === miss) continue;
      for (const x of groups[g]) merged.add(x);
    }
    if (merged.size !== origSet.size) return false;
    // 也可逐条核对
    for (const x of origSet) if (!merged.has(x)) return false;
  }
  return true;
}

/** 解析输入：支持换行/逗号分隔；自动去重；保持原顺序的唯一化 */
function parseInput(raw) {
  const parts = raw
    .split(/[\n,]+/g)
    .map(s => s.trim())
    .filter(Boolean);
  const seen = new Set();
  const out = [];
  for (const p of parts) {
    if (!seen.has(p)) { seen.add(p); out.push(p); }
  }
  return out;
}

// 验证任意4组组合后是否为全集
function validate_5in4(groups) {
    if (!groups || groups.length < 4) {
        return {
            valid: false,
            results: {},
            all_valid: false,
            total_data_size: 0
        };
    }
    
    // 获取所有数据的并集
    const all_set = new Set();
    groups.forEach(group => {
        group.forEach(item => all_set.add(item));
    });
    
    const results = {};
    const total_data_size = all_set.size;
    
    // 生成所有4组的组合
    const combinations = [];
    for (let i = 0; i < groups.length; i++) {
        for (let j = i + 1; j < groups.length; j++) {
            for (let k = j + 1; k < groups.length; k++) {
                for (let l = k + 1; l < groups.length; l++) {
                    combinations.push([i, j, k, l]);
                }
            }
        }
    }
    
    // 验证每个4组组合
    combinations.forEach(combo => {
        const merged = new Set();
        combo.forEach(i => {
            groups[i].forEach(item => merged.add(item));
        });
        
        const is_complete = merged.size === total_data_size;
        results[combo.join(',')] = {
            combo: combo,
            size: merged.size,
            is_complete: is_complete,
            coverage: total_data_size > 0 ? (merged.size / total_data_size) : 0
        };
    });
    
    // 检查是否所有组合都完整
    const all_valid = Object.values(results).every(r => r.is_complete);
    
    return {
        valid: all_valid,
        results: results,
        all_valid: all_valid,
        total_data_size: total_data_size,
        combinations_count: combinations.length
    };
}

// 渲染黄金切割结果 - 5个紧凑框布局
function renderGoldenResults(groups, originalItems = [], isValid = false) {
    const resultsContainer = document.getElementById('goldenResults');
    const resultSummary = document.getElementById('resultSummary');
    const validationResults = document.getElementById('validationResults');
    const validationContent = document.getElementById('validationContent');
    
    resultsContainer.innerHTML = '';
    
    if (!groups || groups.length === 0) {
        resultsContainer.innerHTML = '<div class="col-span-5 text-center text-gray-500 py-8">暂无分割结果</div>';
        resultSummary.textContent = '';
        validationResults.classList.add('hidden');
        return;
    }
    
    // 更新摘要信息
    const totalItems = groups.reduce((sum, group) => sum + group.length, 0);
    const avgGroupSize = Math.round(totalItems / groups.length);
    resultSummary.innerHTML = `共${groups.length}组，总计${totalItems}项，平均每组${avgGroupSize}项 | 验证结果：${isValid ? '<span class="text-green-600 font-semibold">✅ 通过</span>' : '<span class="text-red-600 font-semibold">❌ 失败</span>'}`;
    
    // 显示验证结果
    if (originalItems.length > 0) {
        validationContent.innerHTML = `
            <div class="text-sm text-gray-600">
                <p class="mb-2">原始数据：${originalItems.length} 注</p>
                <p class="mb-2">分组结果：${groups.length} 组</p>
                <p class="mb-2">5中4验证：${isValid ? '<span class="text-green-600 font-semibold">通过 - 任意4组合并等于全集</span>' : '<span class="text-red-600 font-semibold">失败 - 不满足5中4条件</span>'}</p>
            </div>
        `;
        validationResults.classList.remove('hidden');
    } else {
        validationResults.classList.add('hidden');
    }
    
    // 确保显示5个框，不足的用空框填充
    const displayGroups = [...groups];
    while (displayGroups.length < 5) {
        displayGroups.push([]);
    }
    
    // 生成5个紧凑的分组框
    displayGroups.slice(0, 5).forEach((group, index) => {
        const groupDiv = document.createElement('div');
        groupDiv.className = 'bg-white border border-gray-200 rounded-lg p-3';
        
        if (group.length === 0) {
            // 空框
            groupDiv.innerHTML = `
                <div class="text-center text-gray-400 py-4">
                    <div class="text-sm font-medium mb-1">组 ${index + 1}</div>
                    <div class="text-xs">暂无数据</div>
                </div>
            `;
        } else {
            // 有数据的框
            groupDiv.innerHTML = `
                <div class="flex items-center justify-between mb-2">
                    <h4 class="font-semibold text-gray-800 text-sm">组 ${index + 1}</h4>
                    <div class="flex items-center gap-1">
                        <span class="text-xs text-gray-500">${group.length}项</span>
                        <button 
                            onclick="copyGroupData(${index})" 
                            class="px-1 py-0.5 bg-blue-500 text-white text-xs rounded hover:bg-blue-600 transition-colors"
                            title="复制本组数据"
                        >
                            复制
                        </button>
                    </div>
                </div>
                <div class="max-h-32 overflow-y-auto">
                    <div class="text-xs space-y-1" id="group-${index}-data" data-full-data="${group.join(',')}">
                        ${group.slice(0, 200).map(item => `<div class="p-1 bg-gray-50 rounded text-center hover:bg-gray-100 transition-colors">${item}</div>`).join('')}
                        ${group.length > 200 ? '<div class="p-1 text-center text-gray-400 text-xs">...还有' + (group.length - 200) + '项</div>' : ''}
                    </div>
                </div>
            `;
        }
        
        resultsContainer.appendChild(groupDiv);
    });
}

// 复制组数据功能
function copyGroupData(groupIndex) {
    const groupDataDiv = document.getElementById(`group-${groupIndex}-data`);
    if (!groupDataDiv) {
        alert('未找到数据');
        return;
    }
    
    // 从data-full-data属性获取完整数据，确保复制全部数据而不受显示限制影响
    const dataText = groupDataDiv.getAttribute('data-full-data') || '';
    
    if (!dataText) {
        alert('没有可复制的数据');
        return;
    }
    
    // 复制到剪贴板
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(dataText).then(() => {
            // 显示复制成功提示
            showCopySuccess(groupIndex);
        }).catch(err => {
            console.error('复制失败:', err);
            fallbackCopyTextToClipboard(dataText, groupIndex);
        });
    } else {
        fallbackCopyTextToClipboard(dataText, groupIndex);
    }
}

// 备用复制方法
function fallbackCopyTextToClipboard(text, groupIndex) {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.position = 'fixed';
    textArea.style.left = '-999999px';
    textArea.style.top = '-999999px';
    textArea.style.opacity = '0';
    textArea.style.pointerEvents = 'none';
    // 防止移动端弹出输入法
    textArea.readOnly = true;
    textArea.setAttribute('readonly', 'readonly');
    textArea.setAttribute('inputmode', 'none');
    document.body.appendChild(textArea);
    
    // 在移动端避免使用focus，直接选择文本
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    if (!isMobile) {
        textArea.focus();
    }
    textArea.select();
    
    try {
        const successful = document.execCommand('copy');
        if (successful) {
            showCopySuccess(groupIndex);
        } else {
            alert('复制失败，请手动选择复制');
        }
    } catch (err) {
        console.error('复制失败:', err);
        alert('复制失败，请手动选择复制');
    }
    
    document.body.removeChild(textArea);
}

// 重置所有复制按钮状态（仅在重新切割时调用）
function resetAllCopyButtons() {
    const allCopyButtons = document.querySelectorAll('button[onclick^="copyGroupData("]');
    allCopyButtons.forEach(btn => {
        btn.innerHTML = '复制';
        btn.classList.remove('bg-green-500');
        btn.classList.add('bg-blue-500', 'hover:bg-blue-600');
    });
}

// 显示复制成功提示
function showCopySuccess(groupIndex) {
    // 设置当前按钮为已复制状态（持久显示）
    const button = document.querySelector(`button[onclick="copyGroupData(${groupIndex})"]`);
    if (button) {
        button.innerHTML = '<i class="fa fa-check"></i> 已复制';
        button.classList.remove('bg-blue-500', 'hover:bg-blue-600');
        button.classList.add('bg-green-500');
    }
}

// 渲染验证结果
function renderValidationResults(validation) {
    const validationContainer = document.getElementById('validationResults');
    const validationContent = document.getElementById('validationContent');
    
    if (!validation || !validation.results) {
        validationContainer.classList.add('hidden');
        return;
    }
    
    validationContainer.classList.remove('hidden');
    
    let html = `
        <div class="mb-4">
            <div class="text-sm text-gray-600 mb-2">
                总数据量: ${validation.total_data_size} 注 | 
                验证组合数: ${validation.combinations_count} 个 | 
                整体验证: ${validation.all_valid ? '<span class="text-green-600 font-semibold">✅ 通过</span>' : '<span class="text-red-600 font-semibold">❌ 失败</span>'}
            </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
    `;
    
    Object.entries(validation.results).forEach(([comboKey, result]) => {
        const comboText = result.combo.map(i => `组${i + 1}`).join(' + ');
        const statusClass = result.is_complete ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200';
        const statusIcon = result.is_complete ? '✅' : '❌';
        
        html += `
            <div class="${statusClass} border rounded-lg p-3">
                <div class="font-medium text-sm">${comboText}</div>
                <div class="text-xs text-gray-600 mt-1">
                    ${result.size}注 (${(result.coverage * 100).toFixed(1)}%) ${statusIcon}
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    validationContent.innerHTML = html;
}function H(t,e){const n={};return e.forEach(e=>{let o=0,c=0,r=0,i=0;t.forEach(t=>{t.cells[e].hit?(r++,i=0,r>o&&(o=r)):(i++,r=0,i>c&&(c=i))}),n[e]={maxHit:o,maxMiss:c}}),n}function U(t,e){const n={};return e.forEach(e=>{let o=0;for(let n=0;n<t.length&&t[n].cells[e].hit;n++)o++;n[e]=o}),n}function z(t,e){const n={};return e.forEach(e=>{let o=0;for(let n=0;n<t.length&&!t[n].cells[e].hit;n++)o++;n[e]=o}),n}function L(){if(!_0xAuthCheck()) return; const t=document.querySelector("#resultTable thead"),e=document.querySelector("#resultTable tbody");t.innerHTML="",e.innerHTML="";if(!r.length){const t=document.createElement("tr"),n=document.createElement("td");return n.colSpan=100,n.className="py-4 text-center text-gray-500",n.textContent="暂无数据，请先输入或获取数据",t.appendChild(n),e.appendChild(t),void j()}const n=r.slice(0,Math.min(r.length,f));totalPages=Math.ceil(n.length/pageSize);const o=+document.querySelector("#numButtons .btn-active")?.dataset.num||0,c=Array.from(document.querySelectorAll("#hitButtons .btn-active")).map(t=>+t.dataset.hit),selectedPositions=Array.from(document.querySelectorAll(".position-btn.btn-active")).map(t=>+t.dataset.position),i=[...Array(10)].map((t,e)=>e+1),a=[...o>0&&o<=10?R(i,o):[],...document.getElementById("customCombos").value.trim().split(/\s+/).filter(Boolean).map(t=>t.split(",").map(t=>+t).filter(t=>!isNaN(t)))].filter(t=>t.length>0).map(t=>t.join(",")),s=n.map(t=>({rec:t,cells:{}}));a.forEach(t=>{let e=0;for(let n=s.length-1;n>=0;n--){const o=s[n].rec,frontFive=o.data.slice(0,5);let r=0;if(selectedPositions.length>0){selectedPositions.forEach(pos=>{if(pos>=1&&pos<=5&&t.split(",").map(t=>+t).includes(frontFive[pos-1])){r++}});}else{r=t.split(",").map(t=>+t).filter(t=>frontFive.includes(t)).length;}c.length&&c.includes(r)?(s[n].cells[t]={txt:t,hit:!0},e=0):(e++,s[n].cells[t]={txt:e,hit:!1})}});const d=H(s,a),u=U(s,a),l=z(s,a),b=a.slice().sort((t,e)=>{if(y){const{maxHit:n,maxMiss:o}=d[t],{maxHit:c,maxMiss:r}=d[e];return m?c-n||o-r:o-r||c-n}return m?u[e]-u[t]||l[t]-l[e]:l[e]-l[t]||u[e]-u[t]});document.getElementById("sortText").textContent=m?"按遗漏次数排序":"按连中次数排序";const startIndex=(currentPage-1)*pageSize,endIndex=Math.min(startIndex+pageSize,s.length),pageData=s.slice(startIndex,endIndex);document.getElementById("summary").innerHTML=`\n        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">\n          <div>共 ${b.length} 注分析组合</div>\n          <div>当前显示: ${n.length} 期 / 总计: ${r.length} 期</div>\n          <div>筛选条件: ${o}码组合，命中${c.length>0?c.join("/"):"全部"}胆${selectedPositions.length>0?`，位置${selectedPositions.join("/")}名`:""}</div>\n          <div>第 ${currentPage}/${totalPages} 页 (${pageData.length}/${s.length} 行)</div>\n        </div>\n        <div class="flex justify-center items-center mt-4 space-x-2">\n          <button id="prevPage" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 disabled:opacity-50" ${currentPage<=1?'disabled':''}>上一页</button>\n          <span class="text-sm text-gray-600">第 ${currentPage} 页，共 ${totalPages} 页</span>\n          <button id="nextPage" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 disabled:opacity-50" ${currentPage>=totalPages?'disabled':''}>下一页</button>\n        </div>`;const h=document.createElement("tr");h.className="bg-gray-50 table-header-sticky",h.innerHTML='<th class="px-3 py-2 text-center sticky-col left-0 border-r border-gray-200 fixed-width-period sticky-bg-white" style="position: sticky; top: 0; z-index: 1001;">期数</th><th class="px-3 py-2 text-center sticky-col left-[120px] border-r border-gray-200 fixed-width-data sticky-bg-white" style="position: sticky; top: 0; z-index: 1001;">数据</th>';b.forEach(t=>{const{maxHit:e,maxMiss:n}=d[t],o=document.createElement("th");o.className="px-3 py-2 text-center border-r border-gray-200",o.innerHTML=y?m?`\n              <div class="font-medium">${t}</div>\n              <div class="text-xs text-gray-500 whitespace-nowrap">连:${e} (${Math.round((s.filter(row=>row.cells[t]&&row.cells[t].hit).length/s.length)*100)||0}%)</div>\n            `:`\n              <div class="font-medium">${t}</div>\n              <div class="text-xs text-gray-500 whitespace-nowrap">漏:${n} (${Math.round((s.filter(row=>row.cells[t]&&row.cells[t].hit).length/s.length)*100)||0}%)</div>\n            `:m?`\n              <div class="font-medium">${t}</div>\n              <div class="text-xs text-gray-500 whitespace-nowrap">连:${u[t]} (${Math.round((s.filter(row=>row.cells[t]&&row.cells[t].hit).length/s.length)*100)||0}%)</div>\n            `:`\n              <div class="font-medium">${t}</div>\n              <div class="text-xs text-gray-500 whitespace-nowrap">漏:${l[t]} (${Math.round((s.filter(row=>row.cells[t]&&row.cells[t].hit).length/s.length)*100)||0}%)</div>\n            `,h.appendChild(o)}),t.appendChild(h),pageData.forEach((t,n)=>{const o=document.createElement("tr");o.className=0===n?"bg-gray-100":1===n?"bg-gray-50":"",o.innerHTML=`\n          <td class="px-3 py-2 text-left sticky-col left-0 border-r border-gray-200 font-medium fixed-width-period ${0===n?"sticky-bg-gray-100":1===n?"sticky-bg-gray-50":"sticky-bg-white"}">${t.rec.period}</td>\n          <td class="px-3 py-2 text-left sticky-col left-[120px] border-r border-gray-200 fixed-width-data ${0===n?"sticky-bg-gray-100":1===n?"sticky-bg-gray-50":"sticky-bg-white"}">\n            <div class="number-row">${t.rec.data.slice(0,5).join(",")}</div>\n            <div class="number-row">${t.rec.data.slice(5).join(",")}</div>\n          </td>\n        `,b.forEach(e=>{const n=t.cells[e],c=document.createElement("td");c.className="px-3 py-2 text-center border-r border-gray-200 "+(n.hit?"hit-cell":"miss-cell"),c.textContent=n.txt,o.appendChild(c)}),e.appendChild(o)}),setTimeout(()=>{const t=document.getElementById("prevPage"),e=document.getElementById("nextPage");t&&t.addEventListener("click",()=>{if(currentPage>1){const tableContainer=document.getElementById("tableContainer");const scrollPosition=tableContainer.scrollTop;sessionStorage.setItem(`scrollPosition_${currentPage}`,scrollPosition);currentPage--;L();setTimeout(()=>{const savedPosition=sessionStorage.getItem(`scrollPosition_${currentPage}`);if(savedPosition!==null){tableContainer.scrollTop=parseInt(savedPosition);}else{tableContainer.scrollTop=0;}},50);}}),e&&e.addEventListener("click",()=>{if(currentPage<totalPages){const tableContainer=document.getElementById("tableContainer");const scrollPosition=tableContainer.scrollTop;sessionStorage.setItem(`scrollPosition_${currentPage}`,scrollPosition);currentPage++;L();setTimeout(()=>{const savedPosition=sessionStorage.getItem(`scrollPosition_${currentPage}`);if(savedPosition!==null){tableContainer.scrollTop=parseInt(savedPosition);}else{tableContainer.scrollTop=0;}},50);}})},100),j()}function j(){const t=document.getElementById("resultTable"),e=document.getElementById("tableContainer"),n=t.offsetWidth,o=e.offsetWidth;if(n>o){document.querySelector(".slider-container").style.display="block";const u=o/n,l=Math.max(20,u*o);k.style.width=e.scrollLeft/(n-o)*100+"%",w.style.left=e.scrollLeft/(n-o)*(o-l)+"px",w.style.width=`${l}px`,k.style.width=e.scrollLeft/(n-o)*100+"%";let m=!1;function c(t){if(!m)return;const c=e.getBoundingClientRect(),r=t.clientX-c.left-l/2,i=o-l,a=Math.max(0,Math.min(r,i)),s=a/i,d=s*(n-o);e.scrollLeft=d,w.style.left=`${a}px`,k.style.width=100*s+"%"}function r(){m=!1,document.removeEventListener("mousemove",c),document.removeEventListener("mouseup",r)}w.addEventListener("mousedown",t=>{m=!0,document.addEventListener("mousemove",c),document.addEventListener("mouseup",r),t.preventDefault()}),document.querySelector(".slider-track").addEventListener("click",t=>{const c=e.getBoundingClientRect(),r=t.clientX-c.left-l/2,i=o-l,a=Math.max(0,Math.min(r,i)),s=a/i,d=s*(n-o);e.scrollLeft=d,w.style.left=`${a}px`,k.style.width=100*s+"%"})}else document.querySelector(".slider-container").style.display="none";const i=t.offsetHeight,a=e.offsetHeight;if(i>a){$.style.display="none";const f=a/i,y=Math.max(20,f*a);I.style.height=e.scrollTop/(i-a)*100+"%",B.style.top=e.scrollTop/(i-a)*(a-y)+"px",B.style.height=`${y}px`,I.style.height=e.scrollTop/(i-a)*100+"%";let b=!1;function s(t){if(!b)return;const n=e.getBoundingClientRect(),o=t.clientY-n.top-y/2,c=a-y,r=Math.max(0,Math.min(o,c)),s=r/c,d=s*(i-a);e.scrollTop=d,B.style.top=`${r}px`,I.style.height=100*s+"%"}function d(){b=!1,document.removeEventListener("mousemove",s),document.removeEventListener("mouseup",d)}B.addEventListener("mousedown",t=>{b=!0,document.addEventListener("mousemove",s),document.addEventListener("mouseup",d),t.preventDefault()}),document.querySelector(".vertical-slider-track").addEventListener("click",t=>{const n=e.getBoundingClientRect(),o=t.clientY-n.top-y/2,c=a-y,r=Math.max(0,Math.min(o,c)),s=r/c,d=s*(i-a);e.scrollTop=d,B.style.top=`${r}px`,I.style.height=100*s+"%"})}else $.style.display="none";e.addEventListener("scroll",()=>{if(n>o){const t=e.scrollLeft/(n-o);w.style.left=t*(o-parseInt(getComputedStyle(w).width))+"px",k.style.width=100*t+"%";const periodCols=document.querySelectorAll(".fixed-width-period");const dataCols=document.querySelectorAll(".fixed-width-data");if(e.scrollLeft>10){periodCols.forEach(col=>col.style.opacity="0");dataCols.forEach(col=>col.style.left="0px")}else{periodCols.forEach(col=>col.style.opacity="1");dataCols.forEach(col=>col.style.left="120px")}}if(i>a){const t=e.scrollTop/(i-a);const thumbHeight=Math.max(20,f*a);B.style.top=Math.min(t*(a-thumbHeight),a-thumbHeight)+"px",I.style.height=Math.min(100*t,100)+"%"}})}async function V(){if(s)try{const t=await s.getFile(),e=(await t.text()).trim().split("\n").filter(Boolean);for(const t of e)q(t);r.sort((t,e)=>{const n=t.period.toString();return e.period.toString().localeCompare(n)}),document.getElementById("periodCount").textContent=r.length,L()}catch(t){v.textContent=`读取文件错误: ${t.message}`}}async function W(){if(s)try{const t=await s.getFile(),e=(await t.text()).trim().split("\n")[0],n=e.trim().split(/\t+/);if(2!==n.length)return;const o=n[0].trim();if(o===u)return;u=o,q(e),document.getElementById("periodCount").textContent=r.length,L()}catch(t){}}function q(t){let e;if(t.includes("\t"))e=t.trim().split(/\t+/);else{if(!t.includes(" "))return;e=t.trim().split(/\s+/)}if(e.length<2)return;const n=e[0].trim();if(d.has(n))return;let o;if(e[1].includes(","))o=e[1].split(",").map(t=>parseInt(t.trim(),10));else{if(!e[1].includes(" "))return;o=e[1].split(" ").map(t=>parseInt(t.trim(),10))}10!==o.length||o.some(isNaN)||(d.add(n),r.unshift({period:n,data:o,input:o.join(",")}))}P.addEventListener("click",async function(){const t=p.value.trim();if(t){this.disabled=!0,this.textContent="验证中...";try{const e=await A(t);if(e.valid){// 记录密钥使用信息到后台（这会同时标记密钥为已使用）
await recordKeyUsage(e.data);
const n=Y();localStorage.setItem(`validKey_${n}`,t),localStorage.setItem(`keyExpiry_${n}`,e.data.expiry);
// 设置新的加密验证状态
_0xSetAuth(t);
b=!0;
D(e.data.expiry);
// 验证成功后恢复按钮状态并隐藏模态框
this.disabled=!1;
this.textContent="验证密钥";
g.classList.add("hidden");
g.style.display="none"}else{alert("密钥验证失败: "+e.reason);
this.disabled=!1;
this.textContent="验证密钥"}}catch(t){console.error("密钥验证过程出错:",t),alert("验证过程中发生错误: "+t.message);this.disabled=!1;this.textContent="验证密钥"}}else alert("请输入密钥")}),window.addEventListener("load",async function(){try{// 检查认证版本号，如果不匹配则清除所有认证信息
const storedVersion = localStorage.getItem('authVersion');
if (storedVersion !== AUTH_VERSION) {
    console.log('认证版本不匹配，清除所有认证信息');
    // 清除所有相关的localStorage项
    const keys = Object.keys(localStorage);
    keys.forEach(key => {
        if (key.startsWith('validKey_') || key.startsWith('keyExpiry_') || key === 'authVersion') {
            localStorage.removeItem(key);
        }
    });
    b=!1,g.classList.remove("hidden"),g.style.display="flex";
    return;
}

const t=Y(),e=localStorage.getItem(`validKey_${t}`),n=localStorage.getItem(`keyExpiry_${t}`),o=Math.floor((new Date).getTime()/1e3);if(e&&n){const r=parseInt(n);if(o<r){// 密钥未过期，但需要在线验证是否已被使用
try{const keyData=JSON.parse(atob(e.split('.')[1]));const isUsed=await checkKeyOnlineUsage(keyData.nonce);if(isUsed){localStorage.removeItem(`validKey_${t}`),localStorage.removeItem(`keyExpiry_${t}`),b=!1,alert("密钥已被使用，请重新验证密钥"),g.classList.remove("hidden"),g.style.display="flex"}else{_0xSetAuth(e);b=!0,D(r),g.classList.add("hidden"),g.style.display="none"}}catch(err){console.error("在线验证失败，使用本地验证:",err);_0xSetAuth(e);b=!0,D(r),g.classList.add("hidden"),g.style.display="none"}}else{localStorage.removeItem(`validKey_${t}`),localStorage.removeItem(`keyExpiry_${t}`),b=!1,alert("您的访问密钥已过期，请重新验证密钥"),g.classList.remove("hidden"),g.style.display="flex"}}else b=!1,g.classList.remove("hidden"),g.style.display="flex"}catch(t){console.error("页面加载时密钥检查出错:",t),b=!1,g.classList.remove("hidden"),g.style.display="flex"}}),document.getElementById("calcBtn").addEventListener("click",F),document.getElementById("numbersInput").addEventListener("keydown",t=>{"Enter"!==t.key||t.shiftKey||(t.preventDefault(),F())}),document.getElementById("autoFetchBtn").addEventListener("click",()=>{a?(clearInterval(a),a=null,document.getElementById("autoFetchBtn").innerHTML='<i class="fa fa-refresh mr-2"></i>自动获取数据',v.textContent="已停止自动获取"):(J(),a=setInterval(J,5e3),document.getElementById("autoFetchBtn").innerHTML='<i class="fa fa-stop mr-2"></i>停止自动获取',v.textContent="已开始自动获取数据，每5秒更新一次")}),document.getElementById("sortToggle").addEventListener("click",()=>{m=!m,L()}),document.getElementById("currentBtn").addEventListener("click",()=>{const tableContainer=document.getElementById("tableContainer");const wasHidden=tableContainer&&tableContainer.scrollLeft>10;y=!0,document.getElementById("currentBtn").classList.add("btn-active","bg-blue-600","text-white"),document.getElementById("currentBtn").classList.remove("bg-gray-200","text-gray-700"),document.getElementById("historyBtn").classList.remove("btn-active","bg-blue-600","text-white"),document.getElementById("historyBtn").classList.add("bg-gray-200","text-gray-700"),L();if(wasHidden){setTimeout(()=>{const periodCols=document.querySelectorAll(".fixed-width-period");const dataCols=document.querySelectorAll(".fixed-width-data");periodCols.forEach(col=>col.style.opacity="0");dataCols.forEach(col=>col.style.left="0px")},50)}}),document.getElementById("historyBtn").addEventListener("click",()=>{const tableContainer=document.getElementById("tableContainer");const wasHidden=tableContainer&&tableContainer.scrollLeft>10;y=!1,document.getElementById("historyBtn").classList.add("btn-active","bg-blue-600","text-white"),document.getElementById("historyBtn").classList.remove("bg-gray-200","text-gray-700"),document.getElementById("currentBtn").classList.remove("btn-active","bg-blue-600","text-white"),document.getElementById("currentBtn").classList.add("bg-gray-200","text-gray-700"),L();if(wasHidden){setTimeout(()=>{const periodCols=document.querySelectorAll(".fixed-width-period");const dataCols=document.querySelectorAll(".fixed-width-data");periodCols.forEach(col=>col.style.opacity="0");dataCols.forEach(col=>col.style.left="0px")},50)}}),document.getElementById("missBtn").addEventListener("click",()=>{const tableContainer=document.getElementById("tableContainer");const wasHidden=tableContainer&&tableContainer.scrollLeft>10;m=!1,document.getElementById("missBtn").classList.add("btn-active","bg-blue-600","text-white"),document.getElementById("missBtn").classList.remove("bg-gray-200","text-gray-700"),document.getElementById("hitBtn").classList.remove("btn-active","bg-blue-600","text-white"),document.getElementById("hitBtn").classList.add("bg-gray-200","text-gray-700"),L();if(wasHidden){setTimeout(()=>{const periodCols=document.querySelectorAll(".fixed-width-period");const dataCols=document.querySelectorAll(".fixed-width-data");periodCols.forEach(col=>col.style.opacity="0");dataCols.forEach(col=>col.style.left="0px")},50)}}),document.getElementById("hitBtn").addEventListener("click",()=>{const tableContainer=document.getElementById("tableContainer");const wasHidden=tableContainer&&tableContainer.scrollLeft>10;m=!0,document.getElementById("hitBtn").classList.add("btn-active","bg-blue-600","text-white"),document.getElementById("hitBtn").classList.remove("bg-gray-200","text-gray-700"),document.getElementById("missBtn").classList.remove("btn-active","bg-blue-600","text-white"),document.getElementById("missBtn").classList.add("bg-gray-200","text-gray-700"),L();if(wasHidden){setTimeout(()=>{const periodCols=document.querySelectorAll(".fixed-width-period");const dataCols=document.querySelectorAll(".fixed-width-data");periodCols.forEach(col=>col.style.opacity="0");dataCols.forEach(col=>col.style.left="0px")},50)}}),document.getElementById("statBtn").addEventListener("click",L),document.getElementById("clearBtn").addEventListener("click",()=>{confirm("确定要清空所有数据吗？此操作不可恢复。")&&(r=[],i=1,d.clear(),document.getElementById("periodCount").textContent="0",document.getElementById("summary").textContent="",L(),v.textContent="数据已清空")}),document.addEventListener("DOMContentLoaded",()=>{document.getElementById("uploadDataBtn").addEventListener("click",async()=>{try{[s]=await window.showOpenFilePicker(),d.clear(),u=null,r=[],i=1,await V(),l&&clearInterval(l),l=setInterval(W,3e3),v.textContent=`已加载文件: ${s.name}`}catch(t){v.textContent=`文件选择错误: ${t.message}`}})});const X=document.querySelectorAll(".period-btn");function Y(){try{const t=document.documentElement.outerHTML.substring(0,1e3)+window.location.href.split("/").slice(-2).join("/");let e=0;for(let n=0;n<t.length;n++)e=(e<<5)-e+t.charCodeAt(n),e&=e;return"file_"+Math.abs(e).toString(36)}catch(t){return console.error("Failed to generate file identifier:",t),"fallback_"+Date.now()}}X.forEach(t=>{t.addEventListener("click",()=>{X.forEach(t=>t.classList.remove("btn-active")),t.classList.add("btn-active"),f=parseInt(t.dataset.period),document.getElementById("customPeriod").value=f,currentPage=1,L()})}),document.getElementById("customPeriodBtn").addEventListener("click",()=>{const t=parseInt(document.getElementById("customPeriod").value);!isNaN(t)&&t>=1&&t<=1e4?(f=t,X.forEach(t=>t.classList.remove("btn-active")),currentPage=1,L()):alert("请输入1-10000之间的数字")}),window.addEventListener("resize",j),L();

// 页面加载时自动读取最新数据
async function loadLatestData() {
    try {
        // 首先尝试加载历史数据（3天的txt文件数据）
        const historicalResponse = await fetch('/api/historical-data?days=3');
        let historicalData = '';
        
        if (historicalResponse.ok) {
            historicalData = await historicalResponse.text();
            console.log('成功加载历史数据');
        } else {
            console.log('历史数据API不可用，尝试直接读取txt文件');
            // 如果历史数据API不可用，尝试直接读取txt文件
            const dates = [];
            const today = new Date();
            for (let i = 2; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(today.getDate() - i);
                const dateStr = date.getFullYear().toString().slice(2) + 
                               String(date.getMonth() + 1).padStart(2, '0') + 
                               String(date.getDate()).padStart(2, '0');
                dates.push(dateStr);
            }
            
            const historicalLines = [];
            for (const date of dates) {
                try {
                    const response = await fetch(`/${date}.txt`);
                    if (response.ok) {
                        const data = await response.text();
                        if (data.trim()) {
                            historicalLines.push(data.trim());
                        }
                    }
                } catch (error) {
                    console.log(`无法加载 ${date}.txt:`, error);
                }
            }
            historicalData = historicalLines.join('\n');
        }
        
        // 然后尝试从数据库API读取今日实时数据
        let currentData = '';
        const response = await fetch('/api/taiwan-pk10-data');
        if (response.ok) {
            const apiData = await response.json();
            if (apiData.success && apiData.data && apiData.data.length > 0) {
                // 将API数据转换为文本格式
                currentData = apiData.data.map(item => `${item.period} ${item.numbers.join(',')}`).join('\n');
                console.log(`成功从数据库加载${apiData.data.length}期实时数据`);
            }
        }
        
        // 合并历史数据和实时数据
        let allData = '';
        if (historicalData && currentData) {
            allData = historicalData + '\n' + currentData;
        } else if (historicalData) {
            allData = historicalData;
        } else if (currentData) {
            allData = currentData;
        }
        
        if (allData) {
            const numbersInput = document.getElementById('numbersInput');
            if (numbersInput) {
                numbersInput.value = allData;
                console.log('成功加载历史数据和实时数据');
                    
                // 自动触发计算分析（绕过密钥验证）
                setTimeout(() => {
                    try {
                        // 直接处理数据，绕过密钥验证
                        const t = document.getElementById("numbersInput").value.trim().split(/\n+/).filter(Boolean);
                        if (!t.length) {
                            const output = document.getElementById('output');
                            if (output) {
                                output.innerHTML = `<div class="text-yellow-600">数据已加载但为空</div>`;
                            }
                            return;
                        }
                        
                        let e = 0;
                        for (const n of t) {
                            const t = E(n); // 使用现有的数据解析函数
                            if (!t) continue;
                            const {period: o, data: c} = t, i = c.join(",");
                            if (!d.has(o) && !(r.length && r[r.length - 1].input === i)) {
                                r.push({period: o, data: c, input: i});
                                d.add(o);
                                e++;
                            }
                        }
                        
                        document.getElementById("numbersInput").value = "";
                        document.getElementById("periodCount").textContent = r.length;
                        r.sort((t, e) => {
                            const n = t.period.toString();
                            return e.period.toString().localeCompare(n);
                        });
                        
                        // 调用表格渲染函数（绕过密钥验证）
                        if (typeof L === 'function') {
                            // 临时绕过密钥检查
                            const originalAuthCheck = window._0xAuthCheck;
                            window._0xAuthCheck = () => true;
                            L();
                            window._0xAuthCheck = originalAuthCheck;
                        }
                        
                        const output = document.getElementById('output');
                        if (output) {
                            output.innerHTML = `<div class="text-green-600">已自动加载历史数据和实时数据，共 ${e} 条有效记录，总计 ${r.length} 期数据</div>`;
                        }
                    } catch (error) {
                        console.error('自动处理数据失败:', error);
                        const output = document.getElementById('output');
                        if (output) {
                            output.innerHTML = `<div class="text-red-600">自动处理数据时出错: ${error.message}</div>`;
                        }
                    }
                }, 100);
            }
            return;
        }
        
        // 如果没有找到任何数据
        const output = document.getElementById('output');
        if (output) {
            output.innerHTML = '<div class="text-yellow-600">未找到可用的数据，请检查数据库连接或手动上传数据</div>';
        }
        console.log('未找到任何可用的数据');
        
    } catch (error) {
        console.error('自动加载数据失败:', error);
        const output = document.getElementById('output');
        if (output) {
            output.innerHTML = '<div class="text-red-600">自动加载数据时出错</div>';
        }
    }
}

// 页面加载完成后自动加载数据
setTimeout(loadLatestData, 1000);

// 黄金切割页面事件处理
document.addEventListener('DOMContentLoaded', function() {
    // 输入数据计数
    const goldenInputData = document.getElementById('goldenInputData');
    const goldenInputCount = document.getElementById('goldenInputCount');
    
    if (goldenInputData && goldenInputCount) {
        goldenInputData.addEventListener('input', function() {
            const data = this.value.trim();
            if (!data) {
                goldenInputCount.classList.add('hidden');
                return;
            }
            
            // 解析输入数据
            const items = data.split(/[\n,;，]+/).map(s => s.trim()).filter(s => s);
            goldenInputCount.textContent = `共 ${items.length} 项`;
            goldenInputCount.classList.remove('hidden');
        });
    }
    
    // 模式切换按钮
    const modeUniformBtn = document.getElementById('modeUniformBtn');
    const modeStableBtn = document.getElementById('modeStableBtn');
    const modeDescription = document.getElementById('modeDescription');
    
    let currentMode = 'uniform'; // 默认均匀模式
    
    if (modeUniformBtn && modeStableBtn) {
        modeUniformBtn.addEventListener('click', function() {
            currentMode = 'uniform';
            modeUniformBtn.classList.add('active-mode');
            modeUniformBtn.classList.remove('inactive-mode');
            modeStableBtn.classList.add('inactive-mode');
            modeStableBtn.classList.remove('active-mode');
            modeDescription.textContent = '均匀模式：一次性分完就用，不保持历史分组';
        });
        
        modeStableBtn.addEventListener('click', function() {
            currentMode = 'stable';
            modeStableBtn.classList.add('active-mode');
            modeStableBtn.classList.remove('inactive-mode');
            modeUniformBtn.classList.add('inactive-mode');
            modeUniformBtn.classList.remove('active-mode');
            modeDescription.textContent = '稳定模式：维护长期分组，不想每次重新切割';
        });
    }
    
    // 分割按钮
    const goldenSplitBtn = document.getElementById('goldenSplitBtn');
    if (goldenSplitBtn) {
        goldenSplitBtn.addEventListener('click', function() {
            const inputData = document.getElementById('goldenInputData').value.trim();
            
            if (!inputData) {
                alert('请输入要分割的数据');
                return;
            }
            
            // 解析输入数据
            const items = parseInput(inputData);
            
            if (items.length === 0) {
                alert('没有有效的数据');
                return;
            }
            
            // 根据当前模式执行黄金切割
            const assignMode = currentMode === 'uniform' ? 'roundrobin' : 'hash';
            const groups = goldenSplit5in4(items, assignMode);
            
            // 验证结果
            const isValid = validate5in4(groups, items);
            
            // 重置所有复制按钮状态（新的切割开始）
            resetAllCopyButtons();
            
            // 渲染结果
            renderGoldenResults(groups, items, isValid);
            
            console.log('分割完成:', groups, '验证结果:', isValid);
        });
    }
    
    // 粘贴数据按钮
    const goldenPasteBtn = document.getElementById('goldenPasteBtn');
    if (goldenPasteBtn) {
        goldenPasteBtn.addEventListener('click', async function() {
            try {
                // 检查剪贴板API是否可用
                if (!navigator.clipboard || !navigator.clipboard.readText) {
                    // 降级到传统方法
                    const textarea = document.createElement('textarea');
                    document.body.appendChild(textarea);
                    textarea.focus();
                    document.execCommand('paste');
                    const text = textarea.value;
                    document.body.removeChild(textarea);
                    
                    if (text.trim()) {
                        document.getElementById('goldenInputData').value = text.trim();
                        // 触发输入事件以更新计数
                        const inputEvent = new Event('input', { bubbles: true });
                        document.getElementById('goldenInputData').dispatchEvent(inputEvent);
                    }
                    return;
                }
                
                // 尝试从剪贴板读取数据
                const text = await navigator.clipboard.readText();
                if (text.trim()) {
                    document.getElementById('goldenInputData').value = text.trim();
                    
                    // 触发输入事件以更新计数
                    const inputEvent = new Event('input', { bubbles: true });
                    document.getElementById('goldenInputData').dispatchEvent(inputEvent);
                } else {
                    alert('剪贴板为空');
                }
            } catch (err) {
                console.error('无法访问剪贴板:', err);
                // 提示用户使用快捷键粘贴
                alert('请使用 Ctrl+V (Windows) 或 Cmd+V (Mac) 手动粘贴数据到输入框');
            }
        });
    }
    
    // 清空按钮
    const goldenClearBtn = document.getElementById('goldenClearBtn');
    if (goldenClearBtn) {
        goldenClearBtn.addEventListener('click', function() {
            // 清空输入
            document.getElementById('goldenInputData').value = '';
            document.getElementById('goldenInputCount').classList.add('hidden');
            
            // 清空结果
            document.getElementById('goldenResults').innerHTML = '';
            document.getElementById('validationResults').classList.add('hidden');
            
            console.log('已清空所有数据');
        });
    }
});


</script>
</body>
</html>
